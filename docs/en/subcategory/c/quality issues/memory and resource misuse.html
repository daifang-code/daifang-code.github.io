
<!DOCTYPE html>
<html lang="en">

<head>
    <link href='../../../theme/fonts/googleapis.css' rel='stylesheet' type='text/css'>
    <link href="../../../theme/stylesheet/normalize.min.css">
    <script src="../../../theme/javascript/jquery.min.js"></script>
    <script type="text/javascript" src="../../../tipuesearch_content.js"></script>
    <link rel="stylesheet" href="../../../theme/tipuesearch/css/tipuesearch.css">
    <script type="text/javascript" src="../../../theme/tipuesearch/tipuesearch_set.js"></script>
    <script type="text/javascript" src="../../../theme/tipuesearch/tipuesearch.js"></script>

        <link rel="stylesheet" type="text/css" href="../../../theme/stylesheet/style.css">

    <link rel="stylesheet" type="text/css"
          href="../../../theme/pygments/xcode.min.css">
    <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/font-awesome.min.css">





    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>     <meta name="robots" content=""/>      <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">      <meta name="author" content="Pinpoint Team"/>
    <meta name="description" content="Manual and documents for Sourcebrella Pinpoint"/> <meta property="og:site_name" content="Pinpoint Document"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Pinpoint Document"/>
<meta property="og:description" content="Manual and documents for Sourcebrella Pinpoint"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="../../.."/>
 
    <title>Pinpoint Document &ndash; Category</title>

</head>

<body style="display: none;">

<aside>
    <div>
        <a href="../../..">
                <img src="../../../theme/img/profile.png" alt="Pinpoint Document" title="Pinpoint Document">
        </a>
        <h1><a href="../../..">Pinpoint Document</a></h1>

        <div style="padding-left: 0">
            <form action="../../../search.html" onsubmit="return validateForm(this.elements['q'].value);">
                <input id="tipue_search_input" type="text" name="q" placeholder="Input to search">
            </form>
        </div>


        <ul class="global_lang">
                    <li class="active"><a href="javascript:void(0);"
                                                                                  language-link="en">en</a>
                    </li>
                    <li><a href="javascript:void(0);"
                                                                                  language-link="zh">zh</a>
                    </li>
        </ul>

        <!--  -->

        <nav>
            <ul class="list">
                    <li>
                        <a href="../../../standard/language-independent.html">Language Independent documents</a>
                        (3)
                    </li>
                    <li>
                        <a href="../../../standard/c.html">c/c++ documents</a>
                        (317)
                    </li>
                    <li>
                        <a href="../../../standard/csharp.html">csharp documents</a>
                        (39)
                    </li>
                    <li>
                        <a href="../../../standard/golang.html">golang documents</a>
                        (34)
                    </li>
                    <li>
                        <a href="../../../standard/java.html">java documents</a>
                        (555)
                    </li>
                    <li>
                        <a href="../../../standard/javascript.html">javascript documents</a>
                        (295)
                    </li>
                    <li>
                        <a href="../../../standard/objective-c.html">objective-c documents</a>
                        (124)
                    </li>
                    <li>
                        <a href="../../../standard/python.html">python documents</a>
                        (618)
                    </li>
                    <li>
                        <a href="../../../standard/shell.html">shell documents</a>
                        (334)
                    </li>
                    <li>
                        <a href="../../../standard/swift.html">swift documents</a>
                        (26)
                    </li>

            </ul>
        </nav>

        <ul class="social">
        </ul>
    </div>


</aside>
<main>
          <article>
            <h1>
            Memory and resource misuse (40)
            </h1>
        </article>
        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="BE5162">Memory leak</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of exploit</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Memory leak</p>
<h1 id="likelihood-of-exploit">Likelihood of exploit</h1>
<p>Low</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">c</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="BE0135">Limit memory size</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of exploit</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Limit memory size</p>
<h1 id="likelihood-of-exploit">Likelihood of exploit</h1>
<p>High</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">c</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1011">Beware of zero-length allocations</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable code Example</a></li>
<li><a href="#vulnerable-code-fixed-example">Vulnerable code fixed Example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>When the requested size is 0, the behavior of the memory allocation functions malloc(), calloc(), and realloc() is implementation-defined.Subclause 7.22.3 of the C Standard [ISO/IEC 9899:2011] states:  </p>
<ul>
<li>If the size of the space requested is zero, the behavior is implementation-defined: either a null pointer is returned, or the behavior is as if the size were some nonzero value, except that the returned pointer shall not be used to access an object.</li>
</ul>
<p>In addition, the amount of storage allocated by a successful call to the allocation function when 0 bytes was requested is unspecified.</p>
<p>In cases where the memory allocation functions return a non-null pointer, reading from or writing to the allocated memory area results in undefined behavior. Typically, the pointer refers to a zero-length block of memory consisting entirely of control structures. Overwriting these control structures damages the data structures used by the memory manager.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>Allocating 0 bytes can lead to abnormal program termination.</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Beware of zero-length allocations</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>High</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// expected-warning {{Use of zero-allocated memory}}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-fixed-example">Vulnerable code fixed Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert">
<p>https://wiki.sei.cmu.edu/confluence/display/c/MEM04-C.+Beware+of+zero-length+allocations.html <a class="footnote-backref" href="#fnref-cert" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1060">Suspicious use of iterator</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
</ul>
</div>

            <div>
                <p>Summary：In the loop, the iterator incrementing boundary conditions are not checked.</p>

<h1 id="description">Description</h1>
<p>In the loop, the iterator incrementing boundary conditions are not checked.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>The undefined boundary condition of the iterator self-increment will cause the program to enter an endless loop or directly cause the program to crash.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Adding iterator check items for self-incremental boundary conditions</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>medium</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1039">Insecure command line args</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 6 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#improper-restriction-of-operations-within-the-bounds-of-a-memory-buffer">Improper Restriction of Operations within the Bounds of a Memory Buffer</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a><ul>
<li><a href="#phase-architecture-and-design">Phase: Architecture and Design</a></li>
<li><a href="#build-and-compilation">Build and Compilation</a></li>
<li><a href="#phase-implementation">Phase: Implementation</a></li>
<li><a href="#phase-operation">Phase: Operation</a></li>
<li><a href="#phase-operation_1">Phase: Operation</a></li>
<li><a href="#phase-implementation_1">Phase: Implementation</a></li>
</ul>
</li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#bad-example">bad example</a></li>
<li><a href="#good-example">good example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The length of user command line can be very long, leading to buffer overflow.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="improper-restriction-of-operations-within-the-bounds-of-a-memory-buffer">Improper Restriction of Operations within the Bounds of a Memory Buffer</h4>
<p>The software performs operations on a memory buffer, but it can read from or write to a memory location that is outside of the intended boundary of the buffer.</p>
<p>Certain languages allow direct addressing of memory locations and do not automatically ensure that these locations are valid for the memory buffer that is being referenced. This can cause read or write operations to be performed on memory locations that may be associated with other variables, data structures, or internal program data.</p>
<p>As a result, an attacker may be able to execute arbitrary code, alter the intended control flow, read sensitive information, or cause the system to crash.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>high</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<h4 id="phase-architecture-and-design">Phase: Architecture and Design</h4>
<p>Use a vetted library or framework that does not allow this weakness to occur or provides constructs that make this weakness easier to avoid.</p>
<p>Examples include the Safe C String Library (SafeStr) by Messier and Viega [REF-57], and the Strsafe.h library from Microsoft [REF-56]. These libraries provide safer versions of overflow-prone string-handling functions.</p>
<p>Note: This is not a complete solution, since many buffer overflows are not related to strings.</p>
<h4 id="build-and-compilation">Build and Compilation</h4>
<p>Run or compile the software using features or extensions that automatically provide a protection mechanism that mitigates or eliminates buffer overflows.</p>
<p>For example, certain compilers and extensions provide automatic buffer overflow detection mechanisms that are built into the compiled code. Examples include the Microsoft Visual Studio /GS flag, Fedora/Red Hat FORTIFY_SOURCE GCC flag, StackGuard, and ProPolice.</p>
<p>Note: This is not necessarily a complete solution, since these mechanisms can only detect certain types of overflows. In addition, an attack could still cause a denial of service, since the typical response is to exit the application.</p>
<h4 id="phase-implementation">Phase: Implementation</h4>
<p>Consider adhering to the following rules when allocating and managing an application's memory:</p>
<p>Double check that your buffer is as large as you specify.</p>
<p>When using functions that accept a number of bytes to copy, such as strncpy(), be aware that if the destination buffer size is equal to the source buffer size, it may not NULL-terminate the string.</p>
<p>Check buffer boundaries if accessing the buffer in a loop and make sure you are not in danger of writing past the allocated space.</p>
<p>If necessary, truncate all input strings to a reasonable length before passing them to the copy and concatenation functions.</p>
<h4 id="phase-operation">Phase: Operation</h4>
<p>Run or compile the software using features or extensions that randomly arrange the positions of a program's executable and libraries in memory. Because this makes the addresses unpredictable, it can prevent an attacker from reliably jumping to exploitable code.</p>
<p>Examples include Address Space Layout Randomization (ASLR) [REF-58] [REF-60] and Position-Independent Executables (PIE) [REF-64].</p>
<p>Note: This is not a complete solution. However, it forces the attacker to guess an unknown value that changes every program execution. In addition, an attack could still cause a denial of service, since the typical response is to exit the application.</p>
<h4 id="phase-operation_1">Phase: Operation</h4>
<p>Use a CPU and operating system that offers Data Execution Protection (NX) or its equivalent [REF-60] [REF-61].</p>
<p>Note: This is not a complete solution, since buffer overflows could be used to overwrite nearby variables to modify the software's state in dangerous ways. In addition, it cannot be used in cases in which self-modifying code is required. Finally, an attack could still cause a denial of service, since the typical response is to exit the application.</p>
<h4 id="phase-implementation_1">Phase: Implementation</h4>
<p>Replace unbounded copy functions with analogous functions that support length arguments, such as strcpy with strncpy. Create these if they are not available.
Effectiveness: Moderate</p>
<p>Note: This approach is still susceptible to calculation errors, including issues such as off-by-one errors (CWE-193) and incorrectly calculating buffer lengths (CWE-131).</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="bad-example">bad example</h3>
<p>example1</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">host_lookup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_addr</span><span class="p">){</span>
    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
    <span class="n">in_addr_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="n">in_addr_t</span> <span class="n">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>

    <span class="c1">// routine that ensures user_supplied_addr is in the </span>
    <span class="c1">// right format for conversion </span>

    <span class="n">validate_addr_form</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyaddr</span><span class="p">(</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">),</span> <span class="n">AF_INET</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>This example takes an IP address from a user, verifies that it is well formed and then looks up the hostname and copies it into a buffer.</p>
<p>This function allocates a buffer of 64 bytes to store the hostname, however there is no guarantee that the hostname will not be larger than 64 bytes. If an attacker specifies an address which resolves to a very large hostname, then we may overwrite sensitive data or even relinquish control flow to the attacker.</p>
<p>Note that this example also contains an unchecked return value (CWE-252) that can lead to a NULL pointer dereference (CWE-476).</p>
<p>example2</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span> <span class="nf">copy_input</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_string</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dst_index</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">dst_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_SIZE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">MAX_SIZE</span> <span class="o">&lt;=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">user_supplied_string</span><span class="p">)</span> <span class="p">){</span>
        <span class="n">die</span><span class="p">(</span><span class="s">"user string too long, die evil hacker!"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dst_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">user_supplied_string</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="sc">'&amp;'</span> <span class="o">==</span> <span class="n">user_supplied_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">){</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'&amp;'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'a'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'m'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'p'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">';'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sc">'&lt;'</span> <span class="o">==</span> <span class="n">user_supplied_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">){</span>
        <span class="cm">/* encode to &amp;lt; */</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_supplied_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">dst_buf</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>This example applies an encoding procedure to an input string and stores it into a buffer.</p>
<p>The programmer attempts to encode the ampersand character in the user-controlled string, however the length of the string is validated before the encoding procedure is applied. Furthermore, the programmer assumes encoding expansion will only expand a given character by a factor of 4, while the encoding of the ampersand expands by 5. As a result, when the encoding procedure expands the string it is possible to overflow the destination buffer if the attacker provides a string of many ampersands.</p>
<p>example3</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">items</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"boat"</span><span class="p">,</span> <span class="s">"car"</span><span class="p">,</span> <span class="s">"truck"</span><span class="p">,</span> <span class="s">"train"</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetUntrustedOffset</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"You selected %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>The following example asks a user for an offset into an array to select an item.</p>
<p>The programmer allows the user to specify which element in the list to select, however an attacker can provide an out-of-bounds offset, resulting in a buffer over-read (CWE-126).</p>
<p>example4</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">getValueFromArray</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="c1">// check that the array index is less than the maximum</span>
    <span class="c1">// length of the array</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// get the value at the specified index of the array</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="c1">// if array index is invalid then output error message</span>
    <span class="c1">// and return value indicating error</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Value is: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
        <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In this code, the method retrieves a value from an array at a specific array index location that is given as an input parameter to the method.</p>
<p>However, this method only verifies that the given array index is less than the maximum length of the array but does not check for the minimum value (CWE-839). This will allow a negative value to be accepted as the input array index, which will result in a out of bounds read (CWE-125) and may allow access to sensitive memory. The input array index should be checked to verify that is within the maximum and minimum range required for the array (CWE-129). In this example the if statement should be modified to include a minimum range check, as shown below.</p>
<h3 id="good-example">good example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// check that the array index is within the correct</span>
<span class="c1">// range of values for the array</span>
<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/119.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0704">Use of Uninitialized Variable</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#code-example">Code example</a></li>
<li><a href="#fixed-code-example">Fixed code example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>In some languages such as C and C++, stack variables or heap variables are not initialized by default. They generally contain junk data with the contents of stack/heap memory which may lead to unintended behaviors, even crashes. An attacker can also control or read these contents. </p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<ul>
<li>Uninitialized variables usually contain junk data, which can not be trusted and has no guarantee of value ranges or other constraints. This can lead to denial of service conditions, or modify control flow in unexpected ways. In some cases, an attacker can "pre-initialize" the variable using previous actions, which might enable code execution. This can cause a race condition if a lock variable check passes when it should not.</li>
<li>Uninitialized variable might get a value according to the execution environment which may lead to the appearance that the code runs good during testing phase but crashes in industrial run.</li>
<li>Strings that are not initialized are especially dangerous, since many functions expect a null at the end -- and only at the end -- of a string.</li>
</ul>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Critical</p>
<h1 id="potential-mitigations">Potential mitigations</h1>
<ul>
<li>Assign all variables to an initial value.</li>
</ul>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="code-example">Code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define NEXT_SZ 100</span>

<span class="kt">void</span> <span class="nf">repaint</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">used_uninitialized_variable</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctl</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>  
    <span class="n">repaint</span><span class="p">(</span><span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">);</span> <span class="c1">// @@bad@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the default case of the switch statement, the programmer has accidentally set the value of aN twice. As a result, bN will have an undefined value. Most uninitialized variable issues result in general software reliability problems, but if attackers can intentionally trigger the use of an uninitialized variable, they might be able to launch a denial of service attack by crashing the program. Under the right circumstances, an attacker may be able to control the value of an uninitialized variable by affecting the values on the stack prior to the invocation of the function.</p>
<h3 id="fixed-code-example">Fixed code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define NEXT_SZ 100</span>

<span class="kt">void</span> <span class="nf">repaint</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">used_uninitialized_variable</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctl</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>  
    <span class="n">repaint</span><span class="p">(</span><span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">);</span> <span class="c1">// @@good@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>Initialize variable bN before using it.</p>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CERT-EXP33-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/EXP33-C.+Do+not+read+uninitialized+memory <a class="footnote-backref" href="#fnref-CERT-EXP33-C" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CERT-EXP53-CPP">
<p>https://wiki.sei.cmu.edu/confluence/display/cplusplus/EXP53-CPP.+Do+not+read+uninitialized+memory <a class="footnote-backref" href="#fnref-CERT-EXP53-CPP" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CWE665">
<p>https://cwe.mitre.org/data/definitions/665.html <a class="footnote-backref" href="#fnref-CWE665" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0064">Variable Length Array Size</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#unexpected-result">unexpected result</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>When declaring a variable-length array, the array length must meet the following requirements:</p>
<ol>
<li>The length of the array cannot be negative or 0.</li>
<li>The array length must be an initialized value.</li>
<li>The length of the array cannot be a taint data.</li>
</ol>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="unexpected-result">unexpected result</h4>
<p>If the above requirements are not met while declaring a variable-length array, the array that may be applied does not match the expected, resulting in unexpected results.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Low</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>When declaring a variable-length array, the array length must meet the following requirements:</p>
<ol>
<li>The length of the array cannot be negative or 0.</li>
<li>The array length must be an initialized value.</li>
<li>The length of the array cannot be a taint data.</li>
</ol>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="c1">// expected-warning{{Declared variable-length array (VLA) has zero size}</span>
  <span class="p">}</span> 
  <span class="kt">int</span> <span class="n">vla</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, when the variable length array vla is declared, the array length x is 0.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vla</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, when the variable length array vla is declared, the array length x is not 0.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0055">Pointer Subtraction</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#_1">意料之外的结果</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>If two pointers point to the same array, they can be subtracted, resulting in the number of elements between the two pointers.
If the two pointers do not point to the same array, they are meaningless and even produce erroneous results.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="_1">意料之外的结果</h4>
<p>If the two pointers do not point to the same array, they are meaningless and even produce erroneous results.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Low</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Only do this calculation if the pointers exist in the same memory chunk.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
  <span class="c1">// expected-warning{{Subtraction of two pointers that do not point to </span>
  <span class="c1">// the same memory chunk may cause incorrect result}} </span>
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">y</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, &amp;y and &amp;x point to different memory chunk, cannot be subtracted.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">q</span><span class="o">-</span><span class="n">p</span><span class="p">;</span> <span class="c1">// no-warning</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, both q and p point to the same array a, which can be subtracted.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1021">Inappropriate Iterator</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#dangerous-operation-of-inappropriate-iterator">dangerous operation of Inappropriate iterator</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#bad-example">bad Example</a></li>
<li><a href="#good-exmaple">good Exmaple</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Iterator compared with operator&lt;. This is dangerous since the order of items in the container is not guaranteed.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h3 id="dangerous-operation-of-inappropriate-iterator">dangerous operation of Inappropriate iterator</h3>
<p>Iterator compared with operator&lt;. This is dangerous since the order of items in the container is not guaranteed.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>high</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Use operator!= instead to compare iterators</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="bad-example">bad Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">v1</span><span class="o">&lt;</span><span class="n">v2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="c1">//</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>This code displays using '&lt;' operation to compare two iterators.</p>
<h3 id="good-exmaple">good Exmaple</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">v1</span><span class="o">==</span><span class="n">v2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>This code using '==' as a operation to compare two iterators.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0701">Invalid Use of Stack Address</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#code-example">Code example</a></li>
<li><a href="#fixed-code-example-1-using-dynamically-allocated-heap-address">Fixed code example 1: Using dynamically allocated heap address</a></li>
<li><a href="#fixed-code-example-2-using-addresses-allocated-by-caller-passed-by-arguments">Fixed code example 2: Using addresses allocated by caller (passed by arguments)</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Because local variables are allocated on the stack, they are invalidated when the function returns. A subsequent function call is likely to re-use this same stack address, thereby overwriting the value of the variable, which no longer corresponds to the same variable. At best this will cause the value of the pointer to change unexpectedly. In many cases it causes the program to crash the next time the pointer is dereferenced. </p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>DoS: crash, data leak</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Critical</p>
<h1 id="potential-mitigations">Potential mitigations</h1>
<p>Use malloc() or operator new to create a heap address or allocate stack address in caller and pass the address by arguments</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="code-example">Code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">STR_MAX</span><span class="p">];</span>
  <span class="n">fillInName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-1-using-dynamically-allocated-heap-address">Fixed code example 1: Using dynamically allocated heap address</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">STR_MAX</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
  <span class="n">fillInName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-2-using-addresses-allocated-by-caller-passed-by-arguments">Fixed code example 2: Using addresses allocated by caller (passed by arguments)</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">getName</span><span class="p">(</span><span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="n">STR_MAX</span><span class="p">])</span> <span class="p">{</span>
  <span class="n">fillInName</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe562">
<p>https://cwe.mitre.org/data/definitions/562.html <a class="footnote-backref" href="#fnref-cwe562" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0056">Out Of ArrayBound</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#crash">crash</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>When a program reads data past the end, it will access memory outside the array.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="crash">crash</h4>
<p>An out of bounds array can cause crash.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>High</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Checks if the index value exceeds the length of the array before accessing the element.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the third line, the index value 4 exceeds the length of the array, causing the array to be out of bounds.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, the index value in the range of the array length is used.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0007">Bad Alloc Arithmetic</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#memory-corruption">memory corruption</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Sometimes the user write codes like <code>malloc(a)+b</code> or <code>malloc(a)-b</code>, where it appears that the user intended to call <code>malloc(a+b)</code> or <code>malloc(a-b)</code>. These errors cause under- or over-allocation and unintended pointer arithmetic, resulting in memory corruption or a potential security vulnerability when attempting to copy data into the resultant buffer.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="memory-corruption">memory corruption</h4>
<p>These errors cause under- or over-allocation and unintended pointer arithmetic, resulting in memory corruption or a potential security vulnerability when attempting to copy data into the resultant buffer.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Using malloc allocation routine in a correct way.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>  
  <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, char *p1 and char *p2 both contain allocation errors.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span> 
  <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the fixed code example, using correct way to alloc memory.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0057">Malloc Size Overflow</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#unexpected-results">unexpected results</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The computation of the size of the memory allocation may overflow.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="unexpected-results">unexpected results</h4>
<p>A length overflow during memory allocation causes the actual allocated memory length to be different than expected., which could results in unexpected results.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Low</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Detect the length of the allocation before memory allocation.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">bad</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// expected-warning {{the computation of the size of the memory </span>
  <span class="c1">// allocation  may overflow}} </span>
  <span class="k">return</span> <span class="n">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, the value of n is passed from outside the function. The result of <code>n * 4</code> may exceed the maximum value of <code>unsigned int</code>, causing an overflow. The actual allocated memory size does not match the expected value.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">good</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, the value of n is detected before n is used, thereby preventing the malloc size overflow during memory allocation.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0049">String Null</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#buffer-overflow">Buffer Overflow</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>In C and C++, a C string, or a null-terminated string, is a character sequence terminated with a null character (\0). The length of a C string is found by searching for the null character.</p>
<p>Because they are pointers to blocks of characters in memory, it is imperative that string arguments be null-terminated before functions manipulate them. When passed to functions such as strlen(), non-null terminated strings can cause looping or overflow defects.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="buffer-overflow">Buffer Overflow</h4>
<p>The null termination has historically created security problems. For example:</p>
<ol>
<li>a null character inserted into a string can truncate it unexpectedly.</li>
<li>it's a common bug not to allocate enough space for the null character or to forget the null.</li>
<li>many programs don't check the length before copying a string to a fixed-size buffer, causing a buffer overflow when it's too long.</li>
<li>the inability to store a null character means that string and binary data needs to be handled by different functions, which can cause problems if the wrong function is used.</li>
</ol>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<ol>
<li>add special code to validate null termination of string buffers if performance constraints permit.</li>
<li>switch to bounded-string manipulation functions like strncpy.</li>
<li>inspect buffer lengths involved in the buffer overrun traceback.</li>
</ol>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span><span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">extension</span><span class="p">;</span>
  <span class="c1">// read from net, no null-termination</span>
  <span class="n">string_from_net</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SOME_CHAR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">process_filename</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="c1">// process until '\0' found</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, the name string is not null-terminated and is passed to process_filename(), which searches name until it finds a null terminator. If name lacks a null-terminator process_filename() could potentially corrupt memory.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span><span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">extension</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">string_from_net</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span> 
    <span class="k">if</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">){</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SOME_CHAR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">process_filename</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="c1">// process until '\0' found</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the invulnerable code example,  null-terminate strings after reading them in from a string null source such as string_from_net() and before passing them to a string null sink such as process_filename().</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0001">NULL pointer dereference</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 3 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and Risk</a><ul>
<li><a href="#dos-crash-exit-restart">DoS / crash / exit / restart</a></li>
<li><a href="#execute-unauthorized-code-or-commands">Execute unauthorized code or commands</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example-1">Vulnerable code Example 1</a></li>
<li><a href="#fixed-code-example-1">Fixed Code Example 1</a></li>
<li><a href="#vulnerable-code-example-2">Vulnerable code Example 2</a></li>
<li><a href="#fixed-code-example-2">Fixed code example 2</a></li>
<li><a href="#vulnerable-code-example-3">Vulnerable code Example 3</a></li>
<li><a href="#fixed-code-example-3">Fixed code example 3</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>An attempt to access data using a null pointer causes a runtime error. When a program dereferences a pointer that is expected to be valid but turns out to be null, a null pointer dereference occurs. Null-pointer dereference defects often occur due to ineffective error handling or race conditions, and typically cause abnormal program termination. Before a pointer is dereferenced in C/C++ code, it must be checked to confirm that it is not equal to null.</p>
<h1 id="vulnerability-and-risk">Vulnerability and Risk</h1>
<h4 id="dos-crash-exit-restart">DoS / crash / exit / restart</h4>
<p>NULL pointer dereferences usually result in the failure of the process unless exception handling (on some platforms) is available and implemented. Even when exception handling is being used, it can still be very difficult to return the software to a safe state of operation.</p>
<h4 id="execute-unauthorized-code-or-commands">Execute unauthorized code or commands</h4>
<p>In very rare circumstances and environments, code execution is possible.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Critical</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<ul>
<li>Check for a null value in the results of all functions that return values</li>
<li>Make sure all external inputs are validated</li>
<li>Explicitly initialize variables</li>
<li>Make sure that unusual exceptions are handled correctly</li>
</ul>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example-1">Vulnerable code Example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">reassign</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">goodEnough</span><span class="p">(</span><span class="n">argument</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
  <span class="o">*</span><span class="n">argument</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">npd_check_call_must</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">reassign</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>Although *p is checked for null at line 8, it's then passed to function reassign, in which it is dereferenced without being checked for null. This type of vulnerability can produce unexpected and unintended results.</p>
<h3 id="fixed-code-example-1">Fixed Code Example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">reassign</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">goodEnough</span><span class="p">(</span><span class="n">argument</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
  <span class="o">*</span><span class="n">argument</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">npd_check_call_must</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">reassign</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the fixed version of the code, a second check for null has been put in line 11.</p>
<h3 id="vulnerable-code-example-2">Vulnerable code Example 2</h3>
<p>This example takes an IP address from a user, verifies that it is well formed and then looks up the hostname and copies it into a buffer.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">host_lookup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_addr</span><span class="p">){</span>
  <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
  <span class="n">in_addr_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">in_addr_t</span> <span class="n">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>

  <span class="c1">// routine that ensures user_supplied_addr is in the right format for conversion </span>
  <span class="n">validate_addr_form</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyaddr</span><span class="p">(</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">),</span> <span class="n">AF_INET</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>If an attacker provides an address that appears to be well-formed, but the address does not resolve to a hostname, then the call to gethostbyaddr() will return NULL. Since the code does not check the return value from gethostbyaddr, a NULL pointer dereference would then occur in the call to strcpy().</p>
<h3 id="fixed-code-example-2">Fixed code example 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">host_lookup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_addr</span><span class="p">){</span>
  <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
  <span class="n">in_addr_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">in_addr_t</span> <span class="n">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>

  <span class="c1">// routine that ensures user_supplied_addr is in the right format for conversion </span>
  <span class="n">validate_addr_form</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyaddr</span><span class="p">(</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">),</span> <span class="n">AF_INET</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">hp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">strcpy</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the fixed version of the code, another null check was added on line 11.</p>
<h3 id="vulnerable-code-example-3">Vulnerable code Example 3</h3>
<p>This java example illustrates missing check of returned value might lead to crash of a program.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">readConfigFromFile</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">FileReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">))</span> <span class="o">{</span>
      <span class="kt">char</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">config</span> <span class="o">=</span> <span class="n">readConfigFromFile</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="c1">// config might be null. If so, main exits.</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-3">Fixed code example 3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">readConfigFromFile</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">FileReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">))</span> <span class="o">{</span>
      <span class="kt">char</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">config</span> <span class="o">=</span> <span class="n">readConfigFromFile</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">config</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Can't read config from "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/476.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CERT1">
<p>https://wiki.sei.cmu.edu/confluence/display/c/EXP34-C.+Do+not+dereference+null+pointers <a class="footnote-backref" href="#fnref-CERT1" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CERT2">
<p>https://wiki.sei.cmu.edu/confluence/display/java/EXP00-J.+Do+not+ignore+values+returned+by+methods <a class="footnote-backref" href="#fnref-CERT2" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/dos.html">DoS</a>
                <a href="../../../tag/pointer.html">Pointer</a>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/csharp.html">CSHARP</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0050">Bad Pointer Arithmetic</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#out-of-bound-access">Out of bound access</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The type systems in C/C++ do not distinguish between "pointer to one object" and "pointer to array of objects". Consequently, it is easy to accidentally apply pointer arithmetic to a pointer that only points to a singleton object. </p>
<p>Typically, when pointer arithmetic is applied to a singleton pointer, the result is either reading garbage/unintended value from memory, or writing to unintended memory and corrupting it.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="out-of-bound-access">Out of bound access</h4>
<p>Typically, when pointer arithmetic is applied to a singleton pointer, the result is either reading garbage/unintended value from memory, or writing to unintended memory and corrupting it.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Apply pointer arithmetic to a pointer that only points to array of objects. </p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, <code>p</code> is a pointer that only points to a singleton object. Apply pointer arithmetic at line 4 will result a garbage value.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the invulnerable code example, <code>p</code> is a pointer that only points to array of objects.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0123">Pointer align</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
<li><a href="#reference">Reference</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The position pointed by the pointer is not the starting position of the element in the array.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>Incorrect pointer align can result in program function errors or buffer overflows.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Low</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Use pointer align correctly.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">example_fun</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="c1">//The position pointed by the pointer "p+3" is not the starting </span>
  <span class="c1">//position of the element of the integer array a</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">3</span><span class="p">));</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">example_fun</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="reference">Reference</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-hangbiao">
<p>SJ/T 11682-2017 6.7.2 <a class="footnote-backref" href="#fnref-hangbiao" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1005">Attempt to Access Child of a Non-structure Pointer</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable code Example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Casting a non-structure type to a structure type and accessing a field can lead to memory access errors or data corruption. </p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>Adjacent variables in memory may be corrupted by assignments performed on fields after the cast. </p>
<p>Execution may end due to a memory access error. </p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Review of type casting operations can identify locations where incompatible types are cast. </p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">foo</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="p">)</span><span class="n">main</span><span class="p">;</span>
  <span class="n">foo</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">foo</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/588.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/cwe-588.html">CWE-588</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1061">Write to read-only memory</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                <p>Summary：Illegal modification of string constants.</p>

<h1 id="description">Description</h1>
<p>Modify the string constants in the code. ANSIC makes it clear that modifying string constants has no effect.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>If we modify a string constant, the resulting effect is not defined.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Don't modify the string constants.</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>high</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">A</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="kt">char</span><span class="o">*</span> <span class="n">B</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="o">*</span><span class="n">A</span><span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>   <span class="c1">//detect</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>Run the above code in TC2.0, two strings are string constants, and are given the same string, according to the TC2.0 compiler optimization of string constants, B value will follow the value of A Change by changes (it may not compile or compile with a wrong result in other complier).</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">A</span><span class="p">[]</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="kt">char</span> <span class="n">B</span><span class="p">[]</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="o">*</span><span class="n">A</span><span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, both strings are dynamic strings, so the value of B will not change with the value of A</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0061">Resource Leak</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example1">Vulnerable code Example1</a></li>
<li><a href="#fixed-code-example1">Fixed Code Example1</a></li>
<li><a href="#vulnerable-code-example2">Vulnerable code Example2</a></li>
<li><a href="#fixed-code-example2">Fixed Code Example2</a></li>
<li><a href="#vulnerable-code-example3">Vulnerable code Example3</a></li>
<li><a href="#fixed-code-example3">Fixed Code Example3</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Limited resources include memory, file system storage, database connection pool entries, and CPU. If an attacker can trigger the allocation of these limited resources, but the number or size of the resources is not controlled, then the attacker could cause a denial of service that consumes all available resources. This would prevent valid users from accessing the software, and it could potentially have an impact on the surrounding environment. For example, a memory exhaustion attack against an application could slow down the application as well as its host operating system.</p>
<p>There are at least three distinct scenarios which can commonly lead to resource exhaustion:
<em> Lack of throttling for the number of allocated recources.
</em> Losing all references to a resource before reaching the shutdown stage.
* Not closing/returning resource after processing .</p>
<p>Resource exhaustion problems are often result due to an incorrect implementation of the following situations:
<em> Error conditions and other exceptional circumstances.
</em> Confusion over which part of the program is responsible for releasing the resource. </p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<ul>
<li>The most common result of resource exhaustion is denial of service. The software may slow down, crash due to unhandled errors, or lock out legitimate users. </li>
<li>In some cases it may be possible to force the software to "fail open" in the event of resource exhaustion. The state of the software -- and possibly the security functionality - may then be compromised.</li>
</ul>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>High</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Release or close the resource descriptor after its use.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example1">Vulnerable code Example1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">bad</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Resource leak</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example1">Fixed Code Example1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">good</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">){</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-example2">Vulnerable code Example2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">file_desc_leak</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">some_error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">)</span> <span class="c1">// The resource leak when if case is true.</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example2">Fixed Code Example2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">file_desc_leak</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">some_error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-example3">Vulnerable code Example3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">FileInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"test"</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, the "inputStream" is no longer used after being allocated, and the "inputStream" that is not released after the main () is executed, a resource leak occurs.</p>
<h3 id="fixed-code-example3">Fixed Code Example3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">FileInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"test"</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">inputStream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>In finally{}, the "inputStream" is closed.</p>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CERT-FIO42-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/FIO42-C.+Close+files+when+they+are+no+longer+needed <a class="footnote-backref" href="#fnref-CERT-FIO42-C" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CERT-FIO51-CPP">
<p>https://wiki.sei.cmu.edu/confluence/display/cplusplus/FIO51-CPP.+Close+files+when+they+are+no+longer+needed <a class="footnote-backref" href="#fnref-CERT-FIO51-CPP" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CWE400">
<p>https://cwe.mitre.org/data/definitions/400.html <a class="footnote-backref" href="#fnref-CWE400" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0010">Delete Void Pointer</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#undefined-behavior">undefined behavior</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>In many implementations, deleting a pointer to void is treated like calling free() in that the memory is deallocated but destructors do not run. However, even if that is the intended behavior, it is dangerous to rely on it for the following reasons:</p>
<ul>
<li>The behavior is undefined by the language standard. The implementation can technically do anything, and some compilers have optimizers that aggressively transform code that relies on undefined behavior.</li>
<li>If the allocation site is changed, for example, to allocate an array of objects, the deallocation site will silently do the wrong thing.</li>
</ul>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="undefined-behavior">undefined behavior</h4>
<p>According to the C++ standard, deleting a pointer with type void* is an undefined behavior.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Do not delete void pointer.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">delete</span> <span class="n">p</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, delete is used on a pointer of type void at line 2.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">delete</span> <span class="n">p</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the fixed code example, delete is used on a pointer of type int at line 2. </p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0044">String Overflow</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#buffer-overflow">Buffer Overflow</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>A buffer copying function where the source string is larger than the destination string will lead to String overflows.</p>
<p>String overflows are one of the premier causes of C/C++ memory corruption and security vulnerabilities. Memory corruption occurs when memory outside the bounds of a string buffer is inadvertently overwritten. Buffer overruns are common because languages such as C and C++ are inherently unsafe: their string manipulation routines do not automatically perform bounds-checking, leaving it up to the programmer to perform this task.</p>
<p>STRING_OVERFLOW analyzes calls to the following functions:</p>
<ul>
<li>strcpy, strcat</li>
<li>wcscpy, wcscat</li>
<li>StrCpy, StrCpyA, StrCpyW, StrCat, StrCatA, StrCatW</li>
<li>OemToChar, OemToCharA, OemToCharW, OemToAnsi, OemToAnsiA, OemToAnsiW</li>
<li>_mbscpy, _mbscat, _tcscat, _tcscpy</li>
<li>lstrcpy, lstrcpyA, lstrcpyW,</li>
<li>lstrcat, lstrcatA, lstrcatW</li>
</ul>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="buffer-overflow">Buffer Overflow</h4>
<p>String overflows are one of the premier causes of C/C++ memory corruption and security vulnerabilities.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>High</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Assure that the source string is not larger than the destination string int a buffer copying function. </p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">destination_buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">source_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="c1">//...</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">destination_buffer</span><span class="p">,</span> <span class="n">source_buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, for the strcpy() call, the source string is larger than the destination string.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">destination_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">source_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="c1">//...</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">destination_buffer</span><span class="p">,</span> <span class="n">source_buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the invulnerable code example, for the strcpy() call, the source string is equal to the destination string.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0054">Assignment of a Fixed Address to a Pointer</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#portability-error">portability error</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The software sets a pointer to a specific address other than NULL or 0. </p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="portability-error">portability error</h4>
<p>Using a fixed address is not portable because that address will probably not be valid in all environments or platforms.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Low</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Never set a pointer to a fixed address.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="c1">// expected-warning{{Using a fixed address is not portable because that address </span>
  <span class="c1">// will probably not be valid in all environments or platforms}}  </span>
  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="mh">0x10000</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, using a fixed address is not portable because that address will probably not be valid in all environments or platforms at line 3.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the invulnerable code example, assign <code>&amp;a</code> to pointer <code>p</code>.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1062">Incorrect use memory allocation APIs</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#mismatched-memory-management">Mismatched Memory Management</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                <p>Summary：Memory allocation and usage do not match
License: <a href="../../licenses/MITRE-LICENSE">MITRE</a></p>

<h1 id="description">Description</h1>
<p>The application tried to return memory resources to the system, but it called a release function that was incompatible with the function originally used to allocate the resource. This drawback was often described as a mismatched memory management routine. (1) Memory is allocated (automatically) on the stack, but it is destroyed using the memory management routine free(). (2) Memory is allocated explicitly using a set of memory management functions and destroyed using a different set of memory management functions. For example, memory can be allocated using c++'s malloc() instead of the new operator, and then allocated with the delete operator.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h3 id="mismatched-memory-management">Mismatched Memory Management</h3>
<p>If memory management functions do not match, problems such as code execution, memory corruption, or program crash may occur.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>The function that allocates memory and the function that releases the memory use matching ones.</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>high</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
<span class="cm">/* do some work with ptr here */</span>
   <span class="p">...</span>
   <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="c1">//detect</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>This example uses the new operator in C++ to allocate a BarObj object, but the programmer uses free() to free the memory, which may cause unexpected behavior.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
<span class="cm">/* do some work with ptr here */</span>
  <span class="p">...</span>
  <span class="n">delete</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, we just need to change the destructor of class A to a virtual function, then we can solve above problem.</p>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/762.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0072">Iterator Past End</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#undefined-behavior">undefined behavior</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>When dereferencing a container's iterator, the iterator points to the container's end() or rend() will produce undefined behavior.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="undefined-behavior">undefined behavior</h4>
<p>When dereferencing a container's iterator, the iterator points to the container's end() or rend() will produce undefined behavior.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>When the dereferenced iterator is guaranteed, the iterator points to the legal interval.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="o">*</span><span class="n">i</span><span class="p">;</span> <span class="c1">// expected-warning{{Iterator accessed past its end}}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, the reference to the iterator i point to the container end() is dereferenced.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="o">*</span><span class="n">i</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the above code, when it is guaranteed to dereference the iterator, the iterator points to the legal interval.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0029">Error Stack Use</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#software-or-system-crash">software or system crash</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The maximum number of bytes allowed for a single stack allocation. For example, one local declaration. Any specified value is promoted to a multiple of the alignment boundary. Default is 1024.</p>
<p>Specialized application domains with strict stack limitations, such as kernels and device drivers. In these domains, exceeding the stack's maximum can cause serious issues, from errant results to software or system crashes.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="software-or-system-crash">software or system crash</h4>
<p>Specialized application domains with strict stack limitations, such as kernels and device drivers. In these domains, exceeding the stack's maximum can cause serious issues, from errant results to software or system crashes.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Low</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Alloc a single stack memory within 1024 bytes.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16384</span><span class="p">];</span> <span class="c1">// Exceeds max single base use of 1024 bytes</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, 16384 bytes of stack usage, exceeds max single base use of 1024 bytes at line 2.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the fixed code example, 128 bytes of stack usage at line 2.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0030">Stream Format State Error</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#unexpected-behaviour">unexpected behaviour</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The standard C++ iostream library provides input and output functionality using streams. It includes a formatted output capability, so that data of various types can be converted to a string for output purposes.</p>
<p>For example:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
</pre></div>
</td></tr></table>
<p>by default, converts the i integer to a string of decimal digits and writes those digits to cout.</p>
<p>A common mistake when using the iostream library is to alter the formatting state but forget to restore it. When altering the formatting state of a global stream, such as cout, or a stream passed as a parameter, later users of that stream unexpectedly have their formatting operations affected by the latent state changes. This is a violation of the expected modularity of stream users.</p>
<p>You can change the formatting state of an ostream object by using methods or manipulators. STREAM_FORMAT_STATE handles the flags, setf, unsetf, precision, and fill methods, as well as all of the standard manipulators, such as std::hex.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="unexpected-behaviour">unexpected behaviour</h4>
<p>Using the iostream library to alter the formatting state but forget to restore it, will lead to an unexpected behaviour.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Low</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Using the iostream library to alter the formatting state and remember to restore it.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, use std::hex to alter the formatting state but do not restore it at line 3.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">dec</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the fixed code example, use std::hex to alter the formatting state and std::use dec to restore it at line 3.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE4017">Constructor pointer memory leaks</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Memory leak in constructor and destructor.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>It is likely to cause memory leaks when memory is allocated in constructors but not freed in corresponding destructors.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Critical</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Free the allocated memory in destructors.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">class</span> <span class="n">A</span><span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

  <span class="n">A</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">new</span> <span class="kt">char</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">A</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Memory pointed by p is likely to be leaked.</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0166">Memory allocation release mismatch</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and Risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#code-example-1">Code example 1</a></li>
<li><a href="#fixed-code-example-1">Fixed code example 1</a></li>
<li><a href="#code-example-2">Code example 2</a></li>
<li><a href="#fixed-code-example-2">Fixed code example 2</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>This weakness can be generally described as mismatching memory management routines, such as:</p>
<ul>
<li>The memory was allocated on the stack (automatically), but it was deallocated using the memory management routine free() (CWE-590), which is intended for explicitly allocated heap memory.</li>
<li>The memory was allocated explicitly using one set of memory management functions, and deallocated using a different set. For example, memory might be allocated with malloc() in C++ instead of the new operator, and then deallocated with the delete operator. </li>
</ul>
<p>When the memory management functions are mismatched, the consequences may be as severe as code execution, memory corruption, or program crash. Consequences and ease of exploit will vary depending on the implementation of the routines and the object being managed. </p>
<h1 id="vulnerability-and-risk">Vulnerability and Risk</h1>
<p>Possible consequences include memory corruption, DoS, program crash/exit/restart, and execution of unauthorized code or commands.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>High</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Use the matching memory management function</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="code-example-1">Code example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
  <span class="cm">/* do some work with ptr here */</span>

  <span class="p">...</span>

  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>This example allocates a BarObj object using the new operator in C++, however, the programmer then deallocates the object using free(), which may lead to unexpected behavior.</p>
<h3 id="fixed-code-example-1">Fixed code example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
  <span class="cm">/* do some work with ptr here */</span>

  <span class="p">...</span>

  <span class="n">delete</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>Instead, the programmer should have either created the object with one of the malloc family functions, or else deleted the object with the delete operator.</p>
<h3 id="code-example-2">Code example 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">class</span> <span class="n">A</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">};</span>
<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">foo</span><span class="p">(){</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
  <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="p">...</span>
  <span class="n">delete</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In this example, the program does not use matching functions such as malloc/free, new/delete, and new[]/delete[] to allocate/deallocate the resource.</p>
<h3 id="fixed-code-example-2">Fixed code example 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">class</span> <span class="n">A</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">};</span>
<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">foo</span><span class="p">(){</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
  <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="p">...</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>Instead, the program use the matching function to allocate/deallocate the resource.</p>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/762.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1064">Incompleted initialization</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#incorrect-calculation-of-buffer-size">Incorrect Calculation of Buffer Size</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                <p>Summary：Incorrect use of the memset, memcpy or memmove functions causes the buffer fail to be fully evaluated.</p>

<h1 id="description">Description</h1>
<p>Incorrect use of the memset, memcpy or memmove functions causes the buffer fail to be fully evaluated.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h3 id="incorrect-calculation-of-buffer-size">Incorrect Calculation of Buffer Size</h3>
<p>Incorrect use of the memset, memcpy or memmove functions causes the buffer fail to be fully evaluated.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Use the memset, memcpy, or memmove functions correctly.</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>medium</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span><span class="c1">//detect</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1010">Free stack memory allocated by alloca()</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable code Example</a></li>
<li><a href="#fixed-code-example">Fixed code example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>alloca() allocates size bytes from the program stack. The allocated space is automatically freed when the calling function exits (not when the allocation merely passes out of scope). Therefore, do not pass the pointer value returned by <code>_alloca</code> as an argument to free.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>Free stack memory allocated by alloca() will cause the program to crash.</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Do not free stack memory allocated by alloca().</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>High</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">bad</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">alloca</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>  <span class="c1">//error</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example">Fixed code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">good</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">alloca</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0053">Cast Size Error</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#buffer-overruns">buffer overruns</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The size of allocated buffer is not a multiple of the size of the containing data type. It could lead to buffer overruns.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="buffer-overruns">buffer overruns</h4>
<p>The size of allocated buffer is not a multiple of the size of the containing data type. It could lead to buffer overruns.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>Allocate buffer with size that is a multiple of the size of its containing data type.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// expected-warning{{Cast a region whose size is not a multiple of the </span>
  <span class="c1">// destination type size}} </span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> 
  <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>The size of allocated buffer is not a multiple of the size of the containing data type.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> 
  <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p><code>malloc</code> allocates buffer with size that is a multiple of the size of <code>int</code>.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1057">Incorrect creation of object</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
</ul>
</div>

            <div>
                <p>Summary：Using the malloc function to request memory for a class object is not safe</p>

<h1 id="description">Description</h1>
<p>Using the malloc function as a class object will initialize a resource incorrectly , which may leave the resource in an unexpected state when the resource is accessed or used. When the associated resource is expected to have certain attributes or values, such as a variable that determines whether the user has been authenticated, this may create a security issue.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>It may put resources in an unexpected state and may also create security problems.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>It is recommended to use new for class object to request memory.</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>high</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0006">Incorrect operation with BSTR values</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a><ul>
<li><a href="#incorrect-memory-usage">incorrect memory usage</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable Code Example</a></li>
<li><a href="#fixed-code-example">Fixed Code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Comparison operations cannot be used for BSTR values because they are meaningless in the BSTR context, and if they are not corrected, they can result in incorrect memory usage.
Because of the two different styles of construction, the COM style BSTR strings and C style strings need to be pampered. In some cases, the conversion between the two is well-compiled, but it still produces unexpected results.</p>
<p>Comparisons of BSTR expressions using relational operators &gt;, &lt;, &gt;=, and &lt;= are reported as defects.
The reason for considering this comparison as a defect is that although the BSTR variable is technically a pointer, it should normally be considered as an opaque type. Only valid comparisons are == and! =.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<h4 id="incorrect-memory-usage">incorrect memory usage</h4>
<p>Comparison operations cannot be used for BSTR values because they are meaningless in the BSTR context, and if they are not corrected, they can result in incorrect memory usage.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<p>It is best not to use BSTRs in new designs.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example">Vulnerable Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="n">BSTR</span> <span class="n">b1</span><span class="p">,</span> <span class="n">BSTR</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&gt;</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span> 
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the vulnerable code example, using '&gt;' to compare two BSTR values at line 2.</p>
<h3 id="fixed-code-example">Fixed Code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="n">BSTR</span> <span class="n">b1</span><span class="p">,</span> <span class="n">BSTR</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">b1</span> <span class="o">==</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span> 
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In the fixed code example, using '==' to compare two BSTR values at line 2.</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0066">Memory Leak</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#code-example">Code example</a></li>
<li><a href="#fixed-code-example">Fixed code example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>When a memory is allocated, developers are responsible for tracking memory allocation and releasing the memory. If there are no more pointers or references to the memory, then it can no longer be tracked and identified for release. </p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>Most memory leaks result in general software reliability problems, but if an attacker can intentionally trigger a memory leak, the attacker might be able to launch a denial of service attack (by crashing or hanging the program) or take advantage of other unexpected program behavior resulting from a low memory condition. </p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>High</p>
<h1 id="potential-mitigations">Potential mitigations</h1>
<p>Release memory after it is no longer used.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="code-example">Code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In this example, after bad method execution, point p's pointing memory has not been released, which causes memory leak.</p>
<h3 id="fixed-code-example">Fixed code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In this example, at the end of good method execution, p's pointing memory has been released.</p>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/404.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0703">Use After Free/Double free</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#code-example-1">Code example 1</a></li>
<li><a href="#fixed-code-example-1">Fixed code example 1</a></li>
<li><a href="#code-example-2">Code example 2</a></li>
<li><a href="#fixed-code-example-2">Fixed code example 2</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The use of previously-freed memory can have any number of adverse consequences, ranging from the corruption of valid data to the execution of arbitrary code, depending on the instantiation and timing of the flaw. The simplest way data corruption may occur involves the system's reuse of the freed memory. Use-after-free errors have two common and sometimes overlapping causes:</p>
<ul>
<li>Error conditions and other exceptional circumstances.</li>
<li>Confusion over which part of the program is responsible for freeing the memory. </li>
</ul>
<p>In this scenario, the memory in question is allocated to another pointer validly at some point after it has been freed. The original pointer to the freed memory is used again and points to somewhere within the new allocation. As the data is changed, it corrupts the validly used memory; this induces undefined behavior in the process.</p>
<p>If the newly allocated data chances to hold a class, in C++ for example, various function pointers may be scattered within the heap data. If one of these function pointers is overwritten with an address to valid shellcode, execution of arbitrary code can be achieved.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<ul>
<li>The use of previously freed memory may corrupt valid data, if the memory area in question has been allocated and used properly elsewhere. </li>
<li>If chunk consolidation occurs after the use of previously freed data, the process may crash when invalid data is used as chunk information. </li>
<li>If malicious data is entered before chunk consolidation can take place, it may be possible to take advantage of a write-what-where primitive to execute arbitrary code. </li>
</ul>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Critical</p>
<h1 id="potential-mitigations">Potential mitigations</h1>
<ul>
<li>Make sure the memory is no longer used before release</li>
<li>When freeing pointers, be sure to set them to NULL once they are freed. However, the utilization of multiple or complex data structures may lower the usefulness of this strategy.</li>
</ul>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="code-example-1">Code example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span> <span class="p">(</span><span class="n">SIZE</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abrt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">abrt</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">logError</span><span class="p">(</span><span class="s">"operation aborted before commit"</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span> <span class="c1">// ptr is freed by free(ptr)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-1">Fixed code example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span> <span class="p">(</span><span class="n">SIZE</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abrt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">abrt</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">logError</span><span class="p">(</span><span class="s">"operation aborted before commit"</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="code-example-2">Code example 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad2</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="c1">// double free</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-2">Fixed code example 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good2</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE415">
<p>https://cwe.mitre.org/data/definitions/415.html <a class="footnote-backref" href="#fnref-CWE415" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CWE416">
<p>https://cwe.mitre.org/data/definitions/416.html <a class="footnote-backref" href="#fnref-CWE416" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CERT-MEM30-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/MEM30-C.+Do+not+access+freed+memory <a class="footnote-backref" href="#fnref-CERT-MEM30-C" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn-CERT-MEM50-CPP">
<p>https://wiki.sei.cmu.edu/confluence/display/cplusplus/MEM50-CPP.+Do+not+access+freed+memory <a class="footnote-backref" href="#fnref-CERT-MEM50-CPP" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1002">Free of memory not on the heap</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#code-example">Code example</a></li>
<li><a href="#fixed-code-example">Fixed code example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The application calls <code>free()</code> on a pointer to memory that was not allocated using associated heap allocation functions such as <code>malloc()</code>, <code>calloc()</code>, or <code>realloc()</code>.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>When <code>free()</code> is called on an invalid pointer, the program's memory management data structures may become corrupted. This corruption can cause the program to crash or, in some circumstances, an attacker may be able to cause <code>free()</code> to operate on controllable memory locations to modify critical program variables or execute code.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Critical</p>
<h1 id="potential-mitigations">Potential mitigations</h1>
<p>Before freeing a pointer, the programmer should make sure that the pointer was previously allocated on the heap and that the memory belongs to the program. </p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="code-example">Code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">record_t</span> <span class="n">bar</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">];</span>
  <span class="cm">/* do something interesting with bar */</span>

  <span class="p">...</span>
  <span class="n">free</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>In this example, an array of <code>record_t</code> struct, <code>bar</code>, is allocated automatically on the stack as a local variable and the programmer attempts to call <code>free()</code> on the array. The consequences will vary based on the implementation of <code>free()</code>, but it will not succeed in deallocating the memory.</p>
<h3 id="fixed-code-example">Fixed code example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">record_t</span> <span class="o">*</span><span class="n">bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">MAX_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">record_t</span><span class="p">));</span>
  <span class="cm">/* do something interesting with bar */</span>

  <span class="p">...</span>
  <span class="n">free</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>Instead, if the programmer wanted to dynamically manage the memory, <code>malloc()</code> or <code>calloc()</code> should have been used.</p>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE590">
<p>https://cwe.mitre.org/data/definitions/590.html <a class="footnote-backref" href="#fnref-CWE590" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CWE761">
<p>https://cwe.mitre.org/data/definitions/761.html <a class="footnote-backref" href="#fnref-CWE761" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CERT">
<p>https://wiki.sei.cmu.edu/confluence/display/c/MEM34-C.+Only+free+memory+allocated+dynamically <a class="footnote-backref" href="#fnref-CERT" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1046">Potential deep copy needed</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#example">Example</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>Copy constructor copies pointer, leading to that the cloned object share the same field with the original object. Please check if you mean it.</p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>Instead of allocating new memory, pointers to allocated memory will be copied to the copy constructor, and resources and memory may cause conflict.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>medium</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="example">Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">String</span><span class="o">::</span><span class="n">String</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*int len = strlen(other.str_)+1;</span>
<span class="cm">    str_ = new char[len];</span>
<span class="cm">    memset(str_,0,len);</span>
<span class="cm">    strcpy(str_, other.str_);*/</span>

    <span class="n">str_</span> <span class="o">=</span> <span class="n">AllocAndCopy</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">str_</span><span class="p">);</span> <span class="c1">//This is deep copy</span>
<span class="p">}</span>
<span class="kt">char</span><span class="o">*</span> <span class="n">String</span><span class="o">::</span><span class="n">AllocAndCopy</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>there is an implementation of deep copy。</p>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-51cto">
<p>http://blog.51cto.com/liam2199/1175611 <a class="footnote-backref" href="#fnref-51cto" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1001">Buffer access out of bounds</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 4 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and risk</a></li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example-1">Vulnerable code Example 1</a></li>
<li><a href="#fixed-code-example-1">Fixed Code Example 1</a></li>
<li><a href="#vulnerable-code-example-2">Vulnerable code Example 2</a></li>
<li><a href="#fixed-code-example-2">Fixed Code Example 2</a></li>
<li><a href="#vulnerable-code-example-3">Vulnerable Code Example 3</a></li>
<li><a href="#fixed-code-example-3">Fixed Code Example 3</a></li>
<li><a href="#vulnerable-code-example-4">Vulnerable code Example 4</a></li>
<li><a href="#fixed-code-example-4">Fixed Code Example 4</a></li>
<li><a href="#vulnerable-code-example-5">Vulnerable code Example 5</a></li>
<li><a href="#fixed-code-example-5">Fixed Code Example 5</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>A buffer overflow condition exists when a program attempts to put more data in a buffer than it can hold, or when a program attempts to put data in a memory area outside of the boundaries of a buffer. The simplest type of error, and the most common cause of buffer overflows, is the "classic" case in which the program copies the buffer without restricting how much is copied. Other variants exist, but the existence of a classic overflow strongly suggests that the programmer is not considering even the most basic of security protections. </p>
<h1 id="vulnerability-and-risk">Vulnerability and risk</h1>
<p>Buffer overflows generally lead to crashes. Other attacks leading to lack of availability are possible, including putting the program into an infinite loop. Buffer overflows often can be used to execute arbitrary code, which is usually outside the scope of a program's implicit security policy. When the consequence is arbitrary code execution, this can often be used to subvert any other security service.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Critical</p>
<h1 id="potential-mitigations">Potential mitigations</h1>
<p>Maintain a high degree of correctness in code which performs buffer management. Avoid standard library functions which are not bounds checked.</p>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example-1">Vulnerable code Example 1</h3>
<p>In this noncompliant code example, the incorrect element count is used in a call to <code>wmemcpy()</code>. The <code>sizeof</code> operator returns the size expressed in bytes, but <code>wmemcpy()</code> uses an element count based on <code>wchar_t</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wchar.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Hello world"</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">wchar_t</span> <span class="n">w_str</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">"Hello world"</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="kt">wchar_t</span> <span class="n">w_buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span> <span class="cm">/* Compliant */</span>
  <span class="n">wmemcpy</span><span class="p">(</span><span class="n">w_buffer</span><span class="p">,</span> <span class="n">w_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">w_str</span><span class="p">));</span> <span class="cm">/* Noncompliant */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-1">Fixed Code Example 1</h3>
<p>When using functions that operate on pointed-to regions, programmers must always express the integer size in terms of the element count expected by the function. For example, <code>memcpy()</code> expects the element count expressed in terms of number of bytes, but <code>wmemcpy()</code> expects the element count expressed in terms of number of <code>wchar_t</code>. Instead of the <code>sizeof</code> operator, functions that return the number of elements in the string are called, which matches the expected element count for the copy functions. In the case of this compliant solution, where the argument is an array A of type T, the expression <code>sizeof(A) / sizeof(T)</code>, or equivalently <code>sizeof(A) / sizeof(*A)</code>, can be used to compute the number of elements in the array.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wchar.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Hello world"</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">wchar_t</span> <span class="n">w_str</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">"Hello world"</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="kt">wchar_t</span> <span class="n">w_buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">wmemcpy</span><span class="p">(</span><span class="n">w_buffer</span><span class="p">,</span> <span class="n">w_str</span><span class="p">,</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">w_str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> 
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-example-2">Vulnerable code Example 2</h3>
<p>This noncompliant code example assigns a value greater than the number of bytes of available memory to <code>n</code>, which is then passed to <code>memset()</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f1</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">nchars</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">nchars</span><span class="p">);</span>
  <span class="cm">/* ... */</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nchars</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="cm">/* ... */</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-2">Fixed Code Example 2</h3>
<p>This compliant solution ensures that the value of <code>n</code> is not greater than the number of bytes of the dynamic memory pointed to by the pointer <code>p</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f1</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">nchars</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">nchars</span><span class="p">);</span>
  <span class="cm">/* ...  */</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nchars</span><span class="p">;</span>
  <span class="cm">/* ...  */</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-example-3">Vulnerable Code Example 3</h3>
<p>In this non-compliant code example, the element count of the array <code>a</code> is <code>ARR_SIZE</code> elements. Because <code>memset()</code> expects a byte count, the size of the array is scaled incorrectly by <code>sizeof(long)</code> instead of <code>sizeof(int)</code>, which results in some fragment of memory being incorrectly set to 0.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">ARR_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="n">ARR_SIZE</span><span class="p">];</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="n">ARR_SIZE</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-3">Fixed Code Example 3</h3>
<p>In this compliant solution, the element count required by <code>memset()</code> is properly calculated without resorting to scaling:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">ARR_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="n">ARR_SIZE</span><span class="p">];</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-example-4">Vulnerable code Example 4</h3>
<p>In this noncompliant code example, the length of the array arr is 20, and the value of index is 40. When an array element is obtained using arr[index], the index exceeds the length of the array, causing a buffer overflow.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">testbad</span><span class="o">{</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">20</span><span class="o">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">40</span><span class="o">;</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">arr</span><span class="o">[</span><span class="n">index</span><span class="o">]);</span>  <span class="c1">// @@bad@@</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-4">Fixed Code Example 4</h3>
<p>In this compliant solution, before the array element arr[index] is obtained by index, the boundary check of index prevent a buffer overflow.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">testgood</span><span class="o">{</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">20</span><span class="o">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">40</span><span class="o">;</span>
  <span class="k">if</span><span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="o">){</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">arr</span><span class="o">[</span><span class="n">index</span><span class="o">]);</span>  <span class="c1">// @@good@@</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-example-5">Vulnerable code Example 5</h3>
<p>In this noncompliant code example, the library function fcntl can return -1 if it fails. and thus leading to the access of a buffer by a negative index, which is an invalid index.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Info</span><span class="o">*</span> <span class="nf">test</span><span class="p">(</span><span class="n">Info</span><span class="o">**</span> <span class="n">mapping</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="s">"myfile"</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// ty can be -1 given fcntl fails</span>
  <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">ty</span><span class="p">];</span> <span class="c1">// @@bad@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-code-example-5">Fixed Code Example 5</h3>
<p>In this compliant solution, before accessing the buffer, we first check the validity of the index.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Info</span><span class="o">*</span> <span class="nf">test</span><span class="p">(</span><span class="n">Info</span><span class="o">**</span> <span class="n">mapping</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="s">"myfile"</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ty</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mapping</span><span class="p">[</span><span class="n">ty</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">// @@good@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CERT-ARR38-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/ARR38-C.+Guarantee+that+library+functions+do+not+form+invalid+pointers <a class="footnote-backref" href="#fnref-CERT-ARR38-C" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CWE131">
<p>https://cwe.mitre.org/data/definitions/131.html <a class="footnote-backref" href="#fnref-CWE131" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CWE120">
<p>https://cwe.mitre.org/data/definitions/120.html <a class="footnote-backref" href="#fnref-CWE120" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn-CWE121">
<p>https://cwe.mitre.org/data/definitions/121.html <a class="footnote-backref" href="#fnref-CWE121" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
<li id="fn-CWE122">
<p>https://cwe.mitre.org/data/definitions/122.html <a class="footnote-backref" href="#fnref-CWE122" title="Jump back to footnote 5 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">Java</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">Quality issues</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">Memory and resource misuse</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0084">Use of Expired File Descriptor</h1>
                <p>
                    Posted on September 28, 2024 in <a href="../../../category/memory-and-resource-misuse.html">Memory and resource misuse</a>

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#vulnerability-and-risk">Vulnerability and Risk</a><ul>
<li><a href="#information-leak-unexpected-behavior-denial-of-service">Information leak, unexpected behavior, denial of Service</a></li>
</ul>
</li>
<li><a href="#likelihood-of-exploit">Likelihood of Exploit</a></li>
<li><a href="#potential-mitigations">Potential Mitigations</a></li>
<li><a href="#demonstrative-examples">Demonstrative Examples</a><ul>
<li><a href="#vulnerable-code-example-1">Vulnerable Code Example 1</a></li>
<li><a href="#fixed-example-1">Fixed Example 1</a></li>
<li><a href="#vulnerable-code-example-2">Vulnerable Code Example 2</a></li>
<li><a href="#fixed-example-2">Fixed Example 2</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="description">Description</h1>
<p>The program reads or writes with a file descriptor that has been closed, causing the I/O operation to fail or silently read/write a wrong file if the file descriptor is reused by the operating system to refer to another file.
The most common reason for such a mistake is a confusion about the control flow of the program and which part of the program is responsible for closing the file descriptor.</p>
<h1 id="vulnerability-and-risk">Vulnerability and Risk</h1>
<h4 id="information-leak-unexpected-behavior-denial-of-service">Information leak, unexpected behavior, denial of Service</h4>
<p>The closed file descriptor could be reassigned to a file that is critical or containing sensitive information. Therefore, reading or writing to these files could leak sensitive data, or causing unexpected system behavior. Even if the file descriptor is not reassigned, if continue to use the closed file descriptor, the program will crash. And if closing the closed file descriptor again, the program will also crash.</p>
<h1 id="likelihood-of-exploit">Likelihood of Exploit</h1>
<p>Medium</p>
<h1 id="potential-mitigations">Potential Mitigations</h1>
<ul>
<li>Do not use a closed file descriptor.</li>
</ul>
<h1 id="demonstrative-examples">Demonstrative Examples</h1>
<h3 id="vulnerable-code-example-1">Vulnerable Code Example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">use_other_file</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/etc/passwd"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"a.txt"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"1st read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>  <span class="c1">// fd is expired after this statement.</span>

    <span class="n">use_other_file</span><span class="p">();</span>

    <span class="c1">// expected content of a.txt</span>
    <span class="c1">// but /etc/passwd will read actually</span>
    <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">nread</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"2nd read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>The program intends to read text from <code>a.txt</code>, but it actually is not doing that. <code>use_other_file</code> uses the expired file descriptor to bind to the newly opened file. The same file descriptor (same value) will be pointing to <code>/etc/passwd</code> after the second <code>open</code>.</p>
<h3 id="fixed-example-1">Fixed Example 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">use_other_file</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/etc/passwd"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"a.txt"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"1st read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="n">use_other_file</span><span class="p">();</span>

    <span class="c1">// fd still refers to a.txt</span>
    <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">nread</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"2nd read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="vulnerable-code-example-2">Vulnerable Code Example 2</h3>
<p>A simple example in Java:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">Scratch</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">FileInputStream</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"a.txt"</span><span class="o">);</span>
            <span class="c1">//...</span>
            <span class="n">file</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="c1">//...</span>
            <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>  <span class="c1">// Reading a closed file</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="fixed-example-2">Fixed Example 2</h3>
<p>The above example can be simply fixed by deferring the close of the file.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">Scratch</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">FileInputStream</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"a.txt"</span><span class="o">);</span>
            <span class="c1">//...</span>
            <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>  <span class="c1">// file is still alive</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
            <span class="n">file</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/910.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

    <footer>
 <p>
  &copy; Pinpoint 2016-Present, Rights reserve
</p>

<p>
</p>     </footer>
</main>

  <script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Pinpoint Document ",
  "url" : "../../..",
  "image": "",
  "description": "Manual and documents for Sourcebrella Pinpoint"
}
</script> 
<div id="initDiv"
     style="position: fixed; z-index: 1000; background-color: white; top: 0; right: 0; bottom: 0; left: 0; "></div>
<script type="text/javascript">
    window.onload = function () {
        document.getElementsByTagName('body')[0].style.display = "block";
        document.getElementById('initDiv').style.display = 'none';

        document.querySelectorAll('.global_lang li a').forEach(elm => {
            elm.addEventListener('click', (e) => {
                var lang = e.target.getAttribute('language-link');
                var abs_url = '/' + lang + '/';
                var reg = /\/(en|zh)\//;
                var newRef;
                var location = window.location;
                if (reg.test(location.href)) {
                    newRef = location.href.replace(reg, abs_url);
                } else {
                    var match = /\/(output|docs)\//.exec(window.location.href);
                    if (match) {
                        newRef = window.location.href.replace(match[0], '/' + match[1] + abs_url)
                    } else {
                        return;
                    }
                }
                window.open(newRef, '_self')
            })
        })
    };

</script>
</body>

</html>