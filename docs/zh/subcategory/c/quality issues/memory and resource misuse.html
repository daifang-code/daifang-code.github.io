
<!DOCTYPE html>
<html lang="zh">

<head>
    <link href='../../../theme/fonts/googleapis.css' rel='stylesheet' type='text/css'>
    <link href="../../../theme/stylesheet/normalize.min.css">
    <script src="../../../theme/javascript/jquery.min.js"></script>
    <script type="text/javascript" src="../../../tipuesearch_content.js"></script>
    <link rel="stylesheet" href="../../../theme/tipuesearch/css/tipuesearch.css">
    <script type="text/javascript" src="../../../theme/tipuesearch/tipuesearch_set.js"></script>
    <script type="text/javascript" src="../../../theme/tipuesearch/tipuesearch.js"></script>

        <link rel="stylesheet" type="text/css" href="../../../theme/stylesheet/style.css">

    <link rel="stylesheet" type="text/css"
          href="../../../theme/pygments/xcode.min.css">
    <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/font-awesome.min.css">





    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>     <meta name="robots" content=""/>      <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">      <meta name="author" content="Pinpoint Team"/>
    <meta name="description" content="Manual and documents for Sourcebrella Pinpoint"/> <meta property="og:site_name" content="Pinpoint Document"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Pinpoint Document"/>
<meta property="og:description" content="Manual and documents for Sourcebrella Pinpoint"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="../../.."/>
 
    <title>Pinpoint Document &ndash; Category</title>

</head>

<body style="display: none;">

<aside>
    <div>
        <a href="../../..">
                <img src="../../../theme/img/profile.png" alt="Pinpoint Document" title="Pinpoint Document">
        </a>
        <h1><a href="../../..">Pinpoint Document</a></h1>

        <div style="padding-left: 0">
            <form action="../../../search.html" onsubmit="return validateForm(this.elements['q'].value);">
                <input id="tipue_search_input" type="text" name="q" placeholder="输入以搜索">
            </form>
        </div>


        <ul class="global_lang">
                    <li><a href="javascript:void(0);"
                                                                                  language-link="en">en</a>
                    </li>
                    <li class="active"><a href="javascript:void(0);"
                                                                                  language-link="zh">zh</a>
                    </li>
        </ul>

        <!--  -->

        <nav>
            <ul class="list">
                    <li>
                        <a href="../../../standard/language-independent.html">Language Independent 缺陷文档</a>
                        (3)
                    </li>
                    <li>
                        <a href="../../../standard/c.html">c/c++ 缺陷文档</a>
                        (316)
                    </li>
                    <li>
                        <a href="../../../standard/csharp.html">csharp 缺陷文档</a>
                        (39)
                    </li>
                    <li>
                        <a href="../../../standard/golang.html">golang 缺陷文档</a>
                        (34)
                    </li>
                    <li>
                        <a href="../../../standard/java.html">java 缺陷文档</a>
                        (555)
                    </li>
                    <li>
                        <a href="../../../standard/javascript.html">javascript 缺陷文档</a>
                        (295)
                    </li>
                    <li>
                        <a href="../../../standard/objective-c.html">objective-c 缺陷文档</a>
                        (124)
                    </li>
                    <li>
                        <a href="../../../standard/php.html">php 缺陷文档</a>
                        (58)
                    </li>
                    <li>
                        <a href="../../../standard/python.html">python 缺陷文档</a>
                        (618)
                    </li>
                    <li>
                        <a href="../../../standard/swift.html">swift 缺陷文档</a>
                        (26)
                    </li>

            </ul>
        </nav>

        <ul class="social">
        </ul>
    </div>


</aside>
<main>
          <article>
            <h1>
            内存和资源误用 (40)
            </h1>
        </article>
        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="BE5162">内存泄漏</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞利用威胁</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>内存泄漏</p>
<h1 id="_2">漏洞利用威胁</h1>
<p>建议改进</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">c</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="BE0135">申请的内存大于给定的阀值</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞利用威胁</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>申请的内存大于给定的阀值</p>
<h1 id="_2">漏洞利用威胁</h1>
<p>严重</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">c</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1011">谨防零长度分配内存</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#_6">漏洞缺陷示例</a></li>
<li><a href="#_7">漏洞缺陷修复示例</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>当请求分配内存的大小为0时，内存分配函数malloc()，calloc()和realloc()的行为是不可控的。C标准[ISO/IEC 9899：2011]的条款7.22.3规定：</p>
<ul>
<li>如果请求的空间大小为零，则行为是由编译器实现定义的：或者返回空指针，或者返回的指针不能用于访问。</li>
</ul>
<p>当内存分配函数返回非空指针的情况下，读取或写入分配的内存区域会导致未定义的行为。</p>
<h1 id="_2">漏洞与风险</h1>
<p>读取或写入分配0字节长度的内存可能会导致程序异常终止。</p>
<h1 id="_3">缓解与预防</h1>
<p>谨防零长度分配内存。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_5">演示示例</h1>
<h3 id="_6">漏洞缺陷示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// expected-warning {{Use of zero-allocated memory}}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞缺陷修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert">
<p>https://wiki.sei.cmu.edu/confluence/display/c/MEM04-C.+Beware+of+zero-length+allocations.html <a class="footnote-backref" href="#fnref-cert" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0054">将固定地址赋值给指针变量</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">移植性问题</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>在代码中将一个固定地址(非NULL和0)赋值给一个指针变量。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">移植性问题</h4>
<p>在代码中将一个固定地址(非NULL和0)赋值给一个指针变量，在不同的平台下同一个地址可能是一个非法地址。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>低</p>
<h1 id="_5">缓解与预防</h1>
<p>不要给一个指针变量赋除NULL或0之外的固定地址。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="c1">// expected-warning{{Using a fixed address is not portable because that address</span>
  <span class="c1">// will probably not be valid in all environments or platforms}} </span>
  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="mh">0x10000</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，将固定地址0x10000赋值给指针变量p。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，将变量a的地址赋值给指针变量p。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0049">字符串缺少终止符</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">越界访问内存</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>在C和C++语言中，字符串通常以'\0'结尾。求解字符串的长度时，通常是从字符串起始位置统计字符个数直到找到'\0'。
很多以字符串作为参数的函数，都会要求该字符串带有null终结符。传入不带有null终结符的字符序列作为参数给该类函数，会导致对该对象外的内存的访问。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">越界访问内存</h4>
<p>很多以字符串作为参数的函数，都会要求该字符串带有null终结符。传入不带有null终结符的字符序列作为参数给该类函数，会导致对该对象外的内存的访问。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">缓解与预防</h1>
<p>在使用字符串之前，保证字符串以'\0'结尾。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span><span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">extension</span><span class="p">;</span>
  <span class="c1">// read from net, no null-termination</span>
  <span class="n">string_from_net</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SOME_CHAR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">process_filename</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="c1">// process until '\0' found</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在第6行使用字符串name时，并没有验证其以'\0'结尾。如果字符串name不是以'\0'结尾，可以导致process_filename()越界访问内存。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span><span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">extension</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">string_from_net</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span> 
    <span class="k">if</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">){</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SOME_CHAR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">extension</span> <span class="o">=</span> <span class="n">process_filename</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="c1">// process until '\0' found</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在使用字符串name之前，验证了它是以'\0'结尾。保证process_filename()不会越界访问内存。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1039">数组越界</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">在存储器缓冲区范围内的不当操作限制</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a><ul>
<li><a href="#_6">阶段：架构和设计</a></li>
<li><a href="#_7">阶段：构建和编译</a></li>
<li><a href="#_8">阶段：实施</a></li>
<li><a href="#_9">阶段：操作</a></li>
<li><a href="#_10">阶段：操作</a></li>
<li><a href="#_11">阶段：实施</a></li>
</ul>
</li>
<li><a href="#_12">演示实例</a><ul>
<li><a href="#_13">漏洞代码示例</a></li>
<li><a href="#_14">正确代码示例</a></li>
</ul>
</li>
<li><a href="#_15">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>用户命令行输入可能很长，导致数组越界。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">在存储器缓冲区范围内的不当操作限制</h4>
<p>该软件在内存缓冲区上执行操作，但它可以读取或写入缓冲区预期边界之外的内存位置。
某些语言允许直接寻址内存位置，并且不会自动确保这些位置对于正在引用的内存缓冲区有效。这可能导致对可能与其他变量，数据结构或内部程序数据相关联的内存位置执行读取或写入操作。
因此，攻击者可能能够执行任意代码，改变预期的控制流程，读取敏感信息或导致系统崩溃。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_5">缓解与预防</h1>
<h4 id="_6">阶段：架构和设计</h4>
<p>使用经过审查的库或框架，不允许发生这种弱点或提供使这种弱点更容易避免的构造。
包括Messier和Viega的安全C字符串库（SafeStr）[REF-57]和Microsoft的Strsafe.h库[REF-56]。这些库提供了更安全的溢出倾向字符串处理函数版本。
注意：这不是一个完整的解决方案，因为许多缓冲区溢出与字符串无关。</p>
<h4 id="_7">阶段：构建和编译</h4>
<p>使用自动提供缓解或消除缓冲区溢出的保护机制的功能或扩展来运行或编译软件。
例如，某些编译器和扩展提供了内置于编译代码中的自动缓冲区溢出检测机制。示例包括Microsoft Visual Studio / GS标志，Fedora / Red Hat FORTIFY_SOURCE GCC标志，StackGuard和ProPolice。
注意：这不一定是一个完整的解决方案，因为这些机制只能检测某些类型的溢出。另外，攻击仍可能导致拒绝服务，因为典型的响应是退出应用程序。</p>
<h4 id="_8">阶段：实施</h4>
<p>分配和管理应用程序内存时，请考虑遵守以下规则：
仔细检查您的缓冲区是否与您指定的一样大。
使用接受许多字节进行复制的函数(如strncpy())时，请注意，如果目标缓冲区大小等于源缓冲区大小，则可能不会以NULL结束字符串。
如果访问循环中的缓冲区，请检查缓冲区边界，并确保您没有写入已分配空间的危险。
如果需要，在将所有输入字符串传递给复制和串联函数之前，将其截断为合理的长度。</p>
<h4 id="_9">阶段：操作</h4>
<p>使用随机排列程序可执行程序和库的位置的功能或扩展来运行或编译软件。因为这会使地址不可预知，所以它可以防止攻击者可靠地跳转到可利用的代码。
例如包括地址空间布局随机化（ASLR）[REF-58] [REF-60]和位置无关可执行文件（PIE）[REF-64]。
注意：这不是一个完整的解决方案。但是，它会迫使攻击者猜测一个未知值，这会改变每个程序的执行。另外，攻击仍可能导致拒绝服务，因为典型的响应是退出应用程序。</p>
<h4 id="_10">阶段：操作</h4>
<p>使用提供数据执行保护（NX）或其同等功能[REF-60] [REF-61]的CPU和操作系统。
注意：这不是一个完整的解决方案，因为缓冲区溢出可以用来覆盖附近的变量以危险的方式修改软件的状态。另外，它不能用于需要自修改代码的情况。最后，攻击仍然会导致拒绝服务，因为典型的响应是退出应用程序。</p>
<h4 id="_11">阶段：实施</h4>
<p>将无界复制函数替换为支持长度参数的类似函数，如strcpy和strncpy。如果它们不可用，则创建它们。
注意：这种方法仍然容易受到计算错误的影响，包括诸如错误的错误（CWE-193）和错误地计算缓冲区长度（CWE-131）等问题。</p>
<h1 id="_12">演示实例</h1>
<h3 id="_13">漏洞代码示例</h3>
<p>example1</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">host_lookup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_addr</span><span class="p">){</span>
    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
    <span class="n">in_addr_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="n">in_addr_t</span> <span class="n">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>

    <span class="c1">// routine that ensures user_supplied_addr is in the </span>
    <span class="c1">// right format for conversion </span>

    <span class="n">validate_addr_form</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
    <span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyaddr</span><span class="p">(</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">),</span> <span class="n">AF_INET</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>此示例从用户处获取IP地址，验证其是否格式正确，然后查找主机名并将其复制到缓冲区中。
此函数分配一个64字节的缓冲区来存储主机名，但不能保证主机名不会大于64字节。如果攻击者指定了一个解析为非常大的主机名的地址，那么我们可能会覆盖敏感数据，甚至放弃对攻击者的控制流。</p>
<p>example2</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span> <span class="nf">copy_input</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_string</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dst_index</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">dst_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_SIZE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">MAX_SIZE</span> <span class="o">&lt;=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">user_supplied_string</span><span class="p">)</span> <span class="p">){</span>
        <span class="n">die</span><span class="p">(</span><span class="s">"user string too long, die evil hacker!"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dst_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">user_supplied_string</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">){</span>
        <span class="k">if</span><span class="p">(</span> <span class="sc">'&amp;'</span> <span class="o">==</span> <span class="n">user_supplied_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">){</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'&amp;'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'a'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'m'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'p'</span><span class="p">;</span>
            <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">';'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sc">'&lt;'</span> <span class="o">==</span> <span class="n">user_supplied_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">){</span>
        <span class="cm">/* encode to &amp;lt; */</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="n">dst_buf</span><span class="p">[</span><span class="n">dst_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_supplied_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">dst_buf</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>此示例将编码过程应用于输入字符串并将其存储到缓冲区中。程序员尝试将用户控制字符串中的和字符编码，但是在应用编码过程之前验证字符串的长度。此外，程序员认为编码扩展将只扩展一个给定的字符4倍，而&amp;的编码扩展5倍。结果，当编码过程扩展字符串时，如果攻击者提供了许多＆符串,可能会溢出目标缓冲区。</p>
<p>example3</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">items</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"boat"</span><span class="p">,</span> <span class="s">"car"</span><span class="p">,</span> <span class="s">"truck"</span><span class="p">,</span> <span class="s">"train"</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">GetUntrustedOffset</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"You selected %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>此示例向用户询问数组中的偏移量以选择项目。程序员允许用户指定列表中要选择的元素，但是攻击者可以提供超出范围的偏移量，从而导致缓冲区溢出（CWE-126）。</p>
<p>example4</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">getValueFromArray</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="c1">// check that the array index is less than the maximum</span>
    <span class="c1">// length of the array</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// get the value at the specified index of the array</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="c1">// if array index is invalid then output error message</span>
    <span class="c1">// and return value indicating error</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Value is: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
        <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在以上代码中，方法从特定数组索引位置的数组中检索一个值，该值为方法的输入参数。
但是，此方法仅验证给定的数组索引是否小于数组的最大长度，但不检查最小值（CWE-839）。这将允许一个负值被接受为输入数组索引，这将导致超出边界的读取（CWE-125）并且可能允许访问敏感内存。应检查输入数组索引以验证是否在数组所需的最大和最小范围内（CWE-129）。在这个例子中，if语句应该修改为包含最小范围检查，如下所示。</p>
<h3 id="_14">正确代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// check that the array index is within the correct</span>
<span class="c1">// range of values for the array</span>
<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_15">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/119.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0084">使用已关闭的文件描述符</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">不可预测行为、信息泄漏、拒绝服务</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#1">漏洞代码示例 1</a></li>
<li><a href="#1_1">漏洞代码修复示例 1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
<li><a href="#2_1">漏洞代码修复示例 2</a></li>
</ul>
</li>
<li><a href="#_7">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>程序读或写一个已经关闭的文件描述符，导致I/O操作失败，或者在文件描述符被操作系统重用的情形，导致读写了错误的文件。 此类错误最常见的原因是因为程序员错误理解了程序的控制流，或是错误理解了哪一部分程序该释放文件描述符。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">不可预测行为、信息泄漏、拒绝服务</h4>
<p>被重用的文件描述符可能指向一些包含敏感信息的文件，或者一些关键的系统文件。错误地读写这些文件可能引起机密信息泄漏或不可预测的系统行为。即使文件描述符没有被再次分配，如果继续使用已关闭的文件描述符，会导致程序崩溃。或再次关闭已经关闭的文件描述符，则程序也会崩溃。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中等</p>
<h1 id="_5">缓解与预防</h1>
<ul>
<li>不要使用已被关闭的文件描述符</li>
</ul>
<h1 id="_6">演示实例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">use_other_file</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/etc/passwd"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"a.txt"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"1st read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>  <span class="c1">// fd is expired after this statement.</span>

    <span class="n">use_other_file</span><span class="p">();</span>

    <span class="c1">// expected content of a.txt</span>
    <span class="c1">// but /etc/passwd will read actually</span>
    <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">nread</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"2nd read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="1_1">漏洞代码修复示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">use_other_file</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/etc/passwd"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"a.txt"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"1st read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="n">use_other_file</span><span class="p">();</span>

    <span class="c1">// fd still refers to a.txt</span>
    <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">nread</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"2nd read, content of a.txt </span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>上面的程序期望读取 <code>a.txt</code> 的内容。但中途把文件描述符关闭后，<code>use_other_file</code> 重用了文件描述符并指向 <code>/etc/passwd</code> 文件。继续使用同一个 fd 变量将会操作 <code>/etc/passwd</code> 而并不是期望的 <code>a.txt</code>。</p>
<h3 id="2">漏洞代码示例 2</h3>
<p>一个简单的Java的例子：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">Scratch</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">FileInputStream</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"a.txt"</span><span class="o">);</span>
            <span class="c1">//...</span>
            <span class="n">file</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="c1">//...</span>
            <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>  <span class="c1">// Reading a closed file</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="2_1">漏洞代码修复示例 2</h3>
<p>简单地延后关闭文件的时间即可修复上面程序中的错误：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">Scratch</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">FileInputStream</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"a.txt"</span><span class="o">);</span>
            <span class="c1">//...</span>
            <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>  <span class="c1">// file is still alive</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
            <span class="n">file</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_7">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/910.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0053">内存分配大小不是存储类型的整数倍</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">越界访问内存</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>使用malloc函数申请的内存大小不是存储类型大小的整数倍，可能会导致越界访问内存。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">越界访问内存</h4>
<p>使用malloc函数申请的内存大小不是存储类型大小的整数倍，可能会导致越界访问内存。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">缓解与预防</h1>
<p>使用malloc函数申请的内存大小必须为存储类型大小的整数倍。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// expected-warning{{Cast a region whose size is not a multiple of the </span>
  <span class="c1">// destination type size}}</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> 
  <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，使用malloc函数申请的内存大小不是存储类型大小的整数倍，可能会导致越界访问内存。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> 
  <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，使用malloc函数申请的内存大小是存储类型大小的整数倍。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1001">缓冲区溢出</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">漏洞代码示例 1</a></li>
<li><a href="#1_1">漏洞代码修复示例 1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
<li><a href="#2_1">漏洞代码修复示例 2</a></li>
<li><a href="#3">漏洞代码示例 3</a></li>
<li><a href="#3_1">漏洞代码修复示例 3</a></li>
<li><a href="#4">漏洞代码示例 4</a></li>
<li><a href="#4_1">漏洞代码修复示例 4</a></li>
<li><a href="#5">漏洞代码示例 5</a></li>
<li><a href="#5_1">漏洞代码修复示例 5</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>当程序尝试将超过缓冲区容量大小的数据放入缓冲区时，或者程序尝试将数据放入缓冲区边界之外的存储区时，存在缓冲区溢出情况。 最简单的错误类型和缓冲区溢出的最常见原因是程序复制缓冲区而不限制复制数量的情况。其他变体也存在，但此类最简单的溢出强烈表明程序员并未考虑最基本的安全保护。</p>
<h1 id="_2">漏洞与风险</h1>
<p>缓冲区溢出一般导致程序崩溃，或是让程序进入不可用的状态，比如无限循环。缓冲区溢出常常可以被利用来执行程序的安全策略之外的任意代码，从而导致程序的所有安全保证都失效。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_4">缓解与预防</h1>
<p>在代码中保持对缓冲区管理的高度正确性。避免使用不进行边界检查的库函数。</p>
<h1 id="_5">演示实例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<p>在这个漏洞代码示例中，不正确的元素计数用于调用<code>wmemcpy()</code>。<code>sizeof</code>运算符返回以字节表示的大小，但<code>wmemcpy()</code>使用基于<code>wchar_t</code>的元素计数。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wchar.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Hello world"</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">wchar_t</span> <span class="n">w_str</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">"Hello world"</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="kt">wchar_t</span> <span class="n">w_buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span> <span class="cm">/* Compliant */</span>
  <span class="n">wmemcpy</span><span class="p">(</span><span class="n">w_buffer</span><span class="p">,</span> <span class="n">w_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">w_str</span><span class="p">));</span> <span class="cm">/* Noncompliant */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="1_1">漏洞代码修复示例 1</h3>
<p>当使用对指向区域进行操作的函数时，程序员必须始终用函数期望的元素数来表示整数大小。例如，<code>memcpy()</code>需要用字节表示的元素数，但<code>wmemcpy()</code>需要用<code>wchar_t</code>的个数表示的元素数。调用返回字符串中元素数量的函数，而不是<code>sizeof</code>运算符，该函数会调用与复制函数的预期元素数量相匹配的函数。 在这个漏洞代码修复示例中，对于元素是类型<code>T</code>的数组<code>A</code>，也可以使用表达式<code>sizeof(A)/ sizeof(T)</code>或等效<code>sizeof(A)/ sizeof(*A)</code>来计算数组中的元素数量。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;wchar.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Hello world"</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">wchar_t</span> <span class="n">w_str</span><span class="p">[]</span> <span class="o">=</span> <span class="sa">L</span><span class="s">"Hello world"</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="kt">wchar_t</span> <span class="n">w_buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">wmemcpy</span><span class="p">(</span><span class="n">w_buffer</span><span class="p">,</span> <span class="n">w_str</span><span class="p">,</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">w_str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> 
</pre></div>
</td></tr></table>
<h3 id="2">漏洞代码示例 2</h3>
<p>这个漏洞代码示例将大于可用内存字节数的值赋给<code>n</code>，然后将其传递给<code>memset()</code>：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f1</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">nchars</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">nchars</span><span class="p">);</span>
  <span class="cm">/* ... */</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nchars</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="cm">/* ... */</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="2_1">漏洞代码修复示例 2</h3>
<p>该漏洞代码修复示例中确保<code>n</code>的值不大于指针<code>p</code>指向的动态内存的字节数：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f1</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">nchars</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">nchars</span><span class="p">);</span>
  <span class="cm">/* ...  */</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nchars</span><span class="p">;</span>
  <span class="cm">/* ...  */</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="3">漏洞代码示例 3</h3>
<p>在这个漏洞代码示例中，数组<code>a</code>的元素数是<code>ARR_SIZE</code>元素。 由于<code>memset()</code>需要一个字节数，因此<code>sizeof(int)</code>而不是<code>sizeof(long)</code>会错误地缩放数组的大小，这可能会在<code>sizeof(int) != sizeof(long)</code>的体系结构上导致某部分内存被不正确地写为0。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">ARR_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">a</span><span class="p">[</span><span class="n">ARR_SIZE</span><span class="p">];</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">ARR_SIZE</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="3_1">漏洞代码修复示例 3</h3>
<p>在这个漏洞代码修复示例中，<code>memset()</code>所需的元素数量可以正确计算而不需要进行缩放：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">f2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">ARR_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">a</span><span class="p">[</span><span class="n">ARR_SIZE</span><span class="p">];</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="4">漏洞代码示例 4</h3>
<p>在这个漏洞代码示例中，数组arr的长度是20，index的值为40，当使用arr[index]获取数组元素时，index超出了数组的长度，导致缓冲区溢出。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">testbad</span><span class="o">{</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">20</span><span class="o">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">40</span><span class="o">;</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">arr</span><span class="o">[</span><span class="n">index</span><span class="o">]);</span>  <span class="c1">// @@bad@@</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="4_1">漏洞代码修复示例 4</h3>
<p>在这个漏洞代码修复示例中，在通过index获取数组元素arr[index]之前，对index进行边界检查，不会导致缓冲区溢出。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">testgood</span><span class="o">{</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">20</span><span class="o">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">40</span><span class="o">;</span>
  <span class="k">if</span><span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="o">){</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">arr</span><span class="o">[</span><span class="n">index</span><span class="o">]);</span>  <span class="c1">// @@good@@</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="5">漏洞代码示例 5</h3>
<p>在这个漏洞代码示例中，库函数fcntl在运行失败的时候会返回-1，导致后边访问mapping数组时访问了负数索引，导致溢出行为</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Info</span><span class="o">*</span> <span class="nf">test</span><span class="p">(</span><span class="n">Info</span><span class="o">**</span> <span class="n">mapping</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="s">"myfile"</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// ty can be -1 given fcntl fails</span>
  <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">ty</span><span class="p">];</span> <span class="c1">// @@bad@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="5_1">漏洞代码修复示例 5</h3>
<p>在这个漏洞代码修复示例中，在访问数组前先检查索引是否有效即可</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Info</span><span class="o">*</span> <span class="nf">test</span><span class="p">(</span><span class="n">Info</span><span class="o">**</span> <span class="n">mapping</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="s">"myfile"</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ty</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">mapping</span><span class="p">[</span><span class="n">ty</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">// @@good@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CERT-ARR38-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/ARR38-C.+Guarantee+that+library+functions+do+not+form+invalid+pointers <a class="footnote-backref" href="#fnref-CERT-ARR38-C" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CWE131">
<p>https://cwe.mitre.org/data/definitions/131.html <a class="footnote-backref" href="#fnref-CWE131" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CWE120">
<p>https://cwe.mitre.org/data/definitions/120.html <a class="footnote-backref" href="#fnref-CWE120" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn-CWE121">
<p>https://cwe.mitre.org/data/definitions/121.html <a class="footnote-backref" href="#fnref-CWE121" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
<li id="fn-CWE122">
<p>https://cwe.mitre.org/data/definitions/122.html <a class="footnote-backref" href="#fnref-CWE122" title="Jump back to footnote 5 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">Java</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0066">内存泄漏</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">漏洞代码示例 1</a></li>
<li><a href="#1_1">漏洞代码修复示例 1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
<li><a href="#2_1">漏洞代码修复示例 2</a></li>
<li><a href="#3">漏洞代码示例 3</a></li>
<li><a href="#3_1">漏洞代码修复示例 3</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>分配内存后，开发人员负责跟踪内存分配并释放内存。如果没有更多的指向内存的指针或引用，则无法再对其进行跟踪、标识并释放。</p>
<h1 id="_2">漏洞与风险</h1>
<p>大多数内存泄漏一般会导致软件可靠性问题，但如果攻击者可以有意触发内存泄漏，则能够发起拒绝服务攻击（通过使程序崩溃或挂起）或利用其他导致程序异常的行为，比如内存不足的情况。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_4">缓解与预防</h1>
<p>释放不再被使用的内存。</p>
<h1 id="_5">演示实例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在函数bad退出时，没有释放指针p所指向的内存，导致内存泄漏。</p>
<h3 id="1_1">漏洞代码修复示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在函数good退出时，释放指针p所指向的内存。</p>
<h3 id="2">漏洞代码示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">Unsafe</span> <span class="nf">getUnsafe</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"theUnsafe"</span><span class="o">);</span>
          <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">getUnsafe</span><span class="o">();</span>
      <span class="kt">long</span> <span class="n">address</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">allocateMemory</span><span class="o">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">);</span>
      <span class="c1">// do something but not free</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，通过Unsafe包申请了不会被jvm自动回收的内存，没有手动释放，导致内存泄漏。</p>
<h3 id="2_1">漏洞代码修复示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">Unsafe</span> <span class="nf">getUnsafe</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"theUnsafe"</span><span class="o">);</span>
          <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">getUnsafe</span><span class="o">();</span>
      <span class="kt">long</span> <span class="n">address</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">allocateMemory</span><span class="o">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">);</span>
      <span class="n">unsafe</span><span class="o">.</span><span class="na">freeMemory</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，通过Unsafe包申请了不会被jvm自动回收的内存，使用后手动释放，避免内存泄漏。</p>
<h3 id="3">漏洞代码示例 3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span><span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span>
      <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"content"</span><span class="o">);</span>
      <span class="c1">// do something, then threadLocal is not needed and intend to free it</span>
      <span class="n">threadLocal</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，调用了ThreadLocal保存线程变量，使用完毕后给予其变量为null，但是当前线程的ThreadLocalMap还是会引用其堆的变量，ThreadLocal没有主动取消引用，导致内存泄漏。</p>
<h3 id="3_1">漏洞代码修复示例 3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span><span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span>
      <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"content"</span><span class="o">);</span>
      <span class="c1">// do something, then threadLocal is not needed and intend to free it</span>
      <span class="n">threadLocal</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
      <span class="n">threadLocal</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，通过remove函数让ThreadLocalMap与堆内存中的ThreadLocal断开引用，避免内存泄漏。</p>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/404.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0057">内存分配时长度溢出</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">意料之外的结果</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>在内存分配时，如果不检测分配的长度是否溢出，就会导致实际分配的内存长度与预期不符，导致意料之外的结果。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">意料之外的结果</h4>
<p>在内存分配时长度溢出，会导致实际分配的内存长度与预期不符，导致意料之外的结果。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>低</p>
<h1 id="_5">缓解与预防</h1>
<p>在内存分配之前，对分配的长度进行检测。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">bad</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// expected-warning {{the computation of the size of the memory allocation </span>
  <span class="c1">// may overflow}} </span>
  <span class="k">return</span> <span class="n">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>  

<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，n的值是从函数外部传入的，<code>n * 4</code> 的结果可能会超出<code>unsigned int</code>的最大值，导致溢出，实际分配的内存大小与预期值不符。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">good</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在使用n之前，对n的值进行了检测，从而防止内存分配时长度溢出的问题。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1061">修改字符串常量</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#_6">漏洞缺陷示例</a></li>
<li><a href="#_7">漏洞缺陷修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>在代码中修改字符串常量。ANSIC明确说明：修改字符串常量，效果是未定义的。</p>
<h1 id="_2">漏洞与风险</h1>
<p>如果修改字符串常量，最终得到的效果是没有被定义的。</p>
<h1 id="_3">缓解与预防</h1>
<p>不要进行字符串常量的修改</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_5">演示示例</h1>
<h3 id="_6">漏洞缺陷示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">A</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="kt">char</span><span class="o">*</span> <span class="n">B</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="o">*</span><span class="n">A</span><span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>   <span class="c1">//detect</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在TC2.0中运行上面的代码，两个字符串为字符串常量，而且被赋予相同的字符串，根据TC2.0编译器对字符串常量的优化，B的值将会随着A的值的改变而变化（在其他编译器中可能无法通过编译或通过编译而结果是垃圾值）。</p>
<h3 id="_7">漏洞缺陷修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">A</span><span class="p">[]</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="kt">char</span> <span class="n">B</span><span class="p">[]</span><span class="o">=</span><span class="s">"Hello,world!"</span><span class="p">;</span>   
  <span class="o">*</span><span class="n">A</span><span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面代码中，两个字符串均为动态字符串，因此B的值将不会随着A的值的改变而变化</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0006">不正确地使用BSTR类型的值</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">内存的误用</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>由于COM中的BSTR类型和C风格的字符串类型（指向'\0'结尾的字符数组的指针）是两种结构不同的数据类型，将这两种类型进行相互转换、误用，虽然在某些情况下，能够通过编译，但在实际运行中，会造成未知结果，甚至造成内存的误用。
和C风格的字符串不同，BSTR字符串带有一个4 byte长度的前置，用于记录字符串的长度。同时，BSTR字符串同样可带有空终结符。基于以上原因，在程序设计的时候，应当避免使用BSTR字符串。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">内存的误用</h4>
<p>于COM中的BSTR类型和C风格的字符串类型（指向'\0'结尾的字符数组的指针）是两种结构不同的数据类型，将这两种类型进行相互转换、误用，虽然在某些情况下，能够通过编译，但在实际运行中，会造成未知结果，甚至造成内存的误用。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">缓解与预防</h1>
<p>只能通过'=='或'!='来比较两个BSTR对象。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="n">BSTR</span> <span class="n">b1</span><span class="p">,</span> <span class="n">BSTR</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&gt;</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span> 
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在第2行代码中，直接使用'&gt;'比较两个BSTR对象。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="n">BSTR</span> <span class="n">b1</span><span class="p">,</span> <span class="n">BSTR</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">b1</span> <span class="o">==</span> <span class="n">b2</span><span class="p">)</span> <span class="p">{</span> 
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在第2行代码中，使用'=='来比较两个BSTR对象。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0123">可能错误的指针缩放</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>指针指向的位置不为数组中的元素的起始位置。</p>
<h1 id="_2">漏洞与风险</h1>
<p>错误的指针缩放可能导致程序功能错误或缓冲区溢出。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>低</p>
<h1 id="_4">缓解与预防</h1>
<p>正确地使用指针缩放。</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">example_fun</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="c1">//指针"p+3"指向的位置不为整型数组a的元素起始位置</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">3</span><span class="p">));</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">example_fun</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">4</span><span class="p">));</span>  
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-hangbiao">
<p>SJ/T 11682-2017 6.7.2 <a class="footnote-backref" href="#fnref-hangbiao" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0055">错误的指针减法操作</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">意料之外的结果</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>如果两个指针指向同一个数组，它们就可以相减，其结果为两个指针之间的元素数目。
如果两个指针不是指向同一个数组，它们相减就没有意义了，甚至产生错误的结果。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">意料之外的结果</h4>
<p>如果两个指针不是指向同一个数组，它们相减就没有意义了，甚至产生错误的结果。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>低</p>
<h1 id="_5">缓解与预防</h1>
<p>只对指向同一个数组的指针进行减法操作。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
  <span class="c1">// expected-warning{{Subtraction of two pointers that do not point to the same </span>
  <span class="c1">// memory chunk may cause incorrect result}}</span>
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">y</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，&amp;y 和 &amp;x 分别指向不同的对象，不能做减法操作。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">q</span><span class="o">-</span><span class="n">p</span><span class="p">;</span> <span class="c1">// no-warning</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，q 和 p 都指向同一个数组a，可以进行减法操作。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0001">空指针解引用</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">服务下线程序崩溃</a></li>
<li><a href="#_4">任意代码执行</a></li>
</ul>
</li>
<li><a href="#_5">漏洞利用威胁</a></li>
<li><a href="#_6">缓解与预防</a></li>
<li><a href="#_7">演示实例</a><ul>
<li><a href="#1">漏洞代码示例 1</a></li>
<li><a href="#1_1">漏洞代码修复示例 1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
<li><a href="#2_1">漏洞代码修复示例 2</a></li>
<li><a href="#3">漏洞代码示例 3</a></li>
<li><a href="#3_1">漏洞代码修复示例 3</a></li>
</ul>
</li>
<li><a href="#_8">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>尝试使用空指针访问数据将导致运行时错误。当程序解引用某个预期为有效但结果为空值的指针，就会发生空指针解引用。发生空指针解引用缺陷通常是由于无效的错误处理或竞争条件，一般情况会导致程序异常中止。在 C/C++ 代码中对指针解引用之前，必须对其进行检查以确认它不为空值。</p>
<p>空指针解引用检查器查找那些对空指针或可能为空的指针进行解引用的实例。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">服务下线程序崩溃</h4>
<p>除非实现了有效的异常处理，否则空指针解引用通常会导致服务程序失败退出。即使处理了异常，让程序回复正常状态也是非常困难的。</p>
<h4 id="_4">任意代码执行</h4>
<p>少数情况下空指针解引用会触发任意代码执行漏洞。</p>
<h1 id="_5">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_6">缓解与预防</h1>
<p>要避免该漏洞，你应该：</p>
<ul>
<li>对所有将返回值的函数进行空值检查</li>
<li>确保所有外部输入都经过验证</li>
<li>明确地对变量进行初始化</li>
<li>确保对不同寻常的异常进行正确处理</li>
</ul>
<h1 id="_7">演示实例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">reassign</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">goodEnough</span><span class="p">(</span><span class="n">argument</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
  <span class="o">*</span><span class="n">argument</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">npd_check_call_must</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">reassign</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>虽然在第 8 行对 *p 进行了空值检查，它在之后被传递到函数 reassign，而在此，根据第 11 行的条件语句的结果，可能在不进行空值检查的情况下就对其解引用。该类型漏洞会产生无法预料的意外结果。</p>
<h3 id="1_1">漏洞代码修复示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">reassign</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">goodEnough</span><span class="p">(</span><span class="n">argument</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
  <span class="o">*</span><span class="n">argument</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">npd_check_call_must</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">argument</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">reassign</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在经修复的代码版本中，在第 11 行加入了另一次空值检查。</p>
<h3 id="2">漏洞代码示例 2</h3>
<p>在这个例子里程序从用户那里获取一个IP地址，验证它的合法性并查询它的主机名，保存在缓存区中。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">host_lookup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_addr</span><span class="p">){</span>
  <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
  <span class="n">in_addr_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">in_addr_t</span> <span class="n">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>

  <span class="c1">// routine that ensures user_supplied_addr is in the right format for conversion </span>
  <span class="n">validate_addr_form</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyaddr</span><span class="p">(</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">),</span> <span class="n">AF_INET</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>如果IP地址看起来是正常的，但是没能获取主机名，那么gethostbyaddr()这个调用就会返回NULL。
由于这段代码没有检验gethostbyaddr的返回值，因此在11行调用strcpy的时候就会引发空指针解引用。</p>
<h3 id="2_1">漏洞代码修复示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">host_lookup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user_supplied_addr</span><span class="p">){</span>
  <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">hp</span><span class="p">;</span>
  <span class="n">in_addr_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="n">in_addr_t</span> <span class="n">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">);</span>

  <span class="c1">// routine that ensures user_supplied_addr is in the right format for conversion </span>
  <span class="n">validate_addr_form</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">user_supplied_addr</span><span class="p">);</span>
  <span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyaddr</span><span class="p">(</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="p">),</span> <span class="n">AF_INET</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">hp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">strcpy</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>修复方式为在11行加入额外的检查逻辑。</p>
<h3 id="3">漏洞代码示例 3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">readConfigFromFile</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">FileReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">))</span> <span class="o">{</span>
      <span class="kt">char</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">config</span> <span class="o">=</span> <span class="n">readConfigFromFile</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="c1">// config might be null. If so, main exits.</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="3_1">漏洞代码修复示例 3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">readConfigFromFile</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">FileReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">))</span> <span class="o">{</span>
      <span class="kt">char</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">config</span> <span class="o">=</span> <span class="n">readConfigFromFile</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">config</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Can't read config from "</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/476.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CERT1">
<p>https://wiki.sei.cmu.edu/confluence/display/c/EXP34-C.+Do+not+dereference+null+pointers <a class="footnote-backref" href="#fnref-CERT1" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CERT2">
<p>https://wiki.sei.cmu.edu/confluence/display/java/EXP00-J.+Do+not+ignore+values+returned+by+methods <a class="footnote-backref" href="#fnref-CERT2" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/dos.html">DoS</a>
                <a href="../../../tag/pointer.html">Pointer</a>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/csharp.html">CSHARP</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0703">使用释放后的内存/内存多重释放</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">描述</a></li>
<li><a href="#_2">风险评估</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">缺陷代码示例 1</a></li>
<li><a href="#1_1">修复代码示例 1</a></li>
<li><a href="#2">缺陷代码示例 2</a></li>
<li><a href="#2_1">修复代码示例 2</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">描述</h1>
<p>使用已释放的内存或重复释放已经被释放的内存，根据缺陷的具体实例化和时序关系，可能导致程序崩溃或任意代码执行等多种不良后果。最常见的情况是系统使用了被释放的内存导致崩溃。使用被释放的内存有两种常见原因：
<em> 对释放的错误判断及其他异常情况；
</em> 程序中哪一部分负责释放内存定义不清；</p>
<p>在这种情况下，被释放的指针在某些时候会处在另一个有效指针的作用范围内。原始的已经被释放的指针再次被使用进行数据更改时，会导致有效的内存数据被破坏，这将在程序中引起不确定的行为。</p>
<p>如果新分配的指针拥有一个对象。例如在C++中，不同的函数指针被分散在堆内存中。如果其中一个函数指针被shellcode的地址覆盖，就会导致任意代码执行漏洞。</p>
<h1 id="_2">风险评估</h1>
<ul>
<li>如果有问题的内存区域在其它地方被正确分配和使用，则使用先前释放的内存可能会破坏其中的有效数据。</li>
<li>如果在内存释放之后发生了数据合并，则无效数据被用作内存块信息时，该过程可能会崩溃。</li>
<li>如果在内存块合并发生前输入了恶意数据，则可能被用来执行任意代码。</li>
</ul>
<h1 id="_3">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>确保内存不再使用后再释放。</li>
<li>在释放一个指针后，将其置为空指针。但是，使用多个或复杂的数据结构可能会降低该策略的实用性。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="1">缺陷代码示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span> <span class="p">(</span><span class="n">SIZE</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abrt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">abrt</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">logError</span><span class="p">(</span><span class="s">"operation aborted before commit"</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span> <span class="c1">// ptr is freed by free(ptr)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="1_1">修复代码示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span> <span class="p">(</span><span class="n">SIZE</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abrt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">abrt</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">logError</span><span class="p">(</span><span class="s">"operation aborted before commit"</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="2">缺陷代码示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad2</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="c1">// double free</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="2_1">修复代码示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good2</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE415">
<p>https://cwe.mitre.org/data/definitions/415.html <a class="footnote-backref" href="#fnref-CWE415" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CWE416">
<p>https://cwe.mitre.org/data/definitions/416.html <a class="footnote-backref" href="#fnref-CWE416" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CERT-MEM30-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/MEM30-C.+Do+not+access+freed+memory <a class="footnote-backref" href="#fnref-CERT-MEM30-C" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn-CERT-MEM50-CPP">
<p>https://wiki.sei.cmu.edu/confluence/display/cplusplus/MEM50-CPP.+Do+not+access+freed+memory <a class="footnote-backref" href="#fnref-CERT-MEM50-CPP" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0704">使用未初始化变量</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">描述</a></li>
<li><a href="#_2">风险评估</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">缺陷代码示例</a></li>
<li><a href="#_7">修复代码示例</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">描述</h1>
<p>在一些像C/C++的语言，堆变量和栈变量不会被默认初始化，因此会包含内存中原有的垃圾数据，攻击者有时可以读取或者控制这些数据。</p>
<h1 id="_2">风险评估</h1>
<ul>
<li>使用未初始化变量可能导致DoS攻击，或者控制流被随意修改。</li>
<li>由于未初花变量的值会来源于运行环境，而测试环境和运行环境一般是不一样的，这样可能会发生测试阶段程序运行良好但是一点工业上线就崩溃的情况</li>
<li>使用未初始化的字符串尤其危险，这是因为字符串通常必须以null('\0')结尾，否则，大量内存信息将被泄露或利用。</li>
</ul>
<h1 id="_3">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>使用变量前初始化该变量。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">缺陷代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define NEXT_SZ 100</span>
<span class="kt">void</span> <span class="nf">repaint</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">used_uninitialized_variable</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctl</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>  
    <span class="n">repaint</span><span class="p">(</span><span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">);</span> <span class="c1">// @@bad@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在default case中bN未被初始化，而后用于函数repaint的参数中。</p>
<h3 id="_7">修复代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define NEXT_SZ 100</span>

<span class="kt">void</span> <span class="nf">repaint</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">used_uninitialized_variable</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctl</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">NEXT_SZ</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="n">aN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="n">bN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>  
    <span class="n">repaint</span><span class="p">(</span><span class="n">aN</span><span class="p">,</span> <span class="n">bN</span><span class="p">);</span> <span class="c1">// @@good@@</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>default case中初始化变量bN，而后用于函数repaint的参数中。</p>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CERT">
<p>https://wiki.sei.cmu.edu/confluence/display/cplusplus/EXP53-CPP.+Do+not+read+uninitialized+memory <a class="footnote-backref" href="#fnref-CERT" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/665.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0030">输出流格式化状态改变后没有恢复</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">意料之外的行为</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>标准C++输入输出库函数提供了stream类来实现输入、输出的功能。它包含一个格式化输出数据的能力，不同的数据类型可以转化为一个输出字符串。
例如：
For example:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
</pre></div>
</td></tr></table>
<p>默认情况下，整数i被转化为一个十进制字符串。
在使用iostream库时，一个常见的错误就是修改了输出流格式化状态，但是忘记恢复了。导致后面格式化数据也是按照前面修改的状态生成字符串，导致意料之外的情况发生。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">意料之外的行为</h4>
<p>在使用iostream库时，一个常见的错误就是修改了输出流格式化状态，但是忘记恢复了。导致后面格式化数据也是按照前面修改的状态生成字符串，导致意料之外的情况发生。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>低</p>
<h1 id="_5">缓解与预防</h1>
<p>输出流格式化状态改变后恢复原来的状态。 </p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，使用std::hex修改了输出格式化状态后并没有恢复原来的状态。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">dec</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，使用std::hex修改了输出格式化状态后使用std::dec恢复原来的状态。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1021">不当使用迭代器</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">不当使用迭代器的危险操作</a></li>
</ul>
</li>
<li><a href="#_4">利用的可能性</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">描述</h1>
<p>使用 '&lt;' 比较两个迭代器的大小或者在条件判断中直接使用find()的迭代器作为判断条件。</p>
<h1 id="_2">漏洞与风险</h1>
<h3 id="_3">不当使用迭代器的危险操作</h3>
<p>使用 '&lt;' 比较两个迭代器的大小或者在条件判断中直接使用find()的迭代器作为判断条件都属于不当使用迭代器的危险操作。</p>
<h1 id="_4">利用的可能性</h1>
<p>高</p>
<h1 id="_5">缓解与预防</h1>
<p>比较两个迭代器时建议使用'==',对于返回迭代器的函数不适合转换为bool值进行判断。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">v1</span><span class="o">&lt;</span><span class="n">v2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="c1">//</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，使用 '&lt;' 比较两个迭代器的大小。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">v1</span><span class="o">==</span><span class="n">v2</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，使用 '==' 比较两个迭代器的大小。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1064">内存不完整赋值</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">缓存区大小计算不正确</a></li>
</ul>
</li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">漏洞利用威胁</a></li>
<li><a href="#_6">演示示例</a><ul>
<li><a href="#_7">漏洞缺陷示例</a></li>
<li><a href="#_8">漏洞缺陷修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>不正确地使用memset,memcpy或memmove函数,导致buffer无法被完全赋值。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">缓存区大小计算不正确</h4>
<p>不正确地使用memset,memcpy或memmove函数,会使得buffer的内存地址溢出。</p>
<h1 id="_4">缓解与预防</h1>
<p>正确使用memset,memcpy或memmove函数。</p>
<h1 id="_5">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_6">演示示例</h1>
<h3 id="_7">漏洞缺陷示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span><span class="c1">//detect</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="_8">漏洞缺陷修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1046">复制指针共用内存</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">演示实例</a><ul>
<li><a href="#_5">代码示例</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>复制构造函数复制指针值，导致复制的对象和原对象共用一部分内存，请确定这样是否是可允许的。</p>
<h1 id="_2">漏洞与风险</h1>
<p>指针指向已分配的内存，将被复制到复制构造函数中，而不是分配新的内存，资源与内存因此可能发生冲突。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">演示实例</h1>
<h3 id="_5">代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//使用深拷贝，系统默认的构造函数</span>
<span class="n">String</span><span class="o">::</span><span class="n">String</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*int len = strlen(other.str_)+1;</span>
<span class="cm">    str_ = new char[len];</span>
<span class="cm">    memset(str_,0,len);</span>
<span class="cm">    strcpy(str_, other.str_);*/</span>

    <span class="c1">//以上由AllocAndCopy(char *  str_);代替</span>
    <span class="n">str_</span> <span class="o">=</span> <span class="n">AllocAndCopy</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">str_</span><span class="p">);</span> <span class="c1">//此为深拷贝</span>
<span class="p">}</span>
<span class="kt">char</span><span class="o">*</span> <span class="n">String</span><span class="o">::</span><span class="n">AllocAndCopy</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>以上为深拷贝的代码，应该谨慎使用。</p>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-51cto">
<p>http://blog.51cto.com/liam2199/1175611 <a class="footnote-backref" href="#fnref-51cto" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1002">释放非堆内存</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>程序释放不是由堆分配函数，如<code>malloc()</code>, <code>calloc()</code>, 和<code>realloc()</code>，分配的内存。</p>
<h1 id="_2">漏洞与风险</h1>
<p>程序试图释放非堆内存，有可能导致内存管理数据结构崩坏，从而造成程序崩溃，攻击者还有机会利用它来控制可以操作的内存，从而修改程序的关键变量或代码块。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_4">缓解与预防</h1>
<p>在进行内存释放操作前，要确保它是由堆分配的，并且这部分内存是属于该程序的。</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">record_t</span> <span class="n">bar</span><span class="p">[</span><span class="n">MAX_SIZE</span><span class="p">];</span>
  <span class="cm">/* do something interesting with bar */</span>

  <span class="p">...</span>
  <span class="n">free</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>上例中，<code>bar</code>是由栈自动分配的，当程序尝试释放<code>bar</code>时，操作失败。</p>
<h3 id="_7">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">record_t</span> <span class="o">*</span><span class="n">bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">MAX_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">record_t</span><span class="p">));</span>
  <span class="cm">/* do something interesting with bar */</span>

  <span class="p">...</span>
  <span class="n">free</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>上例中，程序使用<code>malloc()</code>函数动态分配<code>bar</code>的内存地址，所以可以手动释放它。</p>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE590">
<p>https://cwe.mitre.org/data/definitions/590.html <a class="footnote-backref" href="#fnref-CWE590" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CWE761">
<p>https://cwe.mitre.org/data/definitions/761.html <a class="footnote-backref" href="#fnref-CWE761" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CERT">
<p>https://wiki.sei.cmu.edu/confluence/display/c/MEM34-C.+Only+free+memory+allocated+dynamically <a class="footnote-backref" href="#fnref-CERT" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0050">错误的指针运算</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">越界访问内存</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>在C和C++的类型系统中并没有区分"指向单一对象的指针"和"指向数组的指针"。因此，很容易对一个"指向单一对象的指针"执行指针运算。这会导致读取未初始化的内存值或者垃圾数据。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">越界访问内存</h4>
<p>对一个"指向单一对象的指针"执行指针运算。这会导致读取未初始化的内存值或者垃圾数据。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">缓解与预防</h1>
<p>只对"指向数组的指针"执行指针运算。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，<code>p</code>是一个指向单一对象a的指针，在第4行对<code>p</code>执行指针运算时，<code>p</code>最终指向一个未知内存。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，<code>p</code>是一个指向数组a的指针，可以对<code>p</code>执行指针运算。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1062">不正确的内存分配</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">不匹配的内存管理</a></li>
</ul>
</li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">漏洞利用威胁</a></li>
<li><a href="#_6">演示示例</a><ul>
<li><a href="#_7">漏洞缺陷示例</a></li>
<li><a href="#_8">漏洞缺陷修复示例</a></li>
</ul>
</li>
<li><a href="#_9">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>应用程序试图将内存资源返回给系统，但是它调用了一个与最初用于分配该资源的函数不兼容的释放函数，这种缺点通常被描述为不匹配的内存管理例程。（1）内存是在堆栈上(自动地)分配的，但它是使用内存管理例程free()销毁的。（2）内存使用一组内存管理函数显式分配，并使用不同的另一组内存管理函数销毁。例如，内存可以用c++的malloc()来分配，而不是new操作符，然后与delete操作符进行分配。</p>
<h1 id="_2">漏洞与风险</h1>
<h3 id="_3">不匹配的内存管理</h3>
<p>如果内存管理函数是不匹配的，则可能出现代码无法执行，内存损坏或者程序崩溃等问题。</p>
<h1 id="_4">缓解与预防</h1>
<p>分配内存的函数和释放内存的函数要使用匹配的。</p>
<h1 id="_5">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_6">演示示例</h1>
<h3 id="_7">漏洞缺陷示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
<span class="cm">/* do some work with ptr here */</span>
   <span class="p">...</span>
   <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>这个示例在c++中使用new操作符分配一个BarObj对象，但是，程序员使用free()来释放内存，这可能会导致意外的行为。</p>
<h3 id="_8">漏洞缺陷修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
<span class="cm">/* do some work with ptr here */</span>
  <span class="p">...</span>
  <span class="n">delete</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_9">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/762.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1005">将非结构体类型转换为结构体类型</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#_6">漏洞缺陷示例</a></li>
</ul>
</li>
<li><a href="#_7">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>将非结构类型转换为结构类型并访问内部字段会导致内存访问错误或数据损坏。</p>
<h1 id="_2">漏洞与风险</h1>
<p>由于内存访问错误，执行可能会结束。</p>
<h1 id="_3">缓解与预防</h1>
<p>禁止不兼容的类型转换。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">演示示例</h1>
<h3 id="_6">漏洞缺陷示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">foo</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="p">)</span><span class="n">main</span><span class="p">;</span>
  <span class="n">foo</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">foo</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_7">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/588.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/cwe-588.html">CWE-588</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0064">不正确地声明可变长度数组</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">意料之外的结果</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>声明可变长度数组时，数组长度必须满足以下要求：</p>
<ol>
<li>数组长度不能为负数或0。</li>
<li>数组长度必须是一个初始化的值。</li>
<li>数组长度不能为一个污点数据。</li>
</ol>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">意料之外的结果</h4>
<p>声明可变长度数组时，如果不满足以上要求，可能申请的数组与预期不符，产生意料之外的结果。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>低</p>
<h1 id="_5">缓解与预防</h1>
<p>声明可变长度数组时，数组长度必须满足以下要求：</p>
<ol>
<li>数组长度不能为负数或0。</li>
<li>数组长度必须是一个初始化的值。</li>
<li>数组长度不能为一个污点数据。</li>
</ol>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="c1">// expected-warning{{Declared variable-length array (VLA) has zero size}} </span>
  <span class="kt">int</span> <span class="n">vla</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，声明可变长度数组vla时，数组长度x为0。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vla</span><span class="p">[</span><span class="n">x</span><span class="p">];</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，声明可变长度数组vla时，数组长度x不为0。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE4017">构造函数指针内存泄露</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#vulnerable-code-example">Vulnerable code Example</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>构造函数指针内存泄露</p>
<h1 id="_2">漏洞与风险</h1>
<p>构造函数分配了内存，并将指向它的指针存储在对象字段中，但析构函数没有释放该内存。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_4">缓解与预防</h1>
<p>添加释放该字段的析构函数语句。</p>
<h1 id="_5">演示实例</h1>
<h3 id="vulnerable-code-example">Vulnerable code Example</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">class</span> <span class="n">A</span><span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

  <span class="n">A</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">new</span> <span class="kt">char</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">A</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// p指向的內存可能泄漏</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0044">缓冲区溢出</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">缓冲区溢出</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>当程序向一个缓冲区拷贝字符串时，如果源字符串的长度大于目标字符串的长度，会造成缓冲区溢出问题。</p>
<p>C和C++没有提供内置的防护措施来防止在任意内存中访问或覆盖数据，也没有自动检测写入数组的数据是否在数组的边界以内。</p>
<p>缓冲区溢出的后果包括有效的数据被覆盖、任意潜在的恶意代码执行。</p>
<p>以下字符串拷贝函数可能导致缓冲区溢出：</p>
<ul>
<li>strcpy, strcat</li>
<li>wcscpy, wcscat</li>
<li>StrCpy, StrCpyA, StrCpyW, StrCat, StrCatA, StrCatW</li>
<li>OemToChar, OemToCharA, OemToCharW, OemToAnsi, OemToAnsiA, OemToAnsiW</li>
<li>_mbscpy, _mbscat, _tcscat, _tcscpy</li>
<li>lstrcpy, lstrcpyA, lstrcpyW,</li>
<li>lstrcat, lstrcatA, lstrcatW</li>
</ul>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">缓冲区溢出</h4>
<p>缓冲区溢出的后果包括有效的数据被覆盖、任意潜在的恶意代码执行。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_5">缓解与预防</h1>
<p>在执行字符串拷贝函数之前，保证源字符串的长度小于等于目标字符串的长度。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">destination_buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">source_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="c1">//...</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">destination_buffer</span><span class="p">,</span> <span class="n">source_buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在函数strcpy()中，源字符串source_buffer的长度为1024，大于目标字符串destination_buffer的长度256，可能会导致缓冲区溢出。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">destination_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">source_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="c1">//...</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">destination_buffer</span><span class="p">,</span> <span class="n">source_buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在函数strcpy()中，源字符串source_buffer的长度为1024，等于目标字符串destination_buffer的长度1024，不会导致缓冲区溢出。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0701">返回栈地址</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">描述</a></li>
<li><a href="#_2">风险评估</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">缺陷代码示例</a></li>
<li><a href="#1">修复代码示例1：通过动态分配堆内存</a></li>
<li><a href="#2">修复代码示例2：通过使用调用者分配的内存（参数传递）</a></li>
</ul>
</li>
<li><a href="#_7">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">描述</h1>
<p>局部变量被分配在运行栈上，在函数返回时即失效，由于栈内存被释放，因此栈地址将指向无效内存，使用这些内存信息有可能导致使用错误的数据，导致程序崩溃或信息泄露。</p>
<h1 id="_2">风险评估</h1>
<p>DoS: 崩溃／信息泄露</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_4">缓解与预防</h1>
<p>建议使用malloc()函数、new操作符动态获取堆空间地址，或者让函数调用者分配该内存，并通过参数传入。</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">缺陷代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">STR_MAX</span><span class="p">];</span>
  <span class="n">fillInName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="1">修复代码示例1：通过动态分配堆内存</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">STR_MAX</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
  <span class="n">fillInName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="2">修复代码示例2：通过使用调用者分配的内存（参数传递）</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">getName</span><span class="p">(</span><span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="n">STR_MAX</span><span class="p">])</span> <span class="p">{</span>
  <span class="n">fillInName</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_7">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE562">
<p>https://cwe.mitre.org/data/definitions/562.html <a class="footnote-backref" href="#fnref-CWE562" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1057">不正确创建对象</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
</ul>
</div>

            <div>
                <p>Summary：使用malloc函数为类对象申请内存是不安全的</p>

<h1 id="_1">缺陷描述</h1>
<p>使用malloc函数为类对象会不正确地初始化一个资源，当资源被访问或使用时，它可能会使资源处于一个意想不到的状态。当相关联的资源被期望具有某些属性或值时，比如一个变量决定用户是否已被验证，这可能会产生安全问题。</p>
<h1 id="_2">漏洞与风险</h1>
<p>它可能会使资源处于一个意想不到的状态，也可能产生安全问题。</p>
<h1 id="_3">缓解与预防</h1>
<p>建议使用new为类对象申请内存</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0007">错误的内存分配方式</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">内存的误用</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>有些时候，程序员使用 <code>malloc(a)+b</code> 或 <code>malloc(a)-b</code> 的方式来申请内存，其实他们的真实想法是调用 <code>malloc(a+b)</code> 或 <code>malloc(a-b)</code>来申请内存。这样的笔误会导致分配过少或过多内存，当执行拷贝数据到这样分配的内存块时，会造成内存写入错误。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">内存的误用</h4>
<p>使用 <code>malloc(a)+b</code> 或 <code>malloc(a)-b</code> 的方式来申请内存，会导致分配过少或过多内存，当执行拷贝数据到这样分配的内存块时，会造成内存写入错误。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">缓解与预防</h1>
<p>正确地使用内存分配函数，减少错误的发生。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>  
  <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，*p1 和 *p2 都使用了错误的内存分配方式。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span> 
  <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，*p1 和 *p2 都使用了正确的内存分配方式。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0072">解引用非法迭代器</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">未定义的行为</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>对容器的迭代器进行解引用时，当迭代器指向容器的end()或者rend()，都将产生未定义行为。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">未定义的行为</h4>
<p>对容器的迭代器进行解引用时，当迭代器指向容器的end()或者rend()，都将产生未定义行为。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">缓解与预防</h1>
<p>保证解引用迭代器时，迭代器指向合法区间内。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="o">*</span><span class="n">i</span><span class="p">;</span> <span class="c1">// expected-warning{{Iterator accessed past its end}}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，解引用指向容器end()的迭代器i。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">i</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="o">*</span><span class="n">i</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，保证解引用迭代器时，迭代器指向合法区间内。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0166">不匹配的内存申请和释放</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">漏洞代码示例1</a></li>
<li><a href="#1_1">漏洞代码修复示例1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
<li><a href="#2_1">漏洞代码修复示例 2</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>这种缺陷通常可以描述为不匹配地使用内存管理函数，例如:</p>
<ul>
<li>内存是在栈上自动分配的，但是使用内存管理函数free()(CWE-590)进行了释放，该函数专门用于显式分配的堆内存；</li>
<li>使用一组内存管理函数进行显示内存分配，但使用另一组函数进行释放。例如C++中用malloc来取代new，但是之后使用delete释放。</li>
</ul>
<p>当使用不匹配的内存分配和释放功能时，后果可能与错误代码执行、内存损坏或程序崩溃一样严重。该缺陷的后果和被利用的容易程度与使用的内存管理功能的实现和被管理的内存对象有关。</p>
<h1 id="_2">漏洞与风险</h1>
<p>可能的后果包括内存损坏、拒绝服务攻击、程序崩溃/退出/重启、任意代码执行漏洞。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_4">缓解与预防</h1>
<p>使用配套的内存管理函数</p>
<h1 id="_5">演示实例</h1>
<h3 id="1">漏洞代码示例1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
  <span class="cm">/* do some work with ptr here */</span>

  <span class="p">...</span>

  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>上例中使用new分配一个新的BarObj对象，但是释放改对象使用了free函数，这将导致不确定的代码行为</p>
<h3 id="1_1">漏洞代码修复示例1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">foo</span><span class="p">(){</span>
  <span class="n">BarObj</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BarObj</span><span class="p">()</span>
  <span class="cm">/* do some work with ptr here */</span>

  <span class="p">...</span>

  <span class="n">delete</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>相对的修复代码中，程序员使用了一组内存管理函数中的分配功能，同时使用了对应的释放功能</p>
<h3 id="2">漏洞代码示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">class</span> <span class="n">A</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">};</span>
<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">foo</span><span class="p">(){</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
  <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="p">...</span>
  <span class="n">delete</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>上例中，程序没有使用匹配的函数如malloc/free，new/delete，new[]/delete[]用于分配和释放资源</p>
<h3 id="2_1">漏洞代码修复示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">class</span> <span class="n">A</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">};</span>
<span class="kt">void</span> <span class="n">A</span><span class="o">::</span><span class="n">foo</span><span class="p">(){</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
  <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="p">...</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>相对的，使用匹配的函数来申请释放内存</p>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>https://cwe.mitre.org/data/definitions/762.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1060">迭代器边界检查</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>循环中，没有检查迭代器自增的边界条件。</p>
<h1 id="_2">漏洞与风险</h1>
<p>迭代器自增的边界条件不明确会导致程序进入死循环或者直接导致程序崩溃。</p>
<h1 id="_3">缓解与预防</h1>
<p>添加迭代器自增边界条件的检查项</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0029">局部变量占栈空间太大</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">软件或系统崩溃</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>一个局部变量在栈上所能申请的最大空间，默认为1024字节。特殊的应用领域例如内核或设备驱动模块，需要有严格的栈空间限制，在这些应用领域中，超出栈空间最大限制会造成严重问题，例如软件或者系统崩溃。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">软件或系统崩溃</h4>
<p>特殊的应用领域例如内核或设备驱动模块，需要有严格的栈空间限制，在这些应用领域中，超出栈空间最大限制会造成严重问题，例如软件或者系统崩溃。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>低</p>
<h1 id="_5">缓解与预防</h1>
<p>创建一个局部变量时，该变量在栈上所占用的空间必须小于1024字节。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16384</span><span class="p">];</span> <span class="c1">// Exceeds max single base use of 1024 bytes</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，数组buf占16384个字节，远远超过了所能申请的最大空间1024字节。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，数组buf占128个字节，小于栈上所能申请的最大空间1024字节。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0010">Delete Void类型指针</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">未定义的行为</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>在大多数的编译器实现中，使用delete操作来释放一个指向void类型的指针相当于在一块已经释放但是没有调用析构函数的内存块中调用free()函数。依照C++标准，这会导致未定义的行为。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">未定义的行为</h4>
<p>删除一个指向void类型的指针相当于在一块已经释放但是没有调用析构函数的内存块中调用free()函数。依照C++标准，这会导致未定义的行为。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_5">缓解与预防</h1>
<p>不要使用delete操作来释放一个指向void类型的指针。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">delete</span> <span class="n">p</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在第2行中使用delete一个指向void类型的指针。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">delete</span> <span class="n">p</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在第2行中使用delete一个指向int类型的指针。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1010">释放使用alloca函数申请的内存</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#_6">漏洞缺陷示例</a></li>
<li><a href="#_7">漏洞缺陷修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>alloca()从程序堆栈分配大小字节。分配的空间在调用函数退出时自动释放。因此，不要将由alloca()返回的指针值作为参数传递给free。</p>
<h1 id="_2">漏洞与风险</h1>
<p>释放使用alloca函数申请的内存可能会造成程序崩溃。</p>
<h1 id="_3">缓解与预防</h1>
<p>禁止释放使用alloca函数申请的内存。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_5">演示示例</h1>
<h3 id="_6">漏洞缺陷示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">bad</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">alloca</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>  <span class="c1">//error</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞缺陷修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">good</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">alloca</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0056">越界访问数组</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">程序崩溃</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#_7">漏洞代码示例</a></li>
<li><a href="#_8">漏洞代码修复示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>当程序访问一个数组中的元素时，如果索引值超出数组的长度，就会访问数组之外的内存，从而导致程序崩溃。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">程序崩溃</h4>
<p>数组越界会导致程序崩溃。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_5">缓解与预防</h1>
<p>访问数组元素之前检测索引值是否超出数组的长度。</p>
<h1 id="_6">演示实例</h1>
<h3 id="_7">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，在第3行中索引值4超出了数组的长度，导致数组越界。</p>
<h3 id="_8">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">good</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在上面的代码中，使用数组长度范围内的索引值。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues.html">质量问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/quality issues/memory and resource misuse.html">内存和资源误用</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0061">资源泄露</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/memory-and-resource-misuse.html">内存和资源误用</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">漏洞代码示例1</a></li>
<li><a href="#1_1">漏洞代码修复示例1</a></li>
<li><a href="#2">漏洞代码示例2</a></li>
<li><a href="#2_1">漏洞代码修复示例2</a></li>
<li><a href="#3">漏洞代码示例3</a></li>
<li><a href="#3_1">漏洞代码修复示例3</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>有限的资源包括内存，文件系统存储，数据库连接池条目和CPU。如果攻击者可以触发这些有限资源的分配，但是资源的数量或大小不受控制，则攻击者可能消耗所有可用资源，导致拒绝服务。这将阻止正常用户访问该软件，并且可能对软件执行环境产生影响。例如，对应用程序的内存耗尽攻击可能会降低应用程序及其主机操作系统的速度。</p>
<p>至少有三种不同的情况通常会导致资源耗尽：
<em> 缺少分配的资源数量的限制
</em> 在关闭之前，丢失对资源的所有引用
* 处理后不关闭/返还资源</p>
<p>资源耗尽问题通常由一下问题导致：
<em> 错误条件和其他异常情况。
</em> 对程序的哪一部分负责释放资源感到困惑。</p>
<h1 id="_2">漏洞与风险</h1>
<ul>
<li>资源耗尽的最常见结果是拒绝服务。该软件可能会变慢，由于未处理的错误而崩溃或将合法用户锁定</li>
<li>在某些情况下，资源耗尽会导致软件“打开失败”。 软件的状态以及安全功能可能会被损坏。</li>
</ul>
<h1 id="_3">漏洞利用威胁</h1>
<p>高</p>
<h1 id="_4">缓解与预防</h1>
<p>当资源描述符不再被使用时，释放资源。</p>
<h1 id="_5">演示实例</h1>
<h3 id="1">漏洞代码示例1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">bad</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Resource leak</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="1_1">漏洞代码修复示例1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">good</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">){</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="2">漏洞代码示例2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">file_desc_leak</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">some_error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">)</span> <span class="c1">// The resource leak when if case is true.</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="2_1">漏洞代码修复示例2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">file_desc_leak</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">some_error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">some_error</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="3">漏洞代码示例3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">FileInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"test"</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>在上述代码中，“inputStream”实例在分配、执行之后并没有被关闭。</p>
<h3 id="3_1">漏洞代码修复示例3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">FileInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"test"</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">inputStream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>在finally块中，“inputStream”被关闭。</p>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CERT-FIO42-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/FIO42-C.+Close+files+when+they+are+no+longer+needed <a class="footnote-backref" href="#fnref-CERT-FIO42-C" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CERT-FIO51-CPP">
<p>https://wiki.sei.cmu.edu/confluence/display/cplusplus/FIO51-CPP.+Close+files+when+they+are+no+longer+needed <a class="footnote-backref" href="#fnref-CERT-FIO51-CPP" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CWE400">
<p>https://cwe.mitre.org/data/definitions/400.html <a class="footnote-backref" href="#fnref-CWE400" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/find-bugs.html">FIND-BUGS</a>
                </p>
            </div>
        </article>

    <footer>
 <p>
  &copy; Pinpoint 2016-Present, Pinpoint 源代码静态缺陷分析系统, 源伞科技有限公司 - 保留所有权利
</p>

<p>
</p>     </footer>
</main>

  <script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Pinpoint Document ",
  "url" : "../../..",
  "image": "",
  "description": "Manual and documents for Sourcebrella Pinpoint"
}
</script> 
<div id="initDiv"
     style="position: fixed; z-index: 1000; background-color: white; top: 0; right: 0; bottom: 0; left: 0; "></div>
<script type="text/javascript">
    window.onload = function () {
        document.getElementsByTagName('body')[0].style.display = "block";
        document.getElementById('initDiv').style.display = 'none';

        document.querySelectorAll('.global_lang li a').forEach(elm => {
            elm.addEventListener('click', (e) => {
                var lang = e.target.getAttribute('language-link');
                var abs_url = '/' + lang + '/';
                var reg = /\/(en|zh)\//;
                var newRef;
                var location = window.location;
                if (reg.test(location.href)) {
                    newRef = location.href.replace(reg, abs_url);
                } else {
                    var match = /\/(output|docs)\//.exec(window.location.href);
                    if (match) {
                        newRef = window.location.href.replace(match[0], '/' + match[1] + abs_url)
                    } else {
                        return;
                    }
                }
                window.open(newRef, '_self')
            })
        })
    };

</script>
</body>

</html>